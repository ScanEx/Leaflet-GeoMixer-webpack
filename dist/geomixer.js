!function(e){function t(i){if(r[i])return r[i].exports;var n=r[i]={exports:{},id:i,loaded:!1};return e[i].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";r(1),r(2),r(3),r(4),r(5),r(6);var i=r(7);r(8),r(12),r(13),r(14),r(15),r(11),r(10);var n=r(16);r(17);var o=r(9);r(18),r(20),r(21),r(19),r(22),r(23),r(24),r(25),r(26),r(27),r(28),r(29),r(30),r(31),r(32),r(33),r(34),r(35),r(36),r(37),L.gmx=L.gmx||{},L.gmx.gmxMapManager=i.gmxMapManager,L.gmx.observer=function(e){return new n.Observer(e)},L.gmx.DataManager=o.DataManager},function(e,t){"use strict";!function(){var e=/\[(.+?)\]/g,t=/(floor\()/g,r={functionFromExpression:function(r){return new Function("props","indexes","return "+r.replace(e,'props[indexes["$1"]]').replace(t,"Math.$1")+";")}},i=function(e,t){return{head:e,tail:t}},n=function(e,t){return i(e,t)},o=function(e,t){return i(e,t)},a=new o(-1,null),s=function(e){return e.head===-1},l=function(e,t){return new o(e.head+t,e.tail)},u=function(e){var t=e.length;return function(r,i){return r.substr(i.head,t)===e?l(i,t):a}},h=function(e){var t=e.length;return e=e.toLowerCase(),function(r,i){return r.substr(i.head,t).toLowerCase()===e?l(i,t):a}},c=function(e,t){var r=e.charCodeAt(0),i=t.charCodeAt(0);return function(e,t){var n=e.charCodeAt(t.head);return n>=r&&n<=i?l(t,1):a}},d=function(e){return function(t,r){return t.length>r.head&&s(e(t,r))?l(r,1):a}},m=function(e){return function(t,r){for(var i=0;i<e.length;i++)if(r=e[i](t,r),s(r))return a;return r}},f=function(e){return function(t,r){for(var i=0;i<e.length;i++){var n=e[i](t,r);if(!s(n))return n}return a}},g=function(e,t){return t},p=function(e){return f([e,g])},v=function(e,t){return function(r,i){for(var n=0;;){var o=t(r,i);if(s(o))return n>=e?i:a;n+=1,i=o}}},y=function(e,t,r){var i=m([t,v(e-1,m([r,t]))]);return e>0?i:f([i,g])},x=v(0,f([u(" "),u("\t"),u("\n")])),_=function(e,t,r){return y(e,t,m([x,r,x]))},b=function(e){for(var t=[],r=0;r<e.length;r++)t.length>0&&t.push(x),t.push(e[r]);return m(t)},P=function(e){return function(t,r){var i=e(t,r);return s(i)?a:new o(i.head,new n(t.substr(r.head,i.head-r.head),i.tail))}},I=function(e,t){return function(r,i){var l=i,u=e(r,new o(l.head,null));return s(u)?a:new o(u.head,new n(t(u.tail),l.tail))}},S=P(v(1,f([c("a","z"),c("A","Z"),c("а","я"),c("А","Я"),c("0","9"),u("_")]))),T=P(v(1,f([c("a","z"),c("A","Z"),c("а","я"),c("А","Я"),c("0","9"),u("_"),u(" ")]))),M=f([S,m([u('"'),T,u('"')]),m([u("`"),T,u("`")])]),k=m([u("'"),P(v(0,d(u("'")))),u("'")]),C=v(1,c("0","9")),D=P(m([p(u("-")),C,p(m([u("."),C]))])),A=f([D,k]),O=function(e,t){return t(e,new o(0,null))},w=I(b([M,P(f([u("=="),u("!="),u("<>"),u("<="),u(">="),u("="),u("<"),u(">"),h("LIKE")])),f([A,M])]),function(e){var t=e.tail.tail.head,r=e.tail.head,i=e.head,n=null;return"LIKE"===r.toUpperCase()&&(n=function(e){var t=null;return(t=function(r,n){var o=i.charAt(r),a=e.charAt(n);return""===o?""===a:"%"===o?t(r+1,n)||""!==a&&t(r,n+1):o===a&&t(r+1,n+1)})(0,0)}),function(e,o,a){var s=e[o[t]],l=i;if(i in o&&(l=e[o[l]]),"date"===a[t]&&"string"==typeof l&&(l=L.gmxUtil.getUnixTimeFromStr(l)),"boolean"==typeof s&&"string"==typeof l&&(s=s?"True":"False"),null===s)return!1;if(null!==n)return n(s);if("="===r||"=="===r)return s==l;if("!="===r||"<>"===r)return s!=l;var u,h;return i in o||"string"!=typeof l||O(l,D).head!==l.length?(u=s,h=l,"<"===r?u<h:">"===r?u>h:"<="===r?u<=h:">="===r&&u>=h):(u=parseFloat(s),h=parseFloat(l),"<"===r?u<h:">"===r?u>h:"<="===r?u<=h:">="===r&&u>=h)}}),F=I(b([M,h("IN"),u("("),_(0,A,u(",")),u(")")]),function(e){for(var t=e;null!=t.tail;)t=t.tail;var r=t.head;return function(t,i){var n=t[i[r]];if(null==n)return!1;for(var o=e;null!==o.tail;){if(o.head===n)return!0;o=o.tail}return!1}}),R=function(e,t){return R(e,t)},N=function(e,t){return N(e,t)},E=I(b([h("NOT"),R]),function(e){var t=e.head;return function(e,r,i){return!t(e,r,i)}});R=f([E,w,F,b([u("("),N,u(")")])]);var G=I(_(2,R,h("AND")),function(e){return function(t,r,i){for(var n=!0,o=e;null!=o;)n=n&&o.head(t,r,i),o=o.tail;return n}}),z=I(_(2,R,h("OR")),function(e){return function(t,r,i){for(var n=!1,o=e;null!=o;)n=n||o.head(t,r,i),o=o.tail;return n}});N=f([G,z,R]);var B=m([x,N,x]);r.parseSQL=function(e){var t=O(e,B);return t.head===e.length?t.tail.head:O(e,x).head===e.length?function(){return!0}:null};var U=function(e,t){return U(e,t)},j=function(e,t){return j(e,t)};U=I(_(1,j,P(f([u("+"),u("-")]))),function(e){return function(t,r,i){for(var n=e,o=0;null!==n;){if(o+=n.head(t,r,i),null===n.tail)return o;"-"===n.tail.head&&(o=-o),n=n.tail.tail}return o}});var H=f([I(D,function(e){return function(){return parseFloat(e.head)}}),I(m([u("floor("),U,u(")")]),function(e){return function(t,r,i){var n=e.head(t,r,i);return Math.floor(n)}}),I(m([u("["),S,u("]")]),function(e){return function(t,r){return parseFloat(t[r[e.head]])}}),b([u("("),U,u(")")])]);H=f([H,I(b([u("-"),H]),function(e){return function(t,r,i){return-e.head(t,r,i)}})]),j=I(_(1,H,P(f([u("*"),u("/")]))),function(e){return function(t,r,i){for(var n=e,o=1;null!==n;){if(o*=n.head(t,r,i),null===n.tail)return o;"/"===n.tail.head&&(o=1/o),n=n.tail.tail}return o}}),H=f([H,I(b([u("-"),H]),function(e){return function(t,r,i){return-e.head(t,r,i)}})]);var V=m([x,U,x]);r.parseExpression=function(e){var t=O(e,V);return t.head===e.length?t.tail.head:null};var q=I(v(0,f([D,u(","),u("M"),u("C"),v(1,f([u(" "),u("\t"),u("\r"),u("\n")]))])),function(e){for(var t=[];null!==e;)t.push(parseFloat(e.head)),e=e.tail;return t.reverse(),t});r.parseSVGPath=function(e){var t=O(e,q);return t.head===e.length?t.tail.head:[]},L.gmx=L.gmx||{},L.gmx.Parsers=r}()},function(e,t){"use strict";var r=function e(t){var r,i=[],n=[],o=!1,a=!1,s=!1,l=!1,u=this._fulfill=function(e){if(!o){var t=e?i:n;r=[].slice.call(arguments,1),o=!0,a=e,t.forEach(function(e){e.apply(null,r)}),i=n=[]}};this.resolve=function(){l||u.apply(null,[!0].concat([].slice.call(arguments)))},this.reject=function(){l||u.apply(null,[!1].concat([].slice.call(arguments)))};var h=this.cancel=function(){l||o||(l=!0,t&&t())},c=this.then=function(t,s){if(l)return null;var u=null,c=new e(function(){h(),u&&u.cancel()}),d=function(t,r){return function(){if(t){var i=t.apply(null,arguments);i instanceof e?(u=i,i.then(c.resolve,c.reject)):c.resolve(i)}else c._fulfill.apply(null,[r].concat([].slice.call(arguments)))}};return o?d(a?t:s,a).apply(null,r):(i.push(d(t,!0)),n.push(d(s,!1))),c};this.once=function(e){s||(s=!0,c(e))},this.always=function(e){c(e,e)},this.getFulfilledData=function(){return r}};r.all=function(){var e=[].slice.apply(arguments),t=new r,i=e.length,n=new Array(e.length);return i?e.forEach(function(e,r){e.then(function(e){n[r]=e,i--,0===i&&t.resolve.apply(t,n)},function(){t.reject()})}):t.resolve(),t},L.gmx=L.gmx||{},L.gmx.Deferred=r},function(e,t){"use strict";!function(){var e=function(e,t,r){this._id=e,this.def=new L.gmx.Deferred(L.gmx.imageLoader._cancelRequest.bind(L.gmx.imageLoader,this)),this.remove=L.gmx.imageLoader._removeRequestFromCache.bind(L.gmx.imageLoader,this),this.url=t,this.options=r||{}},t=L.Class.extend({includes:L.Mixin.Events,statics:{MAX_COUNT:20},initialize:function(){this.curCount=0,this.requests=[],this.inProgress={},this.requestsCache={},this.uniqueID=0},_resolveRequest:function(e,t,r){var i=e.def;if(t){if(!r&&e.options.cache){var n=e.url,o=this.requestsCache[n],a=e._id;o||(o=this.requestsCache[n]={image:t,requests:{}}),o.requests[a]||(o.requests[a]=e)}i.resolve(t)}else r||i.reject();this.fire("requestdone",{request:e})},_imageLoaded:function(e,t,r){if(e in this.inProgress){var i=function(e){this._resolveRequest(e,t,r)};this.inProgress[e].requests.forEach(i.bind(this)),--this.curCount,delete this.inProgress[e]}L.gmxUtil.loaderStatus(e,!0),this.fire("imageloaded",{url:e}),this._nextLoad()},_nextLoad:function(){if(!(this.curCount>=t.MAX_COUNT)&&this.requests.length){var e=this.requests.shift(),r=e.url;if(r in this.inProgress)this.inProgress[r].requests.push(e);else{var i=[e];this.inProgress[r]={requests:i},++this.curCount;for(var n=this.requests.length-1;n>=0;n--)this.requests[n].url===r&&(i.push(this.requests[n]),this.requests.splice(n,1));var o=this._loadImage(e);o.width||L.gmxUtil.loaderStatus(r),this.inProgress[r]&&(this.inProgress[r].image=o)}}},_loadImage:function(e){var t=new Image,r=e.url,i=this;return e.options.crossOrigin&&(t.crossOrigin=e.options.crossOrigin),t.onload=this._imageLoaded.bind(this,r,t,!1),t.onerror=function(){i._imageLoaded(r)},t.src=r,this.fire("imageloadstart",{url:r}),t},_cancelRequest:function(e){var t,r=e._id,i=e.url,n=0;if(i in this.inProgress){var o=this.inProgress[i],a=o.requests;if(t=a.length,1===t&&a[0]._id===r)o.image.onload=L.Util.falseFn,o.image.onerror=L.Util.falseFn,o.image.src=L.Util.emptyImageUrl,this._imageLoaded(i,null,!0);else for(n=0;n<t;n++)if(a[n]._id===r){a.splice(n,1);break}}else for(n=0,t=this.requests.length;n<t;n++)if(this.requests[n]._id===r){this.requests.splice(n,1);break}this.fire("requestdone",{request:e})},_removeRequestFromCache:function(e){this._cancelRequest(e),this._clearCacheItem(e.url,e._id)},_clearCacheItem:function(e,t){if(this.requestsCache[e]){var r=this.requestsCache[e];delete r.requests[t],0===Object.keys(r.requests).length&&delete this.requestsCache[e]}},_add:function(t,r,i){var n="id"+ ++this.uniqueID,o=new e(n,r,i);return r in this.inProgress?this.inProgress[r].requests.push(o):(t?this.requests.unshift(o):this.requests.push(o),this._nextLoad()),this.fire("request",{request:o}),o},push:function(e,t){return this._add(!1,e,t)},unshift:function(e,t){return this._add(!0,e,t)}});L.gmx.imageLoader=new t}()},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i={lastMapId:0,newId:function(){return i.lastMapId+=1,"_"+i.lastMapId},uniqueGlobalName:function(e){var t=i.newId();return window[t]=e,t},isPageHidden:function(){return document.hidden||document.msHidden||document.webkitHidden||document.mozHidden||!1},normalizeHostname:function(e){var t=L.gmxUtil.parseUri(("http"!==e.substr(0,4)?"http://":"")+e);return e=t.host+t.directory,"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),e},getLayerItemFromServer:function(e){var t=e.query?e.query:"["+e.field+"]="+e.value,r={WrapStyle:"func",geometry:!0,layer:e.layerID,query:t};return e.border&&(r.border=e.border),i.requestJSONP(e.url||(window.serverBase||"http://maps.kosmosnimki.ru/")+"VectorLayer/Search.ashx",r,e)},getCadastreFeatures:function(e){if(e.latlng){var t=e.latlng,r={WrapStyle:"func",text:(t.lat+" "+t.lng).replace(/\./g,","),tolerance:e.tolerance||0};return i.requestJSONP(e.url||"http://pkk5.rosreestr.ru/api/features/",r,e)}return null},getFormData:function(e){var t=[];for(var i in e){var n=e[i];t.push(i+"="+("object"===("undefined"==typeof n?"undefined":r(n))?JSON.stringify(n):n))}return t.join("&")},requestJSONP:function(e,t,r){r=r||{};var n=new L.gmx.Deferred,o=document.createElement("script");o.setAttribute("charset","UTF-8");var a="callbackParamName"in r?r.callbackParamName:"CallbackName",s=L.extend({},t,L.gmx.gmxMapManager.syncParams);if(a){var l=i.uniqueGlobalName(function(e){delete window[l],n.resolve(e,r)});s[a]=l}var u=[];for(var h in s)u.push(h+"="+encodeURIComponent(s[h]));var c=e+(e.indexOf("?")===-1?"?":"&")+u.join("&");return o.onerror=function(e){n.reject(e),L.gmxUtil.loaderStatus(c,!0),o.parentNode.removeChild(o)},o.onload=function(){L.gmxUtil.loaderStatus(c,!0),o.parentNode.removeChild(o)},L.gmxUtil.loaderStatus(c,null,"vector"),o.setAttribute("src",c),document.getElementsByTagName("head").item(0).appendChild(o),n},getXmlHttp:function(){var e;if("undefined"!=typeof XMLHttpRequest)e=new XMLHttpRequest;else try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){e=!1}}return e},request:function(e){var t=i.getXmlHttp();if(t){if(t.open(e.type?e.type:"GET",e.url,e.async||!1),e.headers)for(var r in e.headers)t.setRequestHeader(r,e.headers[r]);var n=L.gmxUtil.loaderStatus();e.async&&(e.withCredentials&&(t.withCredentials=!0),t.onreadystatechange=function(){4===t.readyState&&(L.gmxUtil.loaderStatus(n,!0),200===t.status?(e.callback(t.responseText),t=null):e.onError&&e.onError(t))});var o=null;if(e.params){o=e.params;var a=L.gmx.gmxMapManager.getSyncParams(!0);a&&(o+="&"+a)}return t.send(o),!(!e.async&&200===t.status)||(e.callback(t.responseText),L.gmxUtil.loaderStatus(n,!0),t.status)}return e.onError&&e.onError({Error:"bad XMLHttpRequest!"}),!1},tileSizes:[],getTileNumFromLeaflet:function(e,t){"z"in e&&(t=e.z);var r=Math.pow(2,t),i=e.x%r+(e.x<0?r:0),n=e.y%r+(e.y<0?r:0);return{z:t,x:i%r-r/2,y:r/2-1-n%r}},getTilePosZoomDelta:function(e,t,r){var i=Math.pow(2,t-r),n=256/i,o=e.x%i,a=e.y%i;return{size:n,zDelta:i,x:n*(o<0?i+o:o),y:n*(a<0?-(1+e.y)%i:i-1-a)}},geoItemBounds:function(e){if(!e)return{bounds:null,boundsArr:[]};var t=e.type,r=e.coordinates,n=null,o=0,a=0,s=null,l=[];if("MULTIPOLYGON"===t||"MultiPolygon"===t)for(s=i.bounds(),o=0,a=r.length;o<a;o++){for(var u=[],h=0,c=r[o].length;h<c;h++)n=i.bounds(r[o][h]),u.push(n),0===h&&s.extendBounds(n);l.push(u)}else if("POLYGON"===t||"Polygon"===t)for(s=i.bounds(),o=0,a=r.length;o<a;o++)n=i.bounds(r[o]),l.push(n),0===o&&s.extendBounds(n);else if("POINT"===t||"Point"===t)s=i.bounds([r]);else if("MULTIPOINT"===t||"MultiPoint"===t)for(s=i.bounds(),o=0,a=r.length;o<a;o++)n=i.bounds([r[o]]),s.extendBounds(n);else if("LINESTRING"===t||"LineString"===t)s=i.bounds(r);else if("MULTILINESTRING"===t||"MultiLineString"===t)for(s=i.bounds(),o=0,a=r.length;o<a;o++)n=i.bounds(r[o]),s.extendBounds(n);return{bounds:s,boundsArr:l}},getUnFlattenGeo:function(e){var t=e.type,r=t.indexOf("POLYGON")!==-1||t.indexOf("Polygon")!==-1,n=e.coordinates,o=n;if(r){o=[];var a="POLYGON"===t||"Polygon"===t;a&&(n=[n]);for(var s=0,l=n.length;s<l;s++){for(var u=[],h=0,c=n[s].length;h<c;h++)u[h]=i.unFlattenRing(n[s][h]);o.push(u)}a&&(o=o[0])}return{type:t,coordinates:o}},unFlattenRing:function(e){if("number"!=typeof e[0])return e;for(var t=e.length,r=0,i=new Array(t/2),n=0;n<t;n+=2)i[r++]=[e[n],e[n+1]];return i},geoFlatten:function(e){var t=e.type,r=t.indexOf("POLYGON")!==-1||t.indexOf("Polygon")!==-1,n="POLYGON"===t||"Polygon"===t,o=e.coordinates;if(r){n&&(o=[o]);for(var a=0,s=o.length;a<s;a++)for(var l=0,u=o[a].length;l<u;l++)o[a][l]=i.flattenRing(o[a][l])}},flattenRing:function(e){for(var t=e.length,r=0,i="function"==typeof Float64Array?Float64Array:Array,n=new i(2*t),o=0;o<t;o++)n[r++]=e[o][0],n[r++]=e[o][1];return n},isRectangle:function(e){return e&&e[0]&&(5===e[0].length||4===e[0].length)&&(e[0][0][0]===e[0][1][0]||e[0][0][1]===e[0][1][1])&&(e[0][1][0]===e[0][2][0]||e[0][1][1]===e[0][2][1])&&(e[0][2][0]===e[0][3][0]||e[0][2][1]===e[0][3][1])&&(e[0][3][0]===e[0][0][0]||e[0][3][1]===e[0][0][1])},getGeometryBounds:function(e){var t=i.geoItemBounds(e);return t.bounds},getMarkerPolygon:function(e,t,r){var i=(e.min.x+e.max.x)/2,n=(e.min.y+e.max.y)/2;return[[i-t,n-r],[i-t,n+r],[i+t,n+r],[i+t,n-r],[i-t,n-r]]},getQuicklookPointsFromProperties:function(e,t){var r=t.tileAttributeIndexes,n={x1:i.getPropItem(t.quicklookX1||("x1"in r?"x1":"X1"),e,r)||0,y1:i.getPropItem(t.quicklookY1||("y1"in r?"y1":"Y1"),e,r)||0,x2:i.getPropItem(t.quicklookX2||("x2"in r?"x2":"X2"),e,r)||0,y2:i.getPropItem(t.quicklookY2||("y2"in r?"y2":"Y2"),e,r)||0,x3:i.getPropItem(t.quicklookX3||("x3"in r?"x3":"X3"),e,r)||0,y3:i.getPropItem(t.quicklookY3||("y3"in r?"y3":"Y3"),e,r)||0,x4:i.getPropItem(t.quicklookX4||("x4"in r?"x4":"X4"),e,r)||0,y4:i.getPropItem(t.quicklookY4||("y4"in r?"y4":"Y4"),e,r)||0},o=i.bounds([[n.x1,n.y1],[n.x2,n.y2],[n.x3,n.y3],[n.x4,n.y4]]);if(o.max.x===o.min.x||o.max.y===o.min.y)return null;if(!t.quicklookPlatform){var a=L.Projection.Mercator.project(L.latLng(n.y1,n.x1));n.x1=a.x,n.y1=a.y,a=L.Projection.Mercator.project(L.latLng(n.y2,n.x2)),n.x2=a.x,n.y2=a.y,a=L.Projection.Mercator.project(L.latLng(n.y3,n.x3)),n.x3=a.x,n.y3=a.y,a=L.Projection.Mercator.project(L.latLng(n.y4,n.x4)),n.x4=a.x,n.y4=a.y}return n},getPropertiesHash:function(e,t){var r={};for(var i in t)r[i]=e[t[i]];return r},getPropItem:function(e,t,r){return e in r?t[r[e]]:""},dec2rgba:function(e,t){var r=e>>16&255,i=e>>8&255,n=255&e;return"rgba("+r+", "+i+", "+n+", "+t+")"},dec2hex:function(e){return(e+16777216).toString(16).substr(-6)},dec2color:function(e,t){return t<1?this.dec2rgba(e,t):"#"+this.dec2hex(e)},oneDay:86400,isTileKeysIntersects:function(e,t){if(e.z<t.z){var r=e;e=t,t=r}var i=e.z-t.z;return e.x>>i===t.x&&e.y>>i===t.y},rotatePoints:function(e,t,r,i){var n=[];t*=Math.PI/180;var o=Math.sin(t),a=Math.cos(t);r||(r=1);for(var s=0;s<e.length;s++){var l=r*e[s].x-i.x,u=r*e[s].y-i.y;n.push({x:a*l-o*u+i.x,y:o*l+a*u+i.y})}return n},getPatternIcon:function(e,t,r){if(!t.fillPattern)return null;var n=!0,o=t.fillPattern,a=e?e.properties:null,s=o.step>0?o.step:0,l={minWidth:1,maxWidth:1e3,minStep:0,maxStep:1e3};o.patternStepFunction&&null!==a&&(s=o.patternStepFunction(a,r),n=!1),s>l.maxStep?s=l.maxStep:s<l.minStep&&(s=l.minStep);var u=o.width>0?o.width:8;o.patternWidthFunction&&null!==a&&(u=o.patternWidthFunction(a,r),n=!1),u>l.maxWidth?u=l.maxWidth:u<l.minWidth&&(u=l.minWidth);var h=t.fillOpacity;t.opacityFunction&&null!==a&&(h=t.opacityFunction(a,r)/100,n=!1);var c=[16711680,65280,255],d=null!=o.colors?o.colors:c,m=d.length,f=[],g=0;for(g=0;g<m;g++){var p=d[g];o.patternColorsFunction&&null!==o.patternColorsFunction[g]&&(p=null!==a?o.patternColorsFunction[g](a,r):c[g%3],n=!1),f.push(p)}0===m&&(f=[0],h=0,m=1);var v=u+s,y=v*m,x=0,_=0,L=y,b=y,P=o.style||"horizontal",I=!1;if("diagonal1"===P||"diagonal2"===P||"cross"===P||"cross1"===P?I=!0:"circle"===P?(b=L=2*v,x=Math.floor(b/2),_=2*Math.PI/m):"vertical"===P?L=1:"horizontal"===P&&(b=1),b*L>l.maxWidth)return console.log({func:"getPatternIcon",Error:"MAX_PATTERN_SIZE",alert:"Bitmap from pattern is too big"}),null;var S=document.createElement("canvas");S.width=b,S.height=L;var T=S.getContext("2d");for(T.clearRect(0,0,S.width,S.height),"diagonal2"!==P&&"vertical"!==P||(T.translate(b,0),T.rotate(Math.PI/2)),g=0;g<m;g++){T.beginPath();var M=i.dec2color(f[g],h);if(T.fillStyle=M,I){var k=g*v,C=k+u;T.moveTo(k,0),T.lineTo(C,0),T.lineTo(0,C),T.lineTo(0,k),T.lineTo(k,0),k+=y,C=k+u,T.moveTo(k,0),T.lineTo(C,0),T.lineTo(0,C),T.lineTo(0,k),T.lineTo(k,0),"cross"!==P&&"cross1"!==P||(k=g*v,C=k+u,T.moveTo(b,k),T.lineTo(b,C),T.lineTo(b-C,0),T.lineTo(b-k,0),T.lineTo(b,k),k+=y,C=k+u,T.moveTo(b,k),T.lineTo(b,C),T.lineTo(b-C,0),T.lineTo(b-k,0),T.lineTo(b,k))}else"circle"===P?(T.arc(x,x,u,g*_,(g+1)*_),T.lineTo(x,x)):T.fillRect(0,g*v,b,u);T.closePath(),T.fill()}var D=document.createElement("canvas");D.width=b,D.height=L;var A=D.getContext("2d");return A.drawImage(S,0,0,b,L),{notFunc:n,canvas:D}},getSVGIcon:function(e){var t='<svg xmlns="'+L.Path.SVG_NS+'" xmlns:xlink="http://www.w3.org/1999/xlink"',r=e.type,i=e.fillStyle||"rgba(255, 255, 255, 0.5)",n=e.strokeStyle||"#0000ff",o=e.lineWidth||2,a={className:"gmx-svg-icon"};e.className&&(a.className=e.className);var s=e.iconSize;if(a.iconSize=[s,s],t+=' height = "'+s+'px"  width = "'+s+'px">',"circle"===r){if(e.fillRadialGradient){t+='<defs><radialGradient id="myRadialGradient4" spreadMethod="pad">';for(var l=e.fillRadialGradient.colorStop||e.fillRadialGradient.addColorStop||[[0,"#ffff00",.8],[1,"#ff0000",.8]],u=0,h=l.length;u<h;u++){var c=l[u];t+='<stop offset="'+100*c[0]+'%"   stop-color="'+c[1]+'" stop-opacity="'+c[2]+'"/>'}t+="</radialGradient></defs>",i="url(#myRadialGradient4)",n=o=null}s/=2,t+='<g><circle cx="'+s+'" cy="'+s+'" r="'+s+'" style="',i&&(t+=" fill:"+i+";"),n&&(t+=' stroke:"'+n+";"),o&&(t+=' stroke-width:"'+o+";"),t+=';" />'}else"square"===r&&(t+='<g><rect width="'+s+'" height="'+s+'" style="',i&&(t+=" fill:"+i+";"),n&&(t+=" stroke:"+n+";"),o&&(t+=" stroke-width:"+2*o+";"),t+='" />');if(e.text){var d=e.text;t+='<text x="50%" y="50%" dy="0.4em"';for(var m in d)"count"!==m&&(t+=" "+m+'="'+d[m]+'"');t+=">"+d.count+"</text>"}return t+="</g></svg>",a.html=t,new L.DivIcon(a)},toPixels:function(e,t,r,i){var n=e[0]*i;n=.5+n<<0;var o=e[1]*i;return o=.5+o<<0,[n-t,r-o].concat(e.slice(2))},getPixelPoint:function(e,t){var r=e.gmx,n=r.mInPixel,o=e.item,a=o.currentStyle||o.parsedStyleKeys||{},s=e.style||{},l=a.iconScale||1,u=a.iconCenter||!1,h=a.sx||s.sx||4,c=a.sy||s.sy||4,d=a.weight||s.weight||0,m=a.iconAnchor||s.iconAnchor||null,f=e.tpx,g=e.tpy;!u&&m&&(v-=m[0],p-=m[1]),h*=l,c*=l,h+=d,c+=d;var p=g-t[1]*n,v=t[0]*n-f;return v-h>256?v=(t[0]-2*i.worldWidthMerc)*n-f:v<-h&&(v=(t[0]+2*i.worldWidthMerc)*n-f),p-c>256||v-h>256||v+h<0||p+c<0?null:{sx:h,sy:c,px1:.5+v<<0,py1:.5+p<<0}},getImageData:function(e){if(L.gmxUtil.isIE9||L.gmxUtil.isIE10)return null;var t=document.createElement("canvas"),r=e.width,i=e.height;t.width=r,t.height=i;var n=t.getContext("2d");return n.drawImage(e,0,0),n.getImageData(0,0,r,i).data},DEFAULT_REPLACEMENT_COLOR:16711935,isIE:function(e){return e===i.getIEversion()},gtIE:function(e){return e<i.getIEversion()},getIEversion:function(){var e=navigator.userAgent||"",t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);var r=e.indexOf("Trident/");if(r>0){var i=e.indexOf("rv:");return parseInt(e.substring(i+3,e.indexOf(".",i)),10)}var n=e.indexOf("Edge/");return n>0?parseInt(e.substring(n+5,e.indexOf(".",n)),10):-1},replaceColor:function(e,t,r){if(L.gmxUtil.isIE9||L.gmxUtil.isIE10)return e;var i=document.createElement("canvas"),n=e.width,o=e.height;i.width=n,i.height=o;var a,s=!1,l=i.getContext("2d");if("string"==typeof t&&(t=parseInt("0x"+t.replace(/#/,""))),t!==this.DEFAULT_REPLACEMENT_COLOR){var u=t>>16&255,h=t>>8&255,c=255&t;r?a=l.createImageData(n,o):(l.drawImage(e,0,0),a=l.getImageData(0,0,n,o),r=a.data);for(var d=a.data,m=0,f=r.length;m<f;m+=4)255!==r[m]&&238!==r[m]||0!==r[m+1]||255!==r[m+2]||(d[m]=u,d[m+1]=h,d[m+2]=c,d[m+3]=r[m+3],s=!0)}return s?l.putImageData(a,0,0):l.drawImage(e,0,0),i},drawIconPath:function(e,t){if(L.Util.isArray(e)&&!(e.length<3)&&t.ctx){var r=!1,n=t.ctx,o=t.radian;(t.px||t.py)&&(n.translate(t.px||0,t.py||0),r=!0),!o&&t.rotateRes&&(o=Math.PI+i.degRad(t.rotateRes)),o&&(n.rotate(o),r=!0),n.moveTo(e[0],e[1]);for(var a=2,s=e.length;a<s;a+=2)n.lineTo(e[a],e[a+1]);r&&n.setTransform(1,0,0,1,0,0)}},pointToCanvas:function(e){var t=e.gmx,r=e.pointAttr,n=e.style||{},o=e.item,a=o.currentStyle||o.parsedStyleKeys,s=a.iconScale||1,l=a.image,u=r.sx,h=r.sy,c=r.px1,d=r.py1,m=c,f=d,g=e.ctx;if("image"===a.type&&(u=n.sx,h=n.sy,l=n.image),a.iconCenter?(m-=u/2,f-=h/2):"circle"===n.type&&(c+=u/2,d+=h/2),a.iconPath&&(e.px=c,e.py=d,e.rotateRes=a.rotate||0),l)"iconColor"in a&&(l=this.replaceColor(l,a.iconColor,e.imageData)),n.rotateRes=a.rotate||0,"opacity"in n&&(g.globalAlpha=a.opacity||n.opacity),t.transformFlag?(g.setTransform(t.mInPixel,0,0,t.mInPixel,-e.tpx,e.tpy),g.drawImage(l,c,-d,u,h),g.setTransform(t.mInPixel,0,0,-t.mInPixel,-e.tpx,e.tpy)):(1!==s&&(u*=s,h*=s,c=r.px1,d=r.py1,m=c,f=d,a.iconCenter&&(m-=u/2,f-=h/2)),n.rotateRes?(g.translate(c,d),g.rotate(i.degRad(n.rotateRes)),g.translate(-c,-d),g.drawImage(l,m,f,u,h),g.setTransform(1,0,0,1,0,0)):g.drawImage(l,m,f,u,h)),"opacity"in n&&(g.globalAlpha=1);else if(n.fillColor||a.fillRadialGradient){if(g.beginPath(),a.iconPath)i.drawIconPath(a.iconPath,e);else if("circle"===n.type||a.fillRadialGradient){var p=n.iconSize/2;if(a.fillRadialGradient){var v=a.fillRadialGradient;p=v.r2*s;for(var y=g.createRadialGradient(c+v.x1,d+v.y1,v.r1*s,c+v.x2,d+v.y2,p),x=0,_=v.addColorStop.length;x<_;x++){var L=v.addColorStop[x];y.addColorStop(L[0],L[1])}g.fillStyle=y}g.arc(c,d,p,0,2*Math.PI)}else g.fillRect(m,f,u,h);g.fill()}a.strokeStyle&&(g.beginPath(),a.iconPath?i.drawIconPath(a.iconPath,e):"circle"===n.type?g.arc(c,d,n.iconSize/2,0,2*Math.PI):g.strokeRect(m,f,u,h),g.stroke())},lineToCanvasAsIcon:function(e,t){var r=e.length,n=t.ctx,o=t.item,a=o.currentStyle||o.parsedStyleKeys,s=a.iconPath;if(r>0){"getLineDash"in n&&n.getLineDash().length>0&&n.setLineDash([]),n.beginPath();for(var l,u=0;u<r;u++)l=e[u],i.drawIconPath(s,{ctx:n,px:l.x,py:l.y,radian:l.radian});a.strokeStyle&&n.stroke(),a.fillStyle&&n.fill()}},lineToCanvas:function(e){var t=e.gmx,r=e.coords,n=e.ctx,o=e.item,a=o.currentStyle||o.parsedStyleKeys,s=a.iconPath?[]:null,l=null,u=null;n.beginPath();for(var h=0,c=r.length;h<c;h++){var d=i.toPixels(r[h],e.tpx,e.tpy,t.mInPixel),m=d[0],f=d[1];l===m&&u===f||(s&&s.push({x:m,y:f,radian:d[2]}),0===h?n.moveTo(m,f):n.lineTo(m,f),l=m,u=f)}return n.stroke(),s},getCoordsPixels:function(e){for(var t=e.gmx,r=e.coords,n=e.hiddenLines||[],o=[],a=[],s=!1,l={gmx:t,tpx:e.tpx,tpy:e.tpy,coords:null,hiddenLines:null},u=0,h=r.length;u<h;u++){for(var c=r[u],d=n[u]||[],m=[],f=[],g=0,p=c.length;g<p;g++){l.coords=c[g],l.hiddenLines=d[g]||[];var v=i.getRingPixels(l);m.push(v.coords),f.push(v.hidden),v.hidden&&(s=!0)}o.push(m),a.push(f)}return{coords:o,hidden:s?a:null,z:t.currentZoom}},getRingPixels:function(e){if(0===e.coords.length)return null;for(var t=e.gmx,r=t.mInPixel,i=e.coords,n=e.hiddenLines||null,o=e.tpx,a=e.tpy,s=0,l=0,u=null,h=null,c="number"==typeof i[0]?2:1,d=[],m=[],f=0,g=i.length;f<g;f+=c){var p=!1;n&&f===n[l]&&(p=!0,l++);var v=1===c?i[f]:[i[f],i[f+1]],y=v[0]*r,x=v[1]*r,_=Math.round(y-o),L=Math.round(a-x);u===_&&h===L||(u=_,h=L,p&&m.push(s),d[s++]=y,d[s++]=x)}return{coords:d,hidden:m.length?m:null}},polygonToCanvas:function(e){if(0===e.coords.length)return null;var t=e.hiddenLines||null,r=e.coords,i=e.ctx,n=e.tpx,o=e.tpy,a=0,s=0,l="number"==typeof r[0]?2:1,u=null,h=null;i.beginPath();for(var c=0,d=r.length;c<d;c+=l){var m=1===l?r[c]:[r[c],r[c+1]],f=Math.round(m[0]-n),g=Math.round(o-m[1]),p=!1;t&&c===t[s]&&(p=!0,s++),u===f&&h===g||(i[p?"moveTo":"lineTo"](f,g),u=f,h=g,a++)}1===a&&i.lineTo(u+1,h),i.stroke()},polygonToCanvasFill:function(e){if(!(e.coords.length<3)){var t=e.coords,r=e.tpx,i=e.tpy,n=1,o=e.ctx;o.lineWidth=0,"number"==typeof t[0]?(n=2,o.moveTo(Math.round(t[0]-r),Math.round(i-t[1]))):o.moveTo(Math.round(t[0][0]-r),Math.round(i-t[0][1]));for(var a=n,s=t.length;a<s;a+=n){var l=1===n?t[a]:[t[a],t[a+1]];o.lineTo(Math.round(l[0]-r),Math.round(i-l[1]))}}},isPatternNode:function(e){return e instanceof HTMLCanvasElement||e instanceof HTMLImageElement},labelCanvasContext:null,getLabelWidth:function(e,t){if(t){if(!i.labelCanvasContext){var r=document.createElement("canvas");r.width=r.height=512,i.labelCanvasContext=r.getContext("2d")}var n=i.labelCanvasContext;n.clearRect(0,0,512,512),n.font!==t.font&&(n.font=t.font),n.fillStyle!==t.fillStyle&&(n.fillStyle=t.fillStyle);var o=e.split("\n");return o.map(function(e){return n.fillText(e,0,0),[e,n.measureText(e).width]})}return 0},setLabel:function(e,t,r,i){var n=r[0],o=r[1];e.shadowColor!==i.strokeStyle&&(e.shadowColor=i.strokeStyle),e.shadowBlur!==i.shadowBlur&&(e.shadowBlur=i.shadowBlur),e.font!==i.font&&(e.font=i.font),e.strokeStyle!==i.strokeStyle&&(e.strokeStyle=i.strokeStyle),e.fillStyle!==i.fillStyle&&(e.fillStyle=i.fillStyle),e.strokeText(t,n,o),e.fillText(t,n,o)},worldWidthMerc:20037508,rMajor:6378137,degRad:function(e){return e*(Math.PI/180)},distVincenty:function(e,t,r,n){for(var o={lon:i.degRad(e),lat:i.degRad(t)},a={lon:i.degRad(r),lat:i.degRad(n)},s=i.rMajor,l=6356752.3142,u=1/298.257223563,h=a.lon-o.lon,c=Math.atan((1-u)*Math.tan(o.lat)),d=Math.atan((1-u)*Math.tan(a.lat)),m=Math.sin(c),f=Math.cos(c),g=Math.sin(d),p=Math.cos(d),v=h,y=2*Math.PI,x=20;Math.abs(v-y)>1e-12&&--x>0;){var _=Math.sin(v),L=Math.cos(v),b=Math.sqrt(p*_*(p*_)+(f*g-m*p*L)*(f*g-m*p*L));if(0===b)return 0;var P=m*g+f*p*L,I=Math.atan2(b,P),S=f*p*_/b,T=1-S*S,M=P-2*m*g/T;isNaN(M)&&(M=0);var k=u/16*T*(4+u*(4-3*T));y=v,v=h+(1-k)*u*S*(I+k*b*(M+k*P*(-1+2*M*M)))}if(0===x)return NaN;var C=T*(s*s/(l*l)-1),D=1+C/16384*(4096+C*(-768+C*(320-175*C))),A=C/1024*(256+C*(-128+C*(74-47*C))),O=A*b*(M+A/4*(P*(-1+2*M*M)-A/6*M*(-3+4*b*b)*(-3+4*M*M))),w=l*D*(I-O);return w},_vfi:function(e,t,r){return[-Math.cos(e)*Math.sin(t)+Math.sin(e)*Math.sin(r)*Math.cos(t),Math.cos(e)*Math.cos(t)+Math.sin(e)*Math.sin(r)*Math.sin(t),-Math.sin(e)*Math.cos(r)]},getCircleLatLngs:function(e,t){var r=0,n=0;if(e instanceof L.LatLng)r=e.lng,n=e.lat;else{if(!L.Util.isArray(e))return null;r=e[1],n=e[0]}for(var o=Math.PI/180,a=r*o,s=n*o,l=i.rMajor,u=l*Math.sin(t/l),h=l*Math.cos(t/l),c=[h*Math.cos(s)*Math.cos(a),h*Math.cos(s)*Math.sin(a),h*Math.sin(s)],d=[],m=0,f=2*Math.PI+1e-6;m<f;m+=o){for(var g=i._vfi(m,a,s),p=[],v=0;v<3;v++)p[v]=c[v]+u*g[v];var y=Math.acos(p[0]/Math.sqrt(p[0]*p[0]+p[1]*p[1]))/o;p[1]<0&&(y=-y),y<r-180?y+=360:y>r+180&&(y-=360),d.push([Math.asin(p[2]/l)/o,y])}return d},parseCoordinates:function(e){var t=null,r=/\(EPSG:(\d+)\)/g,i=r.exec(e);if(i&&(t=i[1],e=e.replace(r,"")),e.match(/[йцукенгшщзхъфывапролджэячсмитьбюЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮqrtyuiopadfghjklzxcvbmQRTYUIOPADFGHJKLZXCVBM_:]/))return null;if(e.indexOf(" ")===-1&&e.indexOf(",")===-1)return null;e.indexOf(" ")!==-1&&(e=e.replace(/,/g,"."));var n=[];for(r=/(-?\d+(\.\d+)?)([^\d\-]*)/g,i=r.exec(e);i;)n.push(i[1]),i=r.exec(e);if(n.length<2)return null;var o,a=Math.floor(n.length/2),s=0,l=1;for(o=0;o<a;o++)s+=parseFloat(n[o])*l,l/=60;var u=0;for(l=1,o=a;o<n.length;o++)u+=parseFloat(n[o])*l,l/=60;Math.max(e.indexOf("N"),e.indexOf("S"))>Math.max(e.indexOf("E"),e.indexOf("W"))&&(i=u,u=s,s=i);var h;return"3857"===t&&(h=L.Projection.SphericalMercator.unproject(new L.Point(s,u)._divideBy(6378137)),u=h.lng,s=h.lat),(Math.abs(u)>180||Math.abs(s)>180)&&(h=L.Projection.Mercator.unproject(new L.Point(s,u)),u=h.lng,s=h.lat),e.indexOf("W")!==-1&&(u=-u),e.indexOf("S")!==-1&&(s=-s),[s,u]},pad2:function(e){return e>=0&&e<10?"0"+e:""+e},trunc:function(e){return(""+(Math.round(1e7*e)/1e7+1e-8)).substring(0,9)},formatDegrees:function(e,t){e=Math.round(1e7*e)/1e7+1e-8;var r=Math.floor(e),n=Math.floor(60*(e-r)),o=i.toPrecision(3600*(e-r-n/60),2),a=i.pad2(r)+"°";return void 0===t&&(t=2),t>0&&(a+=i.pad2(n)+"'"),t>1&&(a+=i.pad2(o)+'"'),a},latLonFormatCoordinates:function(e,t){return e%=360,e>180?e-=360:e<-180&&(e+=360),i.formatDegrees(Math.abs(t))+(t>0?" N, ":" S, ")+i.formatDegrees(Math.abs(e))+(e>0?" E":" W")},formatCoordinates:function(e,t){return i.latLonFormatCoordinates(e,t)},latLonFormatCoordinates2:function(e,t){return i.trunc(Math.abs(t))+(t>0?" N, ":" S, ")+i.trunc(Math.abs(e))+(e>0?" E":" W")},formatCoordinates2:function(e,t){return i.latLonFormatCoordinates2(e,t)},getPixelScale:function(e){return 256/i.tileSizes[e]},forEachPoint:function(e,t){if(!e||0===e.length)return[];var r,n,o=[];if(e[0].length)for(r=0,n=e.length;r<n;r++)"string"!=typeof e[r]&&o.push(i.forEachPoint(e[r],t));else{if(2===e.length)return t(e);for(r=0,n=e.length/2;r<n;r++)o.push(t([e[2*r],e[2*r+1]]))}return o},getItemCenter:function(e,t){var r=e.bounds,n=r.min,o=r.max,a=e.type,s="POINT"===a||"MULTIPOINT"===a,l=s?[n.x,n.y]:[(n.x+o.x)/2,(n.y+o.y)/2];if("MULTIPOLYGON"===a)return l;if("POLYGON"===a)for(var u=0,h=t.length;u<h;u++){var c=t[u],d=c.geo,m=d.coordinates,f=c.dataOption,g=f.bounds;if(g.contains(l)){"POLYGON"===d.type&&(m=[m]);for(var p=0,v=m.length;p<v;p++)for(var y=0,x=m[p],_=x.length;y<_;y++){var L=i.getHSegmentsInPolygon(l[1],x[y]);if(L)return L.max.center}}}else{if("POINT"===a||"MULTIPOINT"===a)return l;if("LINESTRING"===a||"MULTILINESTRING"===a)return l}return null},getHSegmentsInPolygon:function(e,t){var r,i,n,o=[],a=1,s=t[0];"number"==typeof t[0]&&(a=2,s=[t[0],t[1]]);var l=e>s[1];for(r=a,i=t.length;r<i;r+=a){var u=1===a?t[r]:[t[r],t[r+1]],h=e>u[1];l!==h&&o.push(s[0]-(s[0]-u[0])*(s[1]-e)/(s[1]-u[1])),s=u,l=h}if(i=o.length){o=o.sort();var c=0,d=-1;for(r=1;r<i;r+=2){var m=r-1,f=Math.abs(o[r]-o[m]);f>c&&(c=f,d=m)}n={y:e,segArr:o,max:{width:c,center:[(o[d]+o[d+1])/2,e]}}}return n},isPointInPolygonArr:function(e,t){var r=!1,i=e[0],n=e[1],o=1,a=t[0];"number"==typeof t[0]&&(o=2,a=[t[0],t[1]]);for(var s=o,l=t.length;s<l;s+=o){var u=1===o?t[s]:[t[s],t[s+1]],h=Math.min(a[0],u[0]),c=Math.max(a[0],u[0]),d=Math.max(a[1],u[1]);
if(i>h&&i<=c&&n<=d&&a[0]!==u[0]){var m=(i-a[0])*(u[1]-a[1])/(u[0]-a[0])+a[1];(a[1]===u[1]||n<=m)&&(r=!r)}a=u}return r},isPointInPolygonWithHoles:function(e,t){if(!i.isPointInPolygonArr(e,t[0]))return!1;for(var r=1,n=t.length;r<n;r++)if(i.isPointInPolygonArr(e,t[r]))return!1;return!0},isClockwise:function(e){for(var t,r=0,i=0,n=e.length;i<n;i++)t=(i+1)%n,r+=e[i][0]*e[t][1],r-=e[t][0]*e[i][1];return r<0},isPointInPolyLine:function(e,t,r,i){var n=e[0],o=e[1],a={x:n,y:o},s=n-t,l=n+t,u=o-t,h=o+t,c=0;t*=t;for(var d=1,m=r.length;d<m;d++)if(i&&d===i[c])c++;else{var f=r[d-1],g=r[d],p=f[0],v=f[1],y=g[0],x=g[1];if(!(Math.max(p,y)<s||Math.min(p,y)>l||Math.max(v,x)<u||Math.min(v,x)>h)){var _=L.LineUtil._sqClosestPointOnSegment(a,{x:p,y:v},{x:y,y:x},!0);if(_<t)return!0}}return!1},isPointInLines:function(e){for(var t=e.coords,r=e.point,n=e.delta,o=e.boundsArr,a=e.hidden,s=0,l=t.length,u=!1;s<l;s++)if(u=!o[s]||o[s].contains(r),u&&i.isPointInPolyLine(r,n,t[s],a?a[s]:null))return!0;return!1},getLength:function(e,t){var r=0;if(e&&e.length){var n=!1,o=!1;t=void 0===t||t,e.forEach(function(e){if(L.Util.isArray(e)){if(L.Util.isArray(e[0]))return r+=i.getLength(e,t);t&&(e=L.Projection.Mercator.unproject({x:e[0],y:e[1]}))}n!==!1&&o!==!1&&(r+=parseFloat(i.distVincenty(n,o,e.lng,e.lat))),n=e.lng,o=e.lat})}return r},prettifyDistance:function(e,t){var r=" "+L.gmxLocale.getText("units.km");return"nm"===t?Math.round(.539956803*e)/1e3+" "+L.gmxLocale.getText("units.nm"):"km"===t?Math.round(e)/1e3+r:e<2e3||"m"===t?Math.round(e)+" "+L.gmxLocale.getText("units.m"):e<2e5?Math.round(e/10)/100+r:Math.round(e/1e3)+r},geoJSONGetLength:function(e){var t,r,n,o,a,s=0;if("GeometryCollection"===e.type?s+=e.geometries.forEach(i.geoJSONGetLength):"Feature"===e.type?s+=i.geoJSONGetLength(e.geometry):"FeatureCollection"===e.type&&(s+=e.features.forEach(i.geoJSONGetLength)),"LineString"===e.type||"MultiLineString"===e.type)for(a=e.coordinates,"LineString"===e.type&&(a=[a]),t=0,n=a.length;t<n;t++)s+=i.getRingLength(a[t]);if("Polygon"===e.type||"MultiPolygon"===e.type)for(a=e.coordinates,"Polygon"===e.type&&(a=[a]),t=0,n=a.length;t<n;t++)for(r=0,o=a[t].length;r<o;r++)s+=i.getRingLength(a[t][r]);return s},getRingLength:function(e){var t=0;if(e&&e.length){var r=!1,n=!1;e.forEach(function(e){return L.Util.isArray(e)&&e.length>2?t+=i.getRingLength(e):(r!==!1&&n!==!1&&(t+=parseFloat(i.distVincenty(r,n,e[0],e[1]))),r=e[0],void(n=e[1]))})}return t},geoJSONGetArea:function(e){var t=0;if("GeometryCollection"===e.type?t+=e.geometries.forEach(i.geoJSONGetArea):"Feature"===e.type?t+=i.geoJSONGetArea(e.geometry):"FeatureCollection"===e.type&&(t+=e.features.forEach(i.geoJSONGetArea)),"Polygon"===e.type||"MultiPolygon"===e.type){var r=e.coordinates;"Polygon"===e.type&&(r=[r]);for(var n=0,o=r.length;n<o;n++){t+=i.getRingArea(r[n][0]);for(var a=1,s=r[n].length;a<s;a++)t-=i.getRingArea(r[n][a])}}return t},geoJSONGetLatLng:function(e){if("Feature"===e.type)return i.geoJSONGetLatLng(e.geometry);if("Point"===e.type)return L.latLng(e.coordinates[1],e.coordinates[0]);throw new Error("cannot get "+e.type+" latLng")},getRingArea:function(e){for(var t=0,r=0,n=e.length;r<n;r++){var o=r===n-1?0:r+1,a=e[r],s=e[o];t+=a[0]*Math.sin(i.degRad(s[1]))-s[0]*Math.sin(i.degRad(a[1]))}var l=Math.abs(t*i.lambertCoefX*i.lambertCoefY/2);return l},getArea:function(e){for(var t=0,r=0,n=e.length;r<n;r++){var o=r===n-1?0:r+1,a=e[r],s=e[o];t+=a.lng*Math.sin(i.degRad(s.lat))-s.lng*Math.sin(i.degRad(a.lat))}return Math.abs(t*i.lambertCoefX*i.lambertCoefY/2)},prettifyArea:function(e,t){var r=" "+L.gmxLocale.getText("units.km2");return"km2"===t?""+Math.round(e/100)/1e4+r:"ha"===t?""+Math.round(e/100)/100+" "+L.gmxLocale.getText("units.ha"):e<1e5||"m2"===t?Math.round(e)+" "+L.gmxLocale.getText("units.m2"):e<3e6?(""+Math.round(e/1e3)/1e3).replace(".",",")+r:e<3e7?(""+Math.round(e/1e4)/100).replace(".",",")+r:e<3e8?(""+Math.round(e/1e5)/10).replace(".",",")+r:Math.round(e/1e6)+r},geoLength:function(e){var t=0,r=e.type;if("MULTILINESTRING"===r||"MultiLineString"===r){for(var n=0,o=e.coordinates.length;n<o;n++)t+=i.geoLength({type:"LINESTRING",coordinates:e.coordinates[n]});return t}return"LINESTRING"!==r&&"LineString"!==r||(t=i.getLength(e.coordinates)),t},geometryToGeoJSON:function(e,t){if(!e)return null;var r="MULTIPOLYGON"===e.type?"MultiPolygon":"POLYGON"===e.type?"Polygon":"MULTILINESTRING"===e.type?"MultiLineString":"LINESTRING"===e.type?"LineString":"MULTIPOINT"===e.type?"MultiPoint":"POINT"===e.type?"Point":e.type,n=e.coordinates;return t&&(n=i.coordsFromMercator(r,n)),{type:r,coordinates:n}},convertGeometry:function(e,t){var r="MULTIPOLYGON"===e.type?"MultiPolygon":"POLYGON"===e.type?"Polygon":"MULTILINESTRING"===e.type?"MultiLineString":"LINESTRING"===e.type?"LineString":"MULTIPOINT"===e.type?"MultiPoint":"POINT"===e.type?"Point":e.type,n=e.coordinates;return n=t?i.coordsFromMercator(r,n):i.coordsToMercator(r,n),{type:e.type,coordinates:n}},geoJSONtoGeometry:function(e,t){if("FeatureCollection"===e.type)return i.geoJSONtoGeometry(e.features[0],t);if("Feature"===e.type)return i.geoJSONtoGeometry(e.geometry,t);if("FeatureCollection"===e.type)return i.geoJSONtoGeometry(e.features[0],t);var r="MultiPolygon"===e.type?"MULTIPOLYGON":"Polygon"===e.type?"POLYGON":"MultiLineString"===e.type?"MULTILINESTRING":"LineString"===e.type?"LINESTRING":"MultiPoint"===e.type?"MULTIPOINT":"Point"===e.type?"POINT":e.type,n=e.coordinates;return t&&(n=i.coordsToMercator(e.type,n)),{type:r,coordinates:n}},_coordsConvert:function(e,t,r){var n,o,a,s=[];if("Point"===e)r?(a=L.Projection.Mercator.project({lat:t[1],lng:t[0]}),s=[a.x,a.y]):(a=L.Projection.Mercator.unproject({y:t[1],x:t[0]}),s=[a.lng,a.lat]);else if("LineString"===e||"MultiPoint"===e)for(n=0,o=t.length;n<o;n++)s.push(i._coordsConvert("Point",t[n],r));else if("Polygon"===e||"MultiLineString"===e)for(n=0,o=t.length;n<o;n++)s.push(i._coordsConvert("MultiPoint",t[n],r));else if("MultiPolygon"===e)for(n=0,o=t.length;n<o;n++)s.push(i._coordsConvert("Polygon",t[n],r));return s},coordsFromMercator:function(e,t){return i._coordsConvert(e,t,!1)},coordsToMercator:function(e,t){return i._coordsConvert(e,t,!0)},transformGeometry:function(e,t){return e?{type:e.type,coordinates:i.forEachPoint(e.coordinates,function(e){return t(e)})}:e},geoArea:function(e,t){var r,n,o=0,a=e.type||"";if(t=void 0===t||t,"MULTIPOLYGON"===a||"MultiPolygon"===a){for(r=0,n=e.coordinates.length;r<n;r++)o+=i.geoArea({type:"POLYGON",coordinates:e.coordinates[r]},t);return o}if("POLYGON"===a||"Polygon"===a){for(o=i.geoArea(e.coordinates[0],t),r=1,n=e.coordinates.length;r<n;r++)o-=i.geoArea(e.coordinates[r],t);return o}if(e.length){var s=[],l="number"==typeof e[0]?2:1;for(r=0,n=e.length;r<n;r+=l){var u=1===l?e[r]:[e[r],e[r+1]];s.push(t?L.Projection.Mercator.unproject({y:u[1],x:u[0]}):{lat:u[1],lng:u[0]})}return i.getArea(s)}return 0},getGeoJSONSummary:function(e,t){var r,n,o,a=e.type,s=t||{},l=0;if("Point"===a)o=e.coordinates,l=i.formatCoordinates(o[0],o[1]);else if("Polygon"===a)l=i.prettifyArea(i.geoArea(e,!1),s.squareUnit);else if("MultiPolygon"===a){for(o=e.coordinates,r=0,n=o.length;r<n;r++)l+=i.geoArea({type:"Polygon",coordinates:o[r]},!1);l=i.prettifyArea(l,s.squareUnit)}else if("LineString"===a)l=i.prettifyDistance(i.geoJSONGetLength(e),s.distanceUnit);else if("MultiLineString"===a){for(o=e.coordinates,r=0,n=o.length;r<n;r++)l+=i.geoJSONGetLength({type:"LineString",coordinates:o[r]});l=i.prettifyDistance(l,s.distanceUnit)}return l},getCoordinatesString:function(e,t){var r,n=e.lng,o=e.lat,a=["",""," (EPSG:3395)"," (EPSG:3857)"],s=a.length,l="";return t=t||0,n>180&&(n-=360),n<-180&&(n+=360),t%s===0?l=i.formatCoordinates2(n,o):t%s===1?l=i.formatCoordinates(n,o):t%s===2?(r=L.Projection.Mercator.project(new L.LatLng(o,n)),l=""+Math.round(r.x)+", "+Math.round(r.y)+a[2]):(r=L.CRS.EPSG3857.project(new L.LatLng(o,n)),l=""+Math.round(r.x)+", "+Math.round(r.y)+a[3]),l},getGeometriesSummary:function(e,t){var r="",n="",o=0;return t||(t={}),e&&e.forEach(function(e){if(e)if(n=e.type.toUpperCase(),n.indexOf("POINT")!==-1){var a=L.Projection.Mercator.unproject({y:e.coordinates[1],x:e.coordinates[0]});r="<b>"+L.gmxLocale.getText("Coordinates")+"</b>: "+i.getCoordinatesString(a,t.coordinatesFormat)}else n.indexOf("LINESTRING")!==-1?o+=i.geoLength(e):n.indexOf("POLYGON")!==-1&&(o+=i.geoArea(e))}),r||(n.indexOf("LINESTRING")!==-1?r="<b>"+L.gmxLocale.getText("Length")+"</b>: "+i.prettifyDistance(o,t.distanceUnit):n.indexOf("POLYGON")!==-1&&(r="<b>"+L.gmxLocale.getText("Area")+"</b>: "+i.prettifyArea(o,t.squareUnit))),r},getGeometrySummary:function(e,t){return i.getGeometriesSummary([e],t||{})},chkOnEdge:function(e,t,r){return e[0]<r.min.x&&t[0]<r.min.x||e[0]>r.max.x&&t[0]>r.max.x||(e[1]<r.min.y&&t[1]<r.min.y||e[1]>r.max.y&&t[1]>r.max.y)},getHidden:function(e,t){for(var r=[],n="number"==typeof e[0]?2:1,o=null,a=0,s=e.length;a<s;a+=n){var l=1===n?e[a]:[e[a],e[a+1]];o&&i.chkOnEdge(l,o,t)&&r.push(a),o=l}return r},getNormalizeBounds:function(e,t){var r=e.getNorthWest(),n=e.getSouthEast(),o=r.lng,a=n.lng,s=(a-o)/2,l=null,u=null,h=[];if(s>=180)o=-180,a=180;else if(a>180||o<-180){var c=(a+o)/2%360;c>180?c-=360:c<-180&&(c+=360),o=c-s,a=c+s,o<-180?(l=o+360,u=180,o=-180):a>180&&(l=-180,u=a-360,a=180)}var d={x:o,y:n.lat},m={x:a,y:r.lat};if(void 0!==t&&(d=L.Projection.Mercator.project(new L.LatLng([n.lat,o])),m=L.Projection.Mercator.project(new L.LatLng([r.lat,a])),d.y-=t,m.y-=t),h.push(i.bounds([[d.x,d.y],[m.x,m.y]])),l){var f={x:l,y:n.lat},g={x:u,y:r.lat};void 0!==t&&(f=L.Projection.Mercator.project(new L.LatLng([n.lat,l])),g=L.Projection.Mercator.project(new L.LatLng([r.lat,u])),f.y-=t,g.y-=t),h.push(i.bounds([[f.x,f.y],[g.x,g.y]]))}return h},toPrecision:function(e,t){var r=Math.pow(10,t?t:4);return Math.round(r*e)/r},getTileBounds:function(e,t,r){var n=i.tileSizes[r],o=e*n,a=t*n;return i.bounds([[o,a],[o+n,a+n]])},parseTemplate:function(e,t){var r=e.match(/\[([^\]]+)\]/gi);if(r)for(var i=0,n=r.length;i<n;i++){var o=r[i],a=o.substr(1,o.length-2),s=a in t?t[a]:"";e=e.replace(o,s)}return e},getDefaultBalloonTemplate:function(e,t){var r="";for(var i in e)(!t||i in t)&&(r+="<b>"+i+":</b> ["+i+"]<br />");return r+="<br />[SUMMARY]<br />"},parseBalloonTemplate:function(e,t){var r=t.properties;e||(e=i.getDefaultBalloonTemplate(r,t.tileAttributeTypes));var n=e.match(/\[([^\]]+)\]/gi);if(n)for(var o=t.tileAttributeTypes,a=t.unitOptions,s=t.geometries,l=0,u=n.length;l<u;l++){var h=n[l],c=h.substr(1,h.length-2),d="";c in r?d=L.gmxUtil.attrToString(o[c],r[c]):"SUMMARY"===c&&(d=t.summary||L.gmxUtil.getGeometriesSummary(s,a)),e=e.replace(h,d)}return e},styleKeys:{marker:{server:["image","angle","scale","minScale","maxScale","size","circle","center","color"],client:["iconUrl","iconAngle","iconScale","iconMinScale","iconMaxScale","iconSize","iconCircle","iconCenter","iconColor"]},outline:{server:["color","opacity","thickness","dashes"],client:["color","opacity","weight","dashArray"]},fill:{server:["color","opacity","image","pattern","radialGradient","linearGradient"],client:["fillColor","fillOpacity","fillIconUrl","fillPattern","fillRadialGradient","fillLinearGradient"]},label:{server:["text","field","template","color","haloColor","size","spacing","align"],client:["labelText","labelField","labelTemplate","labelColor","labelHaloColor","labelFontSize","labelSpacing","labelAlign"]}},styleFuncKeys:{iconSize:"iconSizeFunction",iconAngle:"rotateFunction",iconScale:"scaleFunction",iconColor:"iconColorFunction",opacity:"opacityFunction",fillOpacity:"fillOpacityFunction",color:"colorFunction",fillColor:"fillColorFunction"},styleFuncError:{iconSize:function(){return 8},iconAngle:function(){return 0},iconScale:function(){return 1},iconColor:function(){return 255},opacity:function(){return 1},fillOpacity:function(){return.5},color:function(){return 255},fillColor:function(){return 255}},defaultStyles:{MinZoom:1,MaxZoom:21,Filter:"",Balloon:"",DisableBalloonOnMouseMove:!0,DisableBalloonOnClick:!1,RenderStyle:{point:{color:255,weight:1,iconSize:8},linestring:{color:255,weight:1},polygon:{color:255,weight:1}}},getDefaultStyle:function(e){var t=i.defaultStyles,r=L.extend({},t);return r.RenderStyle=t.RenderStyle[e],r},toServerStyle:function(e){var t={};for(var r in i.styleKeys)for(var n=i.styleKeys[r],o=0,a=n.client.length;o<a;o++){var s=n.client[o];if(s in e){t[r]||(t[r]={});var l=e[s];"opacity"!==s&&"fillOpacity"!==s||(l*=100),t[r][n.server[o]]=l}}return"iconAnchor"in e&&(t.marker||(t.marker={}),t.marker.dx=-e.iconAnchor[0],t.marker.dy=-e.iconAnchor[1]),t},fromServerStyle:function(e){var t,n,o,a,s={type:""};for(var l in i.styleKeys){var u=i.styleKeys[l];for(n=0,o=u.client.length;n<o;n++)a=u.client[n],a in e&&(s[a]=e[a]);if(t=e[l],t&&"object"===("undefined"==typeof t?"undefined":r(t)))for(n=0,o=u.server.length;n<o;n++)if(a=u.server[n],a in t){var h=u.client[n],c=t[a];if("string"==typeof c){if(i.styleFuncKeys[h])if(null===c.match(/[^\d\.]/))c=Number(c);else{var d=L.gmx.Parsers.parseExpression(c);null===d?c=i.styleFuncError[h]():s[i.styleFuncKeys[h]]=d}}else"opacity"===a&&(c/=100);s[h]=c}}if(e.marker&&(t=e.marker,"dx"in t||"dy"in t)){var m=t.dx||0,f=t.dy||0;s.iconAnchor=[-m,-f]}return s},getUnixTimeFromStr:function(e){var t=L.Util.trim(e).split(" ");return t=t[0].split("."),4===t[2].length&&(t=t.reverse()),Date.UTC(t[0],t[1]-1,t[2])/1e3},getDateFromStr:function(e){var t=L.Util.trim(e).split(" ");t=t[0].split("."),4===t[2].length&&(t=t.reverse());var r=new Date(t[0],t[1]-1,t[2]);return r},getUTCdate:function(e){var t=new Date(1e3*e);return[t.getUTCFullYear(),i.pad2(t.getUTCMonth()+1),i.pad2(t.getUTCDate())].join(".")},getUTCtime:function(e){var t=Math.floor(e/3600),r=Math.floor((e-3600*t)/60),n=Math.floor(e-3600*t-60*r);return[i.pad2(t),i.pad2(r),i.pad2(n)].join(":")},getUTCdateTime:function(e){var t=e%86400;return t?[i.getUTCdate(e),i.getUTCtime(e%86400)].join(" "):i.getUTCdate(e)},attrToString:function(e,t){return"date"===e?t?L.gmxUtil.getUTCdate(t):t:"time"===e?t?L.gmxUtil.getUTCtime(t):t:"datetime"===e&&t?L.gmxUtil.getUTCdateTime(t):t},getTileAttributes:function(e){var t={},r={};if(e.attributes){var i=e.attributes,n=e.attrTypes||null;e.identityField&&(t[e.identityField]=0);for(var o=0;o<i.length;o++){var a=i[o];t[a]=o+1,r[a]=n?n[o]:"string"}}return{tileAttributeTypes:r,tileAttributeIndexes:t}}};i.lambertCoefX=100*i.distVincenty(0,0,.01,0),i.lambertCoefY=100*i.distVincenty(0,0,0,.01)*180/Math.PI,function(){for(var e=0;e<30;e++)i.tileSizes[e]=40075016.685578495/Math.pow(2,e)}(),i.Bounds=function(e){this.min={x:Number.MAX_VALUE,y:Number.MAX_VALUE},this.max={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},this.extendArray(e)},i.Bounds.prototype={extend:function(e,t){return e<this.min.x&&(this.min.x=e),e>this.max.x&&(this.max.x=e),t<this.min.y&&(this.min.y=t),t>this.max.y&&(this.max.y=t),this},extendBounds:function(e){return this.extendArray([[e.min.x,e.min.y],[e.max.x,e.max.y]])},extendArray:function(e){if(!e||!e.length)return this;var t,r;if("number"==typeof e[0])for(t=0,r=e.length;t<r;t+=2)this.extend(e[t],e[t+1]);else for(t=0,r=e.length;t<r;t++)this.extend(e[t][0],e[t][1]);return this},addBuffer:function(e,t,r,i){return this.min.x-=e,this.min.y-=t||e,this.max.x+=r||e,this.max.y+=i||t||e,this},contains:function(e){var t=this.min,r=this.max,i=e[0],n=e[1];return i>=t.x&&i<=r.x&&n>=t.y&&n<=r.y},getCenter:function(){var e=this.min,t=this.max;return[(e.x+t.x)/2,(e.y+t.y)/2]},addOffset:function(e){return this.min.x+=e[0],this.max.x+=e[0],this.min.y+=e[1],this.max.y+=e[1],this},intersects:function(e){var t=this.min,r=this.max,i=e.min,n=e.max;return n.x>t.x&&i.x<r.x&&n.y>t.y&&i.y<r.y},intersectsWithDelta:function(e,t,r){var i=this.min,n=this.max,o=t||0,a=r||0,s=e.min,l=e.max;return l.x+o>i.x&&s.x-o<n.x&&l.y+a>i.y&&s.y-a<n.y},isEqual:function(e){var t=this.min,r=this.max,i=e.min,n=e.max;return n.x===r.x&&i.x===t.x&&n.y===r.y&&i.y===t.y},isNodeIntersect:function(e){for(var t=0,r=e.length;t<r;t++)if(this.contains(e[t]))return{num:t,point:e[t]};return null},clipPolygon:function(e){var t,r,i,n,o=this.min,a=this.max,s=[[o.x,o.y],[a.x,o.y],[a.x,a.y],[o.x,a.y]],l=function(e){return(r[0]-t[0])*(e[1]-t[1])>(r[1]-t[1])*(e[0]-t[0])},u=function(){var e=[t[0]-r[0],t[1]-r[1]],o=[i[0]-n[0],i[1]-n[1]],a=t[0]*r[1]-t[1]*r[0],s=i[0]*n[1]-i[1]*n[0],l=1/(e[0]*o[1]-e[1]*o[0]);return[(a*o[0]-s*e[0])*l,(a*o[1]-s*e[1])*l]},h=e;t=s[3];for(var c=0;c<4;c++){r=s[c];var d=h,m=d.length;h=[],i=d[m-1];for(var f=0;f<m;f++)n=d[f],l(n)?(l(i)||h.push(u()),h.push(n)):l(i)&&h.push(u()),i=n;t=r}return h},clipPolyLine:function(e,t,r){r=r||0;var i,n,o,a,s,l,u=this.min,h=this.max,c=[u.x-r,u.y-r,h.x+r,h.y+r],d=function(e){var t=0;return e[0]<c[0]?t|=1:e[0]>c[2]&&(t|=2),e[1]<c[1]?t|=4:e[1]>c[3]&&(t|=8),t},m=function(e,t){return Math.PI/2+Math.atan2(t[1]-e[1],e[0]-t[0])},f=function(e,t,r){return 8&r?[e[0]+(t[0]-e[0])*(c[3]-e[1])/(t[1]-e[1]),c[3]]:4&r?[e[0]+(t[0]-e[0])*(c[1]-e[1])/(t[1]-e[1]),c[1]]:2&r?[c[2],e[1]+(t[1]-e[1])*(c[2]-e[0])/(t[0]-e[0])]:1&r?[c[0],e[1]+(t[1]-e[1])*(c[0]-e[0])/(t[0]-e[0])]:null},g=[],p=e.length,v=d(e[0],c),y=[];for(i=1;i<p;i++)if(n=e[i-1],o=e[i],n[0]!==o[0]||n[1]!==o[1]){for(s=l=d(o,c);;){if(!(v|s)){t&&(n[2]=m(n,o),a=e[i+1],o[2]=a?m(o,a):n[2]),y.push(n),s!==l?(y.push(o),i<p-1&&(g.push(y),y=[])):i===p-1&&y.push(o);break}if(v&s)break;v?(n=f(n,o,v,c),v=d(n,c)):(o=f(n,o,s,c),s=d(o,c))}v=l}return y.length&&g.push(y),g}},i.bounds=function(e){return new i.Bounds(e)},i.parseUri=function(e){for(var t=i.parseUri.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),n={},o=14;o--;)n[t.key[o]]=r[o]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,function(e,r,i){r&&(n[t.q.name][r]=i)}),n.hostOnly=n.host,n.host=n.authority,n},i.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},L.gmxUtil||(L.gmxUtil={}),L.extend(L.gmxUtil,{newId:i.newId,loaderStatus:function(){},isIE9:i.isIE(9),isIE10:i.isIE(10),isIE11:i.isIE(11),gtIE11:i.gtIE(11),getFormData:i.getFormData,requestJSONP:i.requestJSONP,getCadastreFeatures:i.getCadastreFeatures,request:i.request,getLayerItemFromServer:i.getLayerItemFromServer,fromServerStyle:i.fromServerStyle,toServerStyle:i.toServerStyle,getDefaultStyle:i.getDefaultStyle,bounds:i.bounds,getGeometryBounds:i.getGeometryBounds,tileSizes:i.tileSizes,getDateFromStr:i.getDateFromStr,getUnixTimeFromStr:i.getUnixTimeFromStr,getUTCdate:i.getUTCdate,getUTCtime:i.getUTCtime,getUTCdateTime:i.getUTCdateTime,attrToString:i.attrToString,getTileAttributes:i.getTileAttributes,formatCoordinates:function(e,t){return i["formatCoordinates"+(t?"2":"")](e.lng,e.lat)},formatDegrees:i.formatDegrees,pad2:i.pad2,dec2hex:i.dec2hex,dec2rgba:i.dec2rgba,trunc:i.trunc,latLonFormatCoordinates:i.latLonFormatCoordinates,latLonFormatCoordinates2:i.latLonFormatCoordinates2,getLength:i.getLength,geoLength:i.geoLength,prettifyDistance:i.prettifyDistance,getArea:i.getArea,prettifyArea:i.prettifyArea,geoArea:i.geoArea,parseBalloonTemplate:i.parseBalloonTemplate,getSVGIcon:i.getSVGIcon,getCoordinatesString:i.getCoordinatesString,getGeometriesSummary:i.getGeometriesSummary,getGeometrySummary:i.getGeometrySummary,getGeoJSONSummary:i.getGeoJSONSummary,getPropertiesHash:i.getPropertiesHash,distVincenty:i.distVincenty,parseCoordinates:i.parseCoordinates,geometryToGeoJSON:i.geometryToGeoJSON,convertGeometry:i.convertGeometry,transformGeometry:i.transformGeometry,geoJSONtoGeometry:i.geoJSONtoGeometry,geoJSONGetArea:i.geoJSONGetArea,geoJSONGetLength:i.geoJSONGetLength,geoJSONGetLatLng:i.geoJSONGetLatLng,parseUri:i.parseUri,isRectangle:i.isRectangle,isClockwise:i.isClockwise,isPointInPolygonWithHoles:i.isPointInPolygonWithHoles,getPatternIcon:i.getPatternIcon,getCircleLatLngs:i.getCircleLatLngs,normalizeHostname:i.normalizeHostname,getTileBounds:i.getTileBounds,parseTemplate:i.parseTemplate}),function(){function e(e,n,o){var a="gmxAPIutils_id"+r++,s=L.DomUtil.create("iframe");s.style.display="none",s.setAttribute("id",e),s.setAttribute("name",e),s.src="javascript:true",s.callbackName=a;var l=i.parseUri(o),u=(l.protocol?l.protocol+":":window.location.protocol)+"//"+(l.host||window.location.host);return t[u]=t[u]||{},t[u][a]={callback:n,iframe:s},s}var t={},r=0,n=function(e){if(e.origin in t){var r=decodeURIComponent(e.data.replace(/\n/g,"\n\\"));try{var i=JSON.parse(r)}catch(e){console.log({Status:"error",ErrorInfo:{ErrorMessage:"JSON.parse exeption",ExceptionType:"JSON.parse",StackTrace:r}})}var n=t[e.origin][i.CallbackName];n&&(delete t[e.origin][i.CallbackName],delete i.CallbackName,n.iframe.parentNode&&n.iframe.parentNode.removeChild(n.iframe),"callback"in n&&n.callback(i))}};L.DomEvent.on(window,"message",n),i.createPostIframe2=e}(),function(){function e(e,t,r,n){var o,a,s="$$iframe_"+i.newId(),l=i.createPostIframe2(s,r,e);if(n)o=n,a=o.getAttribute("action"),o.setAttribute("action",e),o.target=s;else if(L.Browser.ielt9){var u="<form id="+s+'" enctype="multipart/form-data" style="display:none" target="'+s+'" action="'+e+'" method="post"></form>';o=document.createElement(u)}else o=document.createElement("form"),o.style.display="none",o.setAttribute("enctype","multipart/form-data"),o.target=s,o.setAttribute("method","POST"),o.setAttribute("action",e),o.id=s;var h=document.createElement("div");h.style.display="none","window"===t.WrapStyle&&(t.WrapStyle="message"),"message"===t.WrapStyle&&(t.CallbackName=l.callbackName);for(var c in t){var d=document.createElement("input"),m="undefined"!=typeof t[c]?t[c]:"";d.setAttribute("type","hidden"),d.setAttribute("name",c),d.setAttribute("value",m),h.appendChild(d)}o.appendChild(h),n||document.body.appendChild(o),document.body.appendChild(l),o.submit(),n?(o.removeChild(h),null!==a?o.setAttribute("action",a):o.removeAttribute("action")):o.parentNode.removeChild(o)}L.gmxUtil.sendCrossDomainPostRequest=i.sendCrossDomainPostRequest=e}(),t.gmxAPIutils=i},function(e,t,r){"use strict";var i=r(4),n=["strokeStyle","fillStyle","lineWidth"],o=n.length,a=function(e,t,r,a){for(var s=0;s<o;s++){var l=n[s],u=a[l];u!==r[l]&&(r[l]=u)}if(a.dashArray){var h=a.dashArray,c=a.dashOffset||0;"setLineDash"in r&&(r.setLineDash(h),r.lineDashOffset!==c&&(r.lineDashOffset=c))}else"getLineDash"in r&&r.getLineDash().length>0&&r.setLineDash([]);if("round"!==r.lineCap&&(r.lineCap="round"),"round"!==r.lineJoin&&(r.lineJoin="round"),a.canvasPattern)r.fillStyle=r.createPattern(a.canvasPattern.canvas,"repeat");else if(a.fillLinearGradient){for(var d=a.fillLinearGradient,m=d.x1Function?d.x1Function(e,t):d.x1,f=d.y1Function?d.y1Function(e,t):d.y1,g=d.x2Function?d.x2Function(e,t):d.x2,p=d.y2Function?d.y2Function(e,t):d.y2,v=r.createLinearGradient(m,f,g,p),y=0,x=d.addColorStop.length;y<x;y++){var _=d.addColorStop[y],L=d.addColorStopFunctions[y],b=L[0]?L[0](e,t):_[0],P=_.length<3?100:L[2]?L[2](e,t):_[2],I=i.gmxAPIutils.dec2color(L[1]?L[1](e,t):_[1],P>1?P/100:P);v.addColorStop(b,I)}r.fillStyle=a.fillStyle=v}};L.gmxUtil.drawGeoItem=function(e,t,r,n,o){var s,l,u,h,c=e.properties,d=c[0],m=r.gmx,f=r.ctx,g=c[c.length-1],p=null,v=e.dataOption,y=r.rasters||{},x=r.tbounds;if(t.currentStyle=L.extend({},n),o){if(m.styleHook){if(e.styleExtend||(e.styleExtend=m.styleHook(t,m.lastHover&&d===m.lastHover.id)),!e.styleExtend)return!1;t.currentStyle=L.extend(t.currentStyle,e.styleExtend)}a(c,m.tileAttributeIndexes,f,t.currentStyle)}else o={};var _=g.type,b={gmx:m,item:t,style:o,styleExtend:e.styleExtend||{},ctx:f,tpx:r.tpx,tpy:r.tpy};if("POINT"===_&&(b.pointAttr=i.gmxAPIutils.getPixelPoint(b,g.coordinates),!b.pointAttr))return!1;if("POINT"===_||"MULTIPOINT"===_)if(p=g.coordinates,"iconColor"in o&&o.image&&(o.lastImage!==o.image&&(o.lastImage=o.image,o.lastImageData=i.gmxAPIutils.getImageData(o.image)),b.imageData=o.lastImageData),"MULTIPOINT"===_)for(s=0,l=p.length;s<l;s++)b.coords=p[s],i.gmxAPIutils.pointToCanvas(b);else b.coords=p,i.gmxAPIutils.pointToCanvas(b);else if("POLYGON"===_||"MULTIPOLYGON"===_)if(o.image)b.coords=[(v.bounds.min.x+v.bounds.max.x)/2,(v.bounds.min.y+v.bounds.max.y)/2],b.pointAttr=i.gmxAPIutils.getPixelPoint(b,b.coords),b.pointAttr&&i.gmxAPIutils.pointToCanvas(b);else{p=g.coordinates,"POLYGON"===_&&(p=[p]);var P=v.hiddenLines||[],I=v.pixels,S=!0;I&&I.z===m.currentZoom||(I=v.pixels=i.gmxAPIutils.getCoordsPixels({gmx:m,coords:p,tpx:r.tpx,tpy:r.tpy,hiddenLines:P}));var T=function(e,t){for(p=I.coords,P=I.hidden||[],b.flagPixels=S,s=0,l=p.length;s<l;s++){var r=p[s],i=P[s]||[];for(f.beginPath(),u=0,h=r.length;u<h;u++)b.coords=r[u],b.hiddenLines=i[u]||[],e(b);f.closePath(),t&&f.fill()}},M=t.currentStyle.strokeStyle||o.strokeStyle,k=t.currentStyle.lineWidth||o.lineWidth;M&&k&&T(i.gmxAPIutils.polygonToCanvas),r.bgImage?b.bgImage=r.bgImage:y[d]&&(b.bgImage=y[d]),(b.styleExtend.skipRasters||t.skipRasters)&&delete b.bgImage,o.imagePattern?t.currentStyle.fillStyle=f.createPattern(o.imagePattern,"repeat"):b.bgImage&&x.intersectsWithDelta(v.bounds,-1,-1)&&(i.gmxAPIutils.isPatternNode(b.bgImage)&&("rasterOpacity"in m&&(f.globalAlpha=m.rasterOpacity),f.fillStyle=f.createPattern(b.bgImage,"no-repeat"),o.bgImage=!0),T(i.gmxAPIutils.polygonToCanvasFill,!0),f.globalAlpha=1),(t.currentStyle.fillStyle||t.currentStyle.canvasPattern)&&(f.fillStyle=t.currentStyle.canvasPattern||t.currentStyle.fillStyle,T(i.gmxAPIutils.polygonToCanvasFill,!0))}else if("LINESTRING"===_||"MULTILINESTRING"===_){p=g.coordinates,"LINESTRING"===_&&(p=[p]);var C=(t.currentStyle.maxSize||t.currentStyle.lineWidth)/m.mInPixel;for(s=0,l=p.length;s<l;s++){var D=x.clipPolyLine(p[s],!0,C);for(u=0,h=D.length;u<h;u++){b.coords=D[u];var A=i.gmxAPIutils.lineToCanvas(b);A&&(f.save(),i.gmxAPIutils.lineToCanvasAsIcon(A,b),f.restore())}}}return!0}},function(e,t){"use strict";var r={APIKEY_PARAM:"key",SCRIPT_REGEXP:[/\bleaflet-geomixer(-\w*)?\.js\b/,/\bgeomixer(-\w*)?\.js\b/],_scriptSearched:!1,_scriptAPIKey:null,_searchScriptAPIKey:function(){var e=this;if(this._scriptSearched)return this._scriptAPIKey;for(var t=document.getElementsByTagName("script"),r=0;r<t.length;r++){for(var i=t[r].getAttribute("src"),n=this.SCRIPT_REGEXP,o=0,a=n.length;o<a;o++)if(n[o].exec(i)){var s=i.split("?")[1];if(s)for(var l=s.split("&"),u=0;u<l.length;u++){var h=l[u].split("=");if(h[0]===e.APIKEY_PARAM){e._scriptAPIKey=h[1];break}}break}if(e._scriptAPIKey)break}return this._scriptSearched=!0,this._scriptAPIKey},requestSessionKey:function(e,t){var r=this._sessionKeys;return e in r||(t="undefined"==typeof t?this._searchScriptAPIKey():t,r[e]=new L.gmx.Deferred,t?gmxAPIutils.requestJSONP("http://"+e+"/ApiKey.ashx",{WrapStyle:"func",Key:t}).then(function(t){t&&"ok"===t.Status?r[e].resolve(t.Result.Key):r[e].reject()},r[e].reject):r[e].resolve("")),r[e]},getSessionKey:function(e){var t=this._sessionKeys[e];return t&&t.getFulfilledData()&&t.getFulfilledData()[0]},_sessionKeys:{}};L.gmx=L.gmx||{},L.gmx.gmxSessionManager=r},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gmxMapManager=void 0;var i=r(4),n={getMap:function(e,t,r,n){var o=this._maps;if(!o[e]||!o[e][r]){var a=new L.gmx.Deferred;o[e]=o[e]||{},o[e][r]={promise:a},L.gmx.gmxSessionManager.requestSessionKey(e,t).then(function(t){i.gmxAPIutils.requestJSONP("http://"+e+"/TileSender.ashx",{WrapStyle:"func",skipTiles:n||"None",key:t,MapName:r,ModeKey:"map"}).then(function(t){t&&"ok"===t.Status&&t.Result?(t.Result.properties.hostName=e,a.resolve(t.Result)):a.reject(t)},a.reject)},a.reject)}return o[e][r].promise},syncParams:{},setSyncParams:function(e){this.syncParams=e},getSyncParams:function(e){var t=this.syncParams;if(e){var r=[];for(var i in t)r.push(i+"="+t[i]);t=r.join("&")}return t},findLayerInfo:function(e,t,r){var i=this._maps[e],o=i&&i[t];if(!o)return null;if(o.layers)return o.layers[r];var a=o.promise.getFulfilledData();return a?(o.layers={},n.iterateLayers(a[0],function(e){o.layers[e.properties.name]=e}),o.layers[r]):null},iterateLayers:function(e,t){var r=function e(r){for(var i=0,n=r.length;i<n;i++){var o=r[i];"group"===o.type?e(o.content.children):"layer"===o.type&&t(o.content)}};e&&r(e.children)},iterateNode:function(e,t){var r=function e(r){for(var i=r.children,n=0,o=i.length;n<o;n++){var a=i[n];t(a),"group"===a.type&&e(a.content)}};e&&r(e)},_maps:{}};t.gmxMapManager=n},function(e,t,r){"use strict";var i=r(9),n=L.Class.extend({includes:L.Mixin.Events,initialize:function(e,t){this.layers=[],this.layersByTitle={},this.layersByID={},this.dataManagers={};var r=this;this.properties=L.extend({},e.properties),this.properties.BaseLayers=this.properties.BaseLayers?JSON.parse(this.properties.BaseLayers):[],this.rawTree=e,this.layersCreated=new L.gmx.Deferred;var n={},o={};L.gmx.gmxMapManager.iterateLayers(e,function(i){var a=i.properties,s=a.MetaProperties||{},l={mapID:e.properties.name,layerID:a.name};a.hostName=e.properties.hostName;var u=a.ContentID||a.type,h=L.extend(l,t);a.dataSource||"parentLayer"in s?(h.parentLayer=a.dataSource||"","parentLayer"in s&&(h.parentLayer=s.parentLayer.Value||""),o[l.layerID]={info:i,options:h}):u in L.gmx._layerClasses?r.addLayer(L.gmx.createLayer(i,h)):(n[u]=n[u]||[],n[u].push({info:i,options:h}))});var a=[];for(var s in n)a.push(L.gmx._loadLayerClass(s).then(function(e){for(var t=n[e],i=0,o=t.length;i<o;i++)r.addLayer(L.gmx.createLayer(t[i].info,t[i].options))}.bind(null,s)));var l,u,h,c={};for(u in o){h=o[u];var d=h.options,m=d.parentLayer,f=this.layersByID[m];f?(h.options.parentOptions=f.getGmxProperties(),h.options.dataManager=this.dataManagers[m]||new i.DataManager(h.options.parentOptions,!0),this.dataManagers[m]=h.options.dataManager,this.addLayer(L.gmx.createLayer(h.info,h.options))):(l=d.hostName,c[l]||(c[l]={}),c[l][m]||(c[l][m]=[]),c[l][m].push(u))}for(l in c){var g=[],p="http://"+l;for(u in c[l])g.push({Layer:u});a.push(L.gmxUtil.requestJSONP(p+"/Layer/GetLayerJson.ashx",{WrapStyle:"func",Layers:JSON.stringify(g)},{ids:c[l]}).then(function(e,t){if(e&&"ok"===e.Status&&e.Result)e.Result.forEach(function(e){var i=r.addDataManager(e),n=e.properties,a=n.name;t&&t.ids&&t.ids[a]&&t.ids[a].forEach(function(t){var n=o[t];n.options.parentOptions=e.properties,n.options.dataManager=i,r.addLayer(L.gmx.createLayer(n.info,n.options))})});else if(console.info("Error: loading ",p+"/Layer/GetLayerJson.ashx",e.ErrorInfo),t&&t.ids)for(var i in t.ids)t.ids[i].forEach(function(e){r.addLayer(new L.gmx.DummyLayer(o[e].info.properties))})}))}L.gmx.Deferred.all.apply(null,a).then(this.layersCreated.resolve)},addDataManager:function(e){var t=e.properties.name;return this.dataManagers[t]||(this.dataManagers[t]=new i.DataManager(e.properties)),this.dataManagers[t]},getDataManager:function(e){return this.dataManagers[e]},addLayer:function(e){var t=e.getGmxProperties();return this.layers.push(e),this.layersByTitle[t.title]=e,this.layersByID[t.name]=e,this.fire("layeradd",{layer:e}),this},removeLayer:function(e){for(var t=e.getGmxProperties(),r=0;r<this.layers.length;r++)if(this.layers[r].getGmxProperties().name===t.name){this.layers.splice(r,1);break}return delete this.layersByTitle[t.title],delete this.layersByID[t.name],this.fire("layerremove",{layer:e}),this},addLayersToMap:function(e){for(var t=this.layers.length-1;t>=0;t--){var r=this.layers[t];r.getGmxProperties().visible&&e.addLayer(r)}return this}});L.gmx=L.gmx||{},L.gmx.gmxMap=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DataManager=void 0;var i=r(4),n=r(10),o=r(11),a=L.Class.extend({includes:L.Mixin.Events,initialize:function(e){this._dataManager=e,this._observerData={},this._tileData={}},addObserver:function(e){return this._observerData[e.id]={observer:e,tiles:{},leftToLoad:0,loadingState:!1
},e.on("update",this._updateObserver.bind(this,e)),this._updateObserver(e),this},removeObserver:function(e){var t=this._observerData[e].tiles;for(var r in t)delete this._tileData[r].observers[e];return delete this._observerData[e],this},addTile:function(e){var t="loaded"===e.state?0:1;e.loadDef.then(this._tileLoadedCallback.bind(this,e));var r={};for(var i in this._observerData){var n=this._observerData[i];n.observer.intersectsWithTile(e)&&(n.tiles[e.vectorTileKey]=!0,n.leftToLoad+=t,r[i]=!0)}return this._tileData[e.vectorTileKey]={observers:r,tile:e},this},removeTile:function(e){var t=this._tileData[e],r="loaded"===t.tile.state?0:1;for(var i in t.observers){var n=this._observerData[i];n.leftToLoad-=r,delete n.tiles[e]}return delete this._tileData[e],this},startLoadTiles:function(e){this._dataManager._getActiveTileKeys();var t=this._observerData[e.id];if(0===t.leftToLoad)return this.fire("observertileload",{observer:e}),this;t.loadingState||(t.loadingState=!0,e.fire("startLoadingTiles"));for(var r in t.tiles)this._tileData[r].tile.load();return this},getTileObservers:function(e){return this._tileData[e].observers},getObserverLoadingState:function(e){return this._observerData[e.id].loadingState},_updateObserver:function(e){var t,r=this._observerData[e.id],i={},n=0;for(t in this._tileData){var o=this._tileData[t].tile;e.intersectsWithTile(o)&&(i[t]=!0,"loaded"!==o.state&&n++,this._tileData[t].observers[e.id]=!0)}for(t in r.tiles)t in i||delete this._tileData[t].observers[e.id];r.tiles=i,r.leftToLoad=n},_tileLoadedCallback:function(e){if(this.fire("tileload",{tile:e}),e.vectorTileKey in this._tileData){var t=this._tileData[e.vectorTileKey].observers;for(var r in t){var i=this._observerData[r];i.leftToLoad--,0===i.leftToLoad&&(i.loadingState&&(i.loadingState=!1,i.observer.fire("stopLoadingTiles")),this.fire("observertileload",{observer:i.observer}))}}}}),s=L.Class.extend({includes:L.Mixin.Events,options:{name:null,identityField:"",attributes:[],attrTypes:[],tiles:null,tilesVers:null,LayerVersion:-1,GeoProcessing:null,Temporal:!1,TemporalColumnName:"",ZeroDate:"01.01.2008",TemporalPeriods:[],TemporalTiles:[],TemporalVers:[],hostName:"maps.kosmosnimki.ru",sessionKey:"",isGeneralized:!1,isFlatten:!1},setOptions:function(e){this._clearProcessing(),e.GeoProcessing&&(this.processingTile=this.addData([]),this._chkProcessing(e.GeoProcessing)),L.setOptions(this,e),this.optionsLink=e,this._isTemporalLayer=this.options.Temporal;var t=L.gmxUtil.getTileAttributes(this.options);this.tileAttributeIndexes=t.tileAttributeIndexes;var r=this.options.hostName,i=this.options.sessionKey;i||(i=L.gmx.gmxSessionManager.getSessionKey(r)),this.tileSenderPrefix="http://"+r+"/TileSender.ashx?WrapStyle=None&key="+encodeURIComponent(i),this._needCheckActiveTiles=!0},_vectorTileDataProviderLoad:function(e,t,r,i,n,a,s){var l=this;o.gmxVectorTileLoader.load(l.tileSenderPrefix,{x:e,y:t,z:r,v:i,s:n,d:a,layerID:l.options.name}).then(s,function(){console.log("Error loading vector tile"),s([]),l.fire("chkLayerUpdate",{dataProvider:l})})},initialize:function(e,t){this._tilesTree=null,this._activeTileKeys={},this._endDate=null,this._beginDate=null,this._tiles={},this._filters={},this._freeSubscrID=0,this._items={},this._observers={},this._needCheckDateInterval=!1,this._needCheckActiveTiles=!0;var r=this;this._vectorTileDataProvider={load:this._vectorTileDataProviderLoad.bind(this)},this._observerTileLoader=new a(this),this._observerTileLoader.on("tileload",function(e){var t=e.tile;if(r._updateItemsFromTile(t),r._tilesTree){var i=r._tilesTree.getNode(t.d,t.s);i&&i.count--}}),this._observerTileLoader.on("observertileload",function(e){var t=e.observer;t.isActive()&&(t.needRefresh=!1,t.updateData(r.getItems(t.id)))}),this.setOptions(e),t&&(this.options.LayerVersion=-1),this._isTemporalLayer&&this.addFilter("TemporalFilter",function(e,t,r){var i=e.options.unixTimeStamp,n=r.dateInterval;return n&&i>=n.beginDate.valueOf()&&i<n.endDate.valueOf()})},_getActiveTileKeys:function(){if(this._chkMaxDateInterval(),!this._needCheckActiveTiles)return this._activeTileKeys;if(this._needCheckActiveTiles=!1,this._isTemporalLayer){var e={};this._beginDate&&this._endDate&&(this._tilesTree||this.initTilesTree(),e=this._tilesTree.selectTiles(this._beginDate,this._endDate).tiles),this._updateActiveTilesList(e)}else this.initTilesList();return this._activeTileKeys},_getObserversByFilterName:function(e){var t={};for(var r in this._observers)this._observers[r].hasFilter(e)&&(t[r]=!0);return t},addFilter:function(e,t){this._filters[e]=t,this._triggerObservers(this._getObserversByFilterName(e))},removeFilter:function(e){if(this._filters[e]){var t=this._getObserversByFilterName(e);delete this._filters[e],this._triggerObservers(t)}},getItems:function(e){var t=[],r=this._observers[e];if(!r)return[];var i=r.filters.concat("processingFilter");this._isTemporalLayer&&i.push("TemporalFilter"),i=i.filter(function(e){return e in this._filters}.bind(this));var n=this,o=function(e){for(var o=e.data,a=0,s=o.length;a<s;a++){var l=e.dataOptions[a];if(r.intersects(l.bounds)){for(var u=o[a],h=u[0],c=n.getItem(h),d=u[u.length-1],m=!1,f=0;f<i.length;f++){var g=n._filters[i[f]];if(!g(c,e,r,d,l)){m=!0;break}}m||t.push({id:h,properties:u,item:c,dataOption:l,tileKey:e.vectorTileKey})}}},a=this._getActiveTileKeys();for(var s in a){var l=n._tiles[s].tile;l.data&&l.data.length>0&&(0===l.z||r.intersectsWithTile(l))&&o(l)}return t},_updateItemsFromTile:function(e){for(var t=e.vectorTileKey,r=e.data||[],i=r.length,n=r[0]&&r[0].length-1,o=0;o<i;o++){var a=r[o],s=a[n],l=a[0],u=this._items[l];if(u?(u.processing?e.data[o]=u.properties:(u.properties=a,u.type.indexOf("MULTI")===-1&&(u.type="MULTI"+u.type)),delete u.bounds,u.currentFilter=null):(u={id:l,type:s.type,properties:a,options:{fromTiles:{}}},this._items[l]=u),u.options.fromTiles[t]=o,e.isGeneralized&&(u.options.isGeneralized=!0),this.options.TemporalColumnName){var h=a[this.tileAttributeIndexes[this.options.TemporalColumnName]];u.options.unixTimeStamp=1e3*h}}return i},getMaxDateInterval:function(){return this._chkMaxDateInterval(),{beginDate:this._beginDate,endDate:this._endDate}},_chkMaxDateInterval:function(){if(this._isTemporalLayer&&this._needCheckDateInterval){this._needCheckDateInterval=!1;var e=this._observers,t=null,r=null;for(var i in e){var n=e[i],o=n.dateInterval;o&&((!t||o.beginDate<t)&&(t=o.beginDate),(!r||o.endDate>r)&&(r=o.endDate))}t&&r&&(this._beginDate!==t||this._endDate!==r)&&(this._beginDate=t,this._endDate=r,this._needCheckActiveTiles=!0)}},addObserver:function(e,t){t=t||"s"+ ++this._freeSubscrID;var r=this,i=L.gmx.observer(e);return i.id=t,i.needRefresh=!0,this._observerTileLoader.addObserver(i),i.on("update",function(e){i.needRefresh=!0,e.temporalFilter&&(r._needCheckDateInterval=!0),r._waitCheckObservers()}).on("activate",function(){r.fire("observeractivate"),r.checkObserver(i)}),r._needCheckDateInterval=!0,this._observers[t]=i,this._waitCheckObservers(),i.isActive()&&this.fire("observeractivate"),i},getActiveObserversCount:function(){var e=0;for(var t in this._observers)this._observers[t].isActive()&&e++;return e},getObserver:function(e){return this._observers[e]},removeObserver:function(e){if(this._observers[e]){this._observerTileLoader.removeObserver(e);var t=this._observers[e].isActive();delete this._observers[e],t&&this.fire("observeractivate")}},getObserverLoadingState:function(e){return this._observerTileLoader.getObserverLoadingState(e)},getItemsBounds:function(){if(!this._itemsBounds){this._itemsBounds=i.gmxAPIutils.bounds();for(var e in this._items){var t=this.getItem(e);this._itemsBounds.extendBounds(t.bounds)}}return this._itemsBounds},getItem:function(e){var t=this._items[e];if(t&&!t.bounds){var r=t.options.fromTiles,n=[];for(var o in r)if(this._tiles[o]){var a=r[o],s=this._tiles[o].tile;"loaded"===s.state&&s.dataOptions[a]?n.push(s.dataOptions[a].bounds):delete r[o]}if(1===n.length)t.bounds=n[0];else{t.bounds=i.gmxAPIutils.bounds();for(var l=i.gmxAPIutils.worldWidthMerc,u=0,h=n.length;u<h;u++){var c=n[u];t.bounds.max.x-c.min.x>l&&(c=i.gmxAPIutils.bounds([[c.min.x+2*l,c.min.y],[c.max.x+2*l,c.max.y]])),t.bounds.extendBounds(c)}}}return t},getItemMembers:function(e){var t=this._items[e].options.fromTiles,r=[];for(var i in t)if(this._tiles[i]){var n=this._tiles[i].tile;if(n.data){var o=t[i],a=n.data[o],s=n.dataOptions[o],l=s.bounds;r.push({geo:a[a.length-1],width:l.max.x-l.min.x,dataOption:s})}}return r.sort(function(e,t){return t.width-e.width})},getItemGeometries:function(e){var t=this._items[e]?this._items[e].options.fromTiles:{},r=[];for(var n in t)if(this._tiles[n]&&this._tiles[n].tile.data){var o=this._tiles[n].tile.data,a=o[t[n]];r.push(i.gmxAPIutils.getUnFlattenGeo(a[a.length-1]))}return r},addTile:function(e){this._tiles[e.vectorTileKey]={tile:e},this._getActiveTileKeys()[e.vectorTileKey]=!0,this._observerTileLoader.addTile(e),this.checkObservers()},checkObserver:function(e){e.needRefresh&&e.isActive()&&this._observerTileLoader.startLoadTiles(e)},checkObservers:function(){var e=this._observers;for(var t in this._observers)this.checkObserver(e[t])},_waitCheckObservers:function(){this._checkObserversTimer&&clearTimeout(this._checkObserversTimer),this._checkObserversTimer=setTimeout(L.bind(this.checkObservers,this),0)},_triggerObservers:function(e){var t=e||this._observers;for(var r in t)this._observers[r]&&(this._observers[r].needRefresh=!0);this._waitCheckObservers()},_removeDataFromObservers:function(e){var t=this._observers;for(var r in t)this._observers[r].removeData(e);this._waitCheckObservers()},preloadTiles:function(e,t,r){var i={};this._isTemporalLayer?(this._tilesTree||this.initTilesTree(),i=this._tilesTree.selectTiles(e,t).tiles):(this._needCheckActiveTiles=!0,i=this._getActiveTileKeys());var n=[];for(var o in i){var a=this._getVectorTile(o,!0).tile;if("notLoaded"===a.state&&(!r||r.intersects(a.bounds))){var s=a.load();n.push(s)}}return Deferred.all.apply(null,n)},_updateActiveTilesList:function(e){if(this._tileFilteringHook){var t={};for(var r in e)this._tileFilteringHook(this._getVectorTile(r,!0).tile)&&(t[r]=!0);e=t}var i,n=this._activeTileKeys||{},o={},a=this;this.processingTile&&(e[this.processingTile.vectorTileKey]=!0),this._rasterVectorTile&&(i=this._rasterVectorTile.vectorTileKey,e[i]=!0,this._tiles[i]={tile:this._rasterVectorTile});var s=function(e){var t=a._observerTileLoader.getTileObservers(e);for(var r in t)o[r]=!0};for(i in e)n[i]||(this._observerTileLoader.addTile(this._getVectorTile(i,!0).tile),s(i));for(i in n)e[i]||(s(i),this._observerTileLoader.removeTile(i));this._activeTileKeys=e,this._triggerObservers(o)},_propertiesToArray:function(e){var t=e.properties,r=this.tileAttributeIndexes,i=[];for(var n in r)i[r[n]]=t[n];return i[i.length]=e.geometry,i[0]=e.id,i},_clearProcessing:function(){if(this.processingTile){for(var e=this._items,t=this.processingTile,r=t.vectorTileKey,i=t.data||[],n=0,o=i.length;n<o;n++){var a=i[n][0];if(e[a]){var s=e[a];s.processing=null,s.currentFilter=null,delete s.options.fromTiles[r],delete s.fromServerProps,delete s.geometry}}t.clear()}},_chkProcessing:function(e){var t,r,i,n,o,a=this._items,s=!1,l={};if(e){if(e.Deleted)for(r=0,i=e.Deleted.length;r<i;r++)t=e.Deleted[r],l[t]=!0,a[t]&&(a[t].processing=!0,a[t].currentFilter=null),i>0&&(s=!0);var u={};if(e.Inserted)for(r=0,i=e.Inserted.length;r<i;r++)n=e.Inserted[r],l[n[0]]||(u[n[0]]=n);if(e.Updated){for(r=0,i=e.Updated.length;r<i;r++)n=e.Updated[r],l[n[0]]||(u[n[0]]=n);!s&&i>0&&(s=!0)}o=[];for(t in u)this._items[t]&&(this._items[t].properties=u[t],this._items[t].processing=!0,this._items[t].currentFilter=null),o.push(u[t]);o.length>0&&(this.processingTile=this.addData(o))}s?this.addFilter("processingFilter",function(e,t){return 0===t.z||!e.processing}):this.removeFilter("processingFilter")},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._resetTilesTree())},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._resetTilesTree())},_resetTilesTree:function(){this._tilesTree=null,this._needCheckActiveTiles=!0,this._getActiveTileKeys()},updateVersion:function(e){e&&this.setOptions(e),this._resetTilesTree()},_getDataKeys:function(e){for(var t={},r=0,i=e.length;r<i;r++)t[e[r][0]]=!0;return t},_getProcessingTile:function(){if(!this.processingTile){var e=-.5,t=-.5,r=0,i=0,o=-1,a=-1,s=this.options.isFlatten;this.processingTile=new n.VectorTile({load:function(e,t,r,i,n,o,a){a([])}},{x:e,y:t,z:r,v:i,s:o,d:a,isFlatten:s}),this.addTile(this.processingTile)}return this.processingTile},addData:function(e){e||(e=[]);var t=this._getProcessingTile(),r=this._getDataKeys(e),i=t.addData(e,r);return this._itemsBounds&&this._itemsBounds.extendBounds(i),this._updateItemsFromTile(t),this._triggerObservers(),t},removeData:function(e){this._itemsBounds=null;var t=this.processingTile;if(t){var r={};if(!e||!e.length)return t;for(var i=0,n=e.length;i<n;i++){var o=e[i];r[o]=!0,delete this._items[o]}this._removeDataFromObservers(r),t.removeData(r,!0),this._updateItemsFromTile(t),this._triggerObservers()}return t},initTilesTree:function(){this._tilesTree=L.gmx.tilesTree(this.options),this.options.TemporalTiles=this.options.TemporalVers=null,"TemporalTiles"in this.optionsLink&&(this.optionsLink.TemporalVers=this.optionsLink.TemporalTiles=null),this.dateZero=this._tilesTree.dateZero,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})},_getVectorTile:function(e,t){if(!this._tiles[e]&&t){var r=n.VectorTile.parseTileKey(e);r.dateZero=this.dateZero,this._addVectorTile(r)}return this._tiles[e]},_addVectorTile:function(e){e.isFlatten=this.options.isFlatten;var t=new n.VectorTile(this._vectorTileDataProvider,e),r=t.vectorTileKey;return this._tiles[r]={tile:t},r},_getGeneralizedTileKeys:function(e){for(var t=e.z%2?1:2,r=Math.pow(2,t),i=e.z-t,n=Math.floor(e.x/r),o=Math.floor(e.y/r),a={v:e.v,s:-1,d:-1,isGeneralized:!0},s={};i>1;){var l=[i,n,o].join("_");s[l]=L.extend({},a,{x:n,y:o,z:i}),i-=2,n=Math.floor(n/4),o=Math.floor(o/4)}return s},initTilesList:function(){var e={};if(this.options.tiles){for(var t,r,i,o,a=this.options.tiles||[],s=this.options.tilesVers,l=this.options.isGeneralized?{}:null,u={},h=0,c=0,d=a.length;h<d;h+=3,c++)if(i={x:Number(a[h]),y:Number(a[h+1]),z:Number(a[h+2]),v:Number(s[c]),s:-1,d:-1},o=this._getVectorTile(n.VectorTile.createTileKey(i),!0),r=o.tile.vectorTileKey,u[r]=o,e[r]=!0,l){var m=this._getGeneralizedTileKeys(i);for(t in m){var f=m[t];l[t]?l[t].v=Math.max(f.v,l[t].v):l[t]=f}}if(l)for(t in l)i=l[t],r=n.VectorTile.createTileKey(i),u[r]||(this._tiles[r]||this._addVectorTile(i),u[r]=this._tiles[r],e[r]=!0);this._tiles=u,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})}this._updateActiveTilesList(e)},setTileFilteringHook:function(e){this._tileFilteringHook=e,this._needCheckActiveTiles=!0,this._getActiveTileKeys()},removeTileFilteringHook:function(){this._tileFilteringHook=null,this._needCheckActiveTiles=!0,this._getActiveTileKeys()}});t.DataManager=s},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VectorTile=void 0;var i=r(4),n=function e(t,r){this.dataProvider=t,this.loadDef=new L.gmx.Deferred,this.data=null,this.dataOptions=null,this.x=r.x,this.y=r.y,this.z=r.z,this.v=r.v,this.s=r.s||-1,this.d=r.d||-1,this.isGeneralized=r.isGeneralized,this.isFlatten=r.isFlatten,this.bounds=i.gmxAPIutils.getTileBounds(this.x,this.y,this.z),this.gmxTilePoint={x:this.x,y:this.y,z:this.z,s:this.s,d:this.d},this.vectorTileKey=e.makeTileKey(this.x,this.y,this.z,this.v,this.s,this.d),this.s>=0&&r.dateZero&&(this.beginDate=new Date(r.dateZero.valueOf()+this.s*this.d*i.gmxAPIutils.oneDay*1e3),this.endDate=new Date(r.dateZero.valueOf()+(this.s+1)*this.d*i.gmxAPIutils.oneDay*1e3)),this.state="notLoaded"};n.prototype={addData:function(e,t){t&&this.removeData(t,!0);for(var r=e.length,n=new Array(r),o=i.gmxAPIutils.bounds(),a=0;a<r;a++){var s=this._parseItem(e[a]);n[a]=s,o.extendBounds(s.bounds)}return this.data?(this.data=this.data.concat(e),this.dataOptions=this.dataOptions.concat(n)):(this.data=e,this.dataOptions=n),this.state="loaded",this.loadDef.resolve(this.data),o},removeData:function(e){for(var t=this.data||[],r=t.length-1;r>=0;r--)e[t[r][0]]&&(t.splice(r,1),this.dataOptions&&this.dataOptions.splice(r,1))},load:function(){if("notLoaded"===this.state){this.state="loading";var e=this;this.dataProvider.load(e.x,e.y,e.z,e.v,e.s,e.d,function(t,r){e.bbox=r,e.addData(t)})}return this.loadDef},clear:function(){this.state="notLoaded",this.data=null,this.dataOptions=null,this.loadDef=new L.gmx.Deferred},_parseItem:function(e){var t,r=e.length;for(t=0;t<r;t++)null===e[t]&&(e[t]="");var n=e[r-1],o=this.isFlatten,a=n.type,s=a.indexOf("POLYGON")!==-1||a.indexOf("Polygon")!==-1,l="POLYGON"===a||"Polygon"===a,u=n.coordinates,h=[],c=null,d=[];if(s){l&&(u=[u]),c=i.gmxAPIutils.bounds();var m=i.gmxAPIutils.bounds().extendBounds(this.bounds).addBuffer(-.05),f=!1;for(t=0,r=u.length;t<r;t++){for(var g=[],p=[],v=0,y=u[t].length;v<y;v++){o&&"number"!=typeof u[t][v][0]&&(u[t][v]=i.gmxAPIutils.flattenRing(u[t][v]));var x=i.gmxAPIutils.bounds(u[t][v]);g.push(x),0===v&&c.extendBounds(x);var _=i.gmxAPIutils.getHidden(u[t][v],m);p.push(_),_.length&&(f=!0)}d.push(g),h.push(p)}f||(h=null),l&&(d=d[0])}else if("POINT"===a||"Point"===a)c=i.gmxAPIutils.bounds([u]);else if("MULTIPOINT"===a||"MultiPoint"===a)for(c=i.gmxAPIutils.bounds(),t=0,r=u.length;t<r;t++)c.extendBounds(i.gmxAPIutils.bounds([u[t]]));else if("LINESTRING"===a||"LineString"===a)c=i.gmxAPIutils.bounds(u);else if("MULTILINESTRING"===a||"MultiLineString"===a)for(c=i.gmxAPIutils.bounds(),t=0,r=u.length;t<r;t++)c.extendBounds(i.gmxAPIutils.bounds(u[t]));var L={bounds:c,boundsArr:d};return h&&(L.hiddenLines=h),L}},n.makeTileKey=function(e,t,r,i,n,o){return r+"_"+e+"_"+t+"_"+i+"_"+n+"_"+o},n.createTileKey=function(e){return[e.z,e.x,e.y,e.v,e.s,e.d].join("_")},n.parseTileKey=function(e){var t=e.split("_").map(function(e){return Number(e)});return{z:t[0],x:t[1],y:t[2],v:t[3],s:t[4],d:t[5]}},n.boundsFromTileKey=function(e){var t=n.parseTileKey(e);return i.gmxAPIutils.getTileBounds(t.x,t.y,t.z)},t.VectorTile=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gmxVectorTileLoader=void 0;var i=r(4),n={_loadedTiles:{},_getKey:function(e){return[e.layerID,e.x,e.y,e.z,"undefined"==typeof e.d?-1:e.d,"undefined"==typeof e.s?-1:e.s,e.v].join(":")},load:function(e,t){var r=n._getKey(t);if(!this._loadedTiles[r]){var o=new L.gmx.Deferred;this._loadedTiles[r]=o;var a={ModeKey:"tile",r:"j",LayerName:t.layerID,z:t.z,x:t.x,y:t.y,v:t.v};t.d!==-1&&(a.Level=t.d,a.Span=t.s),i.gmxAPIutils.requestJSONP(e,a,{callbackParamName:null}).then(null,function(){o.reject()})}return this._loadedTiles[r]}};window.gmxAPI=window.gmxAPI||{},window.gmxAPI._vectorTileReceiver=window.gmxAPI._vectorTileReceiver||function(e){var t=n._getKey({layerID:e.LayerName,x:e.x,y:e.y,z:e.z,d:e.level,s:e.span,v:e.v});n._loadedTiles[t]&&n._loadedTiles[t].resolve(e.values,e.bbox)},t.gmxVectorTileLoader=n},function(e,t){"use strict";var r=L.Handler.extend({options:{},initialize:function(e){this._map=e,this._layers={},this._lastLayer=null,this._lastId=null;var t=this;this._drawstart=null,this._lastCursor="";var r=function(){if(t._drawstart)return!0;if(null===t._drawstart){if(e.gmxControlsManager){var r=e.gmxControlsManager.get("drawing");r&&r.on("activechange",function(r){t._drawstart=r.activeIcon,e._container.style.cursor=t._drawstart?"pointer":""})}t._drawstart=!1}return!1},i=function(e){var t=e._container;if(t)for(var r=t.parentNode.childNodes,i=0,n=r.length;i<n;i++)if(t===r[i])return i;return 0},n={IMG:!0,DIV:!0,path:!0},o=function(){t._lastLayer&&(t._lastLayer.gmxEventCheck({type:"mousemove"},!0),t._lastLayer=null)},a=function(e){var i=e.type,a=t._map,s=!1;if(e.originalEvent){a.gmxMouseDown=L.Browser.webkit?e.originalEvent.which:e.originalEvent.buttons;var l=e.originalEvent.target;s=n[l.nodeName]&&!L.DomUtil.hasClass(l,"leaflet-tile")&&!L.DomUtil.hasClass(l,"leaflet-popup-tip-container")}if(a._animatingZoom||r()||s||"click"===i&&a._skipClick||"mousemove"===i&&a.gmxMouseDown)return o(),void(a._skipClick=!1);e.layerPoint&&(a._gmxMouseLatLng=e.latlng,a.gmxMousePos=a.getPixelOrigin().add(e.layerPoint));for(var u,h=Object.keys(t._layers).sort(function(e,r){var i=a._layers[e],n=a._layers[r];if(i&&n){var o=i.options,s=n.options,l=(o.zIndexOffset||0)+(o.zIndex||0),u=(s.zIndexOffset||0)+(s.zIndex||0),h=u-l;return h?h:t._layers[r]-t._layers[e]}return 0}),c=null,d="",m=0,f=h.length;m<f;m++){var g=h[m];if(u=a._layers[g],u&&u._map&&!u._animating&&u.options.clickable&&u.gmxEventCheck(e)){u.hasEventListeners("mouseover")&&(d="pointer"),c=u;break}}t._lastCursor===d||r()||(a._container.style.cursor=d),t._lastCursor=d,"zoomend"!==i&&(c?(t._lastLayer!==c&&o(),t._lastLayer=c):o())};e.on({zoomend:function(){e._gmxMouseLatLng&&setTimeout(function(){a({type:"mousemove",latlng:e._gmxMouseLatLng})},0)},click:a,dblclick:a,mousedown:a,mouseup:a,mousemove:a,contextmenu:a,layeradd:function(e){var r=e.layer;"gmxEventCheck"in r&&r.options.clickable&&(t._layers[r._leaflet_id]=i(r))},layerremove:function(e){var r=e.layer._leaflet_id;delete t._layers[r],t._lastLayer&&t._lastLayer._leaflet_id===r&&(t._lastLayer=null,t._lastId=0)}},this)}});L.Map.addInitHook(function(){this._gmxEventsManager||(this._gmxEventsManager=new r(this),this.isGmxDrawing=function(){return this._gmxEventsManager._drawstart},this.on("remove",function(){this._gmxEventsManager&&this._gmxEventsManager.removeHooks()}))})},function(e,t){"use strict";!function(){var e="rus",t=function(e,t,r,i){i[e]||(i[e]={}),i[e][t]=r};L.gmxLocale={setLanguage:function(e){this._language=e},getLanguage:function(){return window.language||this._language||e}},L.gmxLocaleMixin={addText:function(){var e=arguments[0],r=arguments[1];1===arguments.length&&(r=e,e=null);for(var i in r)if(null===e)for(var n in r[i])t(i,n,r[i][n],this);else t(e,i,r[i],this);return this},getText:function(e){for(var t=L.gmxLocale.getLanguage(),r=this[t]||{},i=e?e.split(/\./):[],n=0,o=i.length;n<o&&r;n++)r=r[i[n]];return r}},L.extend(L.gmxLocale,L.gmxLocaleMixin)}()},function(e,t){"use strict";L.extend(L.gmxLocale,{rus:{Coordinates:"Координаты",Length:"Длина",nodeLength:"Длина от начала",edgeLength:"Длина сегмента",Area:"Площадь",Perimeter:"Периметр",units:{m:"м",nm:"м.мили",km:"км",m2:"кв. м",km2:"кв. км",ha:"га",m2html:"м<sup>2",km2html:"км<sup>2"}}})},function(e,t){"use strict";L.extend(L.gmxLocale,{eng:{Coordinates:"Coordinates",Length:"Length",nodeLength:"From start point",edgeLength:"Segment length",Area:"Area",Perimeter:"Perimeter",units:{m:"m",nm:"nmi",km:"km",m2:"sq. m",km2:"sq. km",ha:"ha",m2html:"m<sup>2",km2html:"km<sup>2"}}})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Observer=void 0;var i=r(4),n=L.Class.extend({includes:L.Mixin.Events,initialize:function(e){this.type=e.type||"update",this._callback=e.callback,this._items=null,this.bbox=e.bbox,this.filters=e.filters||[],this.targetZoom=e.targetZoom||null,this.active=!("active"in e)||e.active,e.bounds&&this.setBounds(e.bounds);var t,r=i.gmxAPIutils.worldWidthMerc;this.bbox?this.bbox.max.x>r?(t=this.bbox.max.x-r,this.bbox1=i.gmxAPIutils.bounds([[t-r,this.bbox.max.y],[-(t+r),this.bbox.min.y]])):this.bbox.min.x<-r&&(t=this.bbox.min.x+r,this.bbox1=i.gmxAPIutils.bounds([[t+r,this.bbox.max.y],[r-t,this.bbox.min.y]])):(this.bbox=i.gmxAPIutils.bounds([[-r,-r],[r,r]]),this.world=!0),e.dateInterval&&this._setDateInterval(e.dateInterval[0],e.dateInterval[1])},hasFilter:function(e){for(var t=0,r=this.filters.length;t<r;t++)if(this.filters[t]===e)return!0;return!1},activate:function(){return this.active||(this.active=!0,this.fire("activate")),this},deactivate:function(){return this.active&&(this.active=!1,this.fire("activate")),this},toggleActive:function(e){return e?this.activate():this.deactivate()},isActive:function(){return this.active},updateData:function(e){var t=e.length,r={count:t};if("update"===this.type){this._items||(this._items={});for(var i,n=this._items,o={},a=[],s=[],l=0;l<t;l++){var u=e[l];i=u.id+"_"+u.tileKey,o[i]=u,n[i]||a.push(u)}for(i in n)o[i]||s.push(n[i]);a.length&&(r.added=a),s.length&&(r.removed=s),this._items=o}else r.added=e;return this._callback(r),r=null,e=null,this},removeData:function(e){if("update"!==this.type||!this._items)return this;var t=this._items,r=[];for(var i in e)t[i]&&(r.push(t[i]),delete t[i]);return r.length&&this._callback({removed:r}),this},setBounds:function(e){var t;if(!e)return this.world||(t=i.gmxAPIutils.worldWidthMerc,this.bbox=i.gmxAPIutils.bounds([[-t,-t],[t,t]]),this.bbox1=null,this.world=!0,this.fire("update")),this;var r=e.min,n=e.max;if(!r||!n){var o=L.latLngBounds(e),a=o.getSouthWest(),s=o.getNorthEast();r={x:a.lng,y:a.lat},n={x:s.lng,y:s.lat}}var l=r.x,u=n.x,h=r.y,c=n.y,d=null,m=null;if(this.world=!1,t=(u-l)/2,t>=180)l=-180,u=180,this.world=!0;else if(u>180||l<-180){var f=(u+l)/2%360;f>180?f-=360:f<-180&&(f+=360),l=f-t,u=f+t,l<-180?(d=l+360,m=180,l=-180):u>180&&(d=-180,m=u-360,u=180)}var g=L.Projection.Mercator.project(L.latLng(h,l)),p=L.Projection.Mercator.project(L.latLng(c,u));return this.bbox=i.gmxAPIutils.bounds([[g.x,g.y],[p.x,p.y]]),this.bbox1=null,d&&(g=L.Projection.Mercator.project(L.latLng(h,d)),p=L.Projection.Mercator.project(L.latLng(c,m)),this.bbox1=i.gmxAPIutils.bounds([[g.x,g.y],[p.x,p.y]])),this.fire("update"),this},intersects:function(e){return this.world||this.bbox.intersects(e)||!(!this.bbox1||!this.bbox1.intersects(e))},intersectsWithTile:function(e){if(this.targetZoom){var t=this.targetZoom+(this.targetZoom%2?1:0);if(e.isGeneralized&&e.z!==t||e.z>t)return!1}var r=this.dateInterval;return this.intersects(e.bounds)&&(!e.beginDate||r&&r.endDate>=e.beginDate&&r.beginDate<=e.endDate)},_setDateInterval:function(e,t){e&&t?this.dateInterval={beginDate:e,endDate:t}:this.dateInterval=null},setDateInterval:function(e,t){var r=e&&t;return(!this.dateInterval!=!r||r&&(this.dateInterval.beginDate.valueOf()!==e.valueOf()||this.dateInterval.endDate.valueOf()!==t.valueOf()))&&(this._setDateInterval(e,t),this.fire("update",{temporalFilter:!0})),this}});t.Observer=n},function(e,t){"use strict";!function(){var e=function(e){var t=[],r=e.TemporalTiles||[],i=e.TemporalVers||[],n=e.TemporalPeriods||[],o=n[n.length-1],a=Number.MAX_VALUE,s=e.ZeroDate.split("."),l=new Date(s.length>2?s[2]:2008,s.length>1?s[1]-1:0,s.length>0?s[0]:1),u=new Date(l.getTime()-6e4*l.getTimezoneOffset()),h=u.getTime()/1e3;this.dateZero=u;var c,d,m=function e(t,r,i){var o=t.d;if(r.d===n[o])return t.count++,void t.tiles.push(i);var a=n[o-1],s=n[o]/a;"children"in t||(t.children=new Array(s));var l=Math.floor(r.s*r.d/a),u=l-t.s*s;if(!t.children[u]){var c=a*gmxAPIutils.oneDay,d=l*c+h;t.children[u]={d:o-1,s:l,t1:d,t2:d+c,count:0,children:[],tiles:[]}}e(t.children[u],r,i)},f=n.length-1,g=n[f]*gmxAPIutils.oneDay;for(c=0,d=r.length;c<d;c++){s=r[c];var p=Number(s[1]),v=Number(s[0]);v===o&&(a=Math.min(a,p))}for(c=0,d=r.length;c<d;c++){s=r[c];var y={x:Number(s[2]),y:Number(s[3]),z:Number(s[4]),v:Number(i[c]),s:Number(s[1]),d:Number(s[0])};if(!(y.d<0)){var x=Math.floor(y.s*y.d/n[f])-a,_=x+a;t[x]=t[x]||{d:f,s:_,t1:_*g+h,t2:(_+1)*g+h,count:0,tiles:[]};var L=VectorTile.createTileKey(y);m(t[x],y,L)}}r=i=null,this.selectTiles=function(e,r,i){i=i||{};for(var o=e.valueOf()/1e3,a=r.valueOf()/1e3,s=0,l=(a-o)/3600/24,u=0;u<n.length;u++)if(n[u]>l){s=Math.max(0,u-1);break}n[n.length-1]<=l&&(s=n.length-1);for(var h=Math.min(n.length-1,s+Number(l>n[s])),c=function(e,t){for(var r=0,i=0;i<e.length;i++)e[i].intersects(t)&&r++;return r},d=function e(t,r,n){if(r>=t.t2||n<=t.t1)return{count:0,tiles:[],nodes:[]};if(i.bounds&&!t.tileBounds&&(t.tileBounds=t.tiles.map(function(e){return VectorTile.boundsFromTileKey(e)})),t.d===s){var o=i.bounds?c(t.tileBounds,i.bounds):t.count;return{tiles:t.tiles,count:o,nodes:[t]}}var a,l=0,u=[],d=t.children?t.children.length:0;for(a=0;a<d;a++)t.children[a]?u[a]=e(t.children[a],Math.max(r,t.t1),Math.min(n,t.t2)):u[a]={count:0,tiles:[],nodes:[]},l+=u[a].count;var m=i.bounds?c(t.tileBounds,i.bounds):t.count;if(t.d>h||l<m){var f=[],g=[];for(a=0;a<u.length;a++)g.push(u[a].nodes),f.push(u[a].tiles);return{tiles:[].concat.apply([],f),count:l,nodes:[].concat.apply([],g)}}return{tiles:t.tiles,count:m,nodes:[t]}},m=[],f=0;f<t.length;f++)if(t[f]){var g=d(t[f],o,a);g.tiles.length&&(m=m.concat(g.tiles))}for(var p={},v=0;v<m.length;v++)p[m[v]]=!0;return{tiles:p}},this.getNode=function(e,r){if(e<0||r<0)return null;for(var i=function e(t,r,i){if(!t)return null;if(n[t.d]===r)return t.s===i?t:null;var o=n[t.d]/n[t.d-1],a=Math.floor(i*r/n[t.d-1]),s=a-t.s*o;return t.children[s]?e(t.children[s],r,i):null},o=0;o<t.length;o++){var a=i(t[o],e,r);if(a)return a}return null}};L.gmx.tilesTree=function(t){return new e(t)}}()},function(e,t,r){"use strict";var i=r(4),n=r(19),o=r(20);L.gmx.VectorLayer=L.TileLayer.Canvas.extend({options:{openPopups:[],minZoom:1,zIndexOffset:0,isGeneralized:!0,isFlatten:!1,useWebGL:!1,clickable:!0},initialize:function(e){e=L.setOptions(this,e),this.initPromise=new L.gmx.Deferred,this._drawQueue=[],this._drawQueueHash={},this._drawInProgress={},this._anyDrawings=!1,this.repaintObservers={};var t=this;this._gmx={hostName:i.gmxAPIutils.normalizeHostname(e.hostName||"maps.kosmosnimki.ru"),mapName:e.mapID,useWebGL:e.useWebGL,layerID:e.layerID,beginDate:e.beginDate,endDate:e.endDate,sortItems:e.sortItems||null,styles:e.styles||[],tileSubscriptions:{},_tilesToLoad:0,shiftXlayer:0,shiftYlayer:0,renderHooks:[],preRenderHooks:[],_needPopups:{}},e.crossOrigin&&(this._gmx.crossOrigin=e.crossOrigin),this.on("tileunload",function(e){t._clearTileSubscription(e.tile.zKey)})},_removeTile:function(e){var t=this._tiles[e];if(t){var r=t.el;r&&r.parentNode&&r.parentNode.removeChild(r),delete this._tiles[e]}},onAdd:function(e){if(e.options.crs!==L.CRS.EPSG3857&&e.options.crs!==L.CRS.EPSG3395)throw"GeoMixer-Leaflet: map projection is incompatible with GeoMixer layer";var t=this._gmx;t.shiftY=0,t.applyShift=e.options.crs===L.CRS.EPSG3857,t.currentZoom=e.getZoom(),t.styleManager.initStyles(),L.TileLayer.Canvas.prototype.onAdd.call(this,e),e.on("zoomstart",this._zoomStart,this),e.on("zoomend",this._zoomEnd,this),"Vector"===t.properties.type&&e.on("moveend",this._moveEnd,this),this.options.clickable===!1&&(this._container.style.pointerEvents="none"),t.balloonEnable&&!this._popup&&this.bindPopup(""),this.on("stylechange",this._onStyleChange,this),this.on("versionchange",this._onVersionChange,this),L.gmx.layersVersion.add(this),this.fire("add")},onRemove:function(e){this._container&&this._container.parentNode.removeChild(this._container),e.off({viewreset:this._reset,moveend:this._update},this),this._animated&&e.off({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.updateWhenIdle||e.off("move",this._limitedUpdate,this),this._container=null,this._map=null,this._clearAllSubscriptions(),e.off("zoomstart",this._zoomStart,this),e.off("zoomend",this._zoomEnd,this),this.off("stylechange",this._onStyleChange,this);var t=this._gmx;delete t.map,"Vector"===t.properties.type&&e.off("moveend",this._moveEnd,this),t.dataManager&&!t.dataManager.getActiveObserversCount()&&L.gmx.layersVersion.remove(this),this.fire("remove")},_initContainer:function(){L.TileLayer.Canvas.prototype._initContainer.call(this),this._prpZoomData(),this.setZIndexOffset()},_updateZIndex:function(){if(this._container){var e=this.options,t=e.zIndex||0,r=e.zIndexOffset||0;this._container.style.zIndex=r+t}},_update:function(){return!this._map||this.isExternalVisible&&this.isExternalVisible(this._map._zoom)?void this._clearAllSubscriptions():void this._gmx.styleManager.deferred.then(this.__update.bind(this))},_addTile:function(e){var t=this,r=this._map._zoom,n=this._gmx;if(!n.layerType||!n.styleManager.isVisibleAtZoom(r))return void this._tileLoaded();var o=this._tileCoordsToKey(e,r);
if(!n.tileSubscriptions[o]){n._tilesToLoad++;var a=!1,s=i.gmxAPIutils.getTileNumFromLeaflet(e,r),l=function(){a||(n._tilesToLoad--,t._tileLoaded(),a=!0)},u={type:"resend",active:!1,bbox:n.styleManager.getStyleBounds(s),filters:["clipFilter","userFilter_"+n.layerID,"styleFilter","userFilter"],callback:function(i){t._drawTileAsync(e,r,i).always(l)}};this.options.isGeneralized&&(u.targetZoom=r),"VectorTemporal"===n.layerType&&(u.dateInterval=[n.beginDate,n.endDate]);var h=n.dataManager.addObserver(u,o);h.on("activate",function(){h.isActive()||l()}),h.on("startLoadingTiles",this._chkDrawingState,this),n.tileSubscriptions[o]={z:r,x:e.x,y:e.y,px:256*s.x,py:256*(1+s.y)},h.activate()}},_chkDrawingState:function(){var e=this._gmx,t=this._drawQueue.length>0||Object.keys(this._drawInProgress).length>0;if(!t)for(var r in e.tileSubscriptions){var i=e.dataManager.getObserver(r);if(i&&e.dataManager.getObserverLoadingState(i)){t=!0;break}}!t&&this._anyDrawings?this.fire("doneDraw"):t&&!this._anyDrawings&&this.fire("startDraw"),this._anyDrawings=t},_getLoadedTilesPercentage:function(e){if(!e)return 0;var t=0,r=0,i=["img","canvas"];for(var n in i){var o=e.getElementsByTagName(i[n]);if(o&&o.length>0){t+=o.length;for(var a=0,s=o.length;a<s;a++)o[a]._tileComplete&&r++}}return t<1?0:r/t},_tileLoaded:function(){this._animated&&L.DomUtil.addClass(this._tileContainer,"leaflet-zoom-animated"),0===this._gmx._tilesToLoad&&(this.fire("load"),this._animated&&this._setClearBgBuffer(0))},_tileOnLoad:function(e){e&&L.DomUtil.addClass(e,"leaflet-tile-loaded"),this._tileLoaded()},_tileOnError:function(){},tileDrawn:function(e){this._tileOnLoad(e)},_tileCoordsToKey:function(e,t){return e.x+":"+e.y+":"+(e.z||t)},_getTiledPixelBounds:function(e){var t=this._map,r=this._gmx,i=new L.Point(r.shiftX,r.shiftY),n=t.project(e,this._tileZoom).add(i)._floor(),o=t.getSize().divideBy(2);return new L.Bounds(n.subtract(o),n.add(o))},_pxBoundsToTileRange:function(e){var t=this.options.tileSize;return new L.Bounds(e.min.divideBy(t)._floor(),e.max.divideBy(t)._round())},initFromDescription:function(e){var t=this._gmx;if(t.properties=e.properties,t.geometry=e.geometry,t.properties._initDone&&delete t.properties[t.properties.Temporal?"TemporalTiles":"tiles"],t.properties._initDone=!0,!t.geometry){var r=i.gmxAPIutils.tileSizes[1];t.geometry={type:"POLYGON",coordinates:[[[-r,-r],[-r,r],[r,r],[r,-r],[-r,-r]]]}}if(t.rawProperties=e.rawProperties||e.properties,this._updateProperties(e.properties),e.properties.isGeneralized=this.options.isGeneralized,e.properties.isFlatten=this.options.isFlatten,t.dataManager=this.options.dataManager||new L.gmx.DataManager(e.properties),this.options.parentOptions&&(e.properties.styles||(e.properties.styles=this.options.parentOptions.styles),t.dataManager.on("versionchange",this._onVersionChange,this)),t.styleManager=new n.StyleManager(t),this.options.minZoom=t.styleManager.minZoom,this.options.maxZoom=t.styleManager.maxZoom,t.dataManager.on("observeractivate",function(){t.dataManager.getActiveObserversCount()?L.gmx.layersVersion.add(this):L.gmx.layersVersion.remove(this)},this),"Vector"!==t.properties.type||"chkUpdate"in this.options||(this.options.chkUpdate=!0),"Raster"!==t.rawProperties.type&&this._objectsReorderInit&&this._objectsReorderInit(this),t.clusters&&this.bindClusters(JSON.parse(t.clusters)),t.filter){var o=L.gmx.Parsers.parseSQL(t.filter.replace(/[\[\]]/g,'"'));o&&t.dataManager.addFilter("userFilter_"+t.layerID,function(e){return t.layerID!==this._gmx.layerID||!o||o(e.properties,t.tileAttributeIndexes)?e.properties:null}.bind(this))}return t.dateBegin&&t.dateEnd&&this.setDateInterval(t.dateBegin,t.dateEnd),this.initPromise.resolve(),this},getDataManager:function(){return this._gmx.dataManager},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._gmx.dataManager&&(this._clearAllSubscriptions(),this._gmx.dataManager.enableGeneralization(),this.redraw()))},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._gmx.dataManager&&(this._clearAllSubscriptions(),this._gmx.dataManager.disableGeneralization(),this.redraw()))},setRasterOpacity:function(e){var t=this;return this._gmx.rasterOpacity!==e&&(this._gmx.rasterOpacity=e,this.initPromise.then(function(){t.repaint()})),this},getStyles:function(){return this._gmx.styleManager.getStyles()},getIcons:function(e){return this._gmx.styleManager.getIcons(e),this},setStyles:function(e){var t=this;return this.initPromise.then(function(){t._gmx.styleManager.clearStyles(),e?e.forEach(function(e,r){t.setStyle(e,r,!0)}):t.fire("stylechange")}),this},getStyle:function(e){return this.getStyles()[e]},setStyle:function(e,t,r){var i=this,n=this._gmx;return this.initPromise.then(function(){n.styleManager.setStyle(e,t,r).then(function(){i.fire("stylechange",{num:t||0})})}),this},setStyleHook:function(e){return this._gmx.styleHook=e,this.repaint(),this},removeStyleHook:function(){return this._gmx.styleHook=null,this},setRasterHook:function(e){return this._gmx.rasterProcessingHook=e,this.repaint(),this},removeRasterHook:function(){return this._gmx.rasterProcessingHook=null,this.repaint(),this},setFilter:function(e){var t=this._gmx;return t.dataManager.addFilter("userFilter",function(r){return t.layerID!==this._gmx.layerID||!e||e(r)?r.properties:null}.bind(this)),this},removeFilter:function(){return this._gmx.dataManager.removeFilter("userFilter"),this},setDateInterval:function(e,t){var r=this._gmx;if(r.dateBegin&&r.dateEnd&&(e=r.dateBegin,t=r.dateEnd),!r.beginDate!=!e||!r.endDate!=!t||e&&r.beginDate.valueOf()!==e.valueOf()||t&&r.endDate.valueOf()!==t.valueOf()){if(r.rawProperties.maxShownPeriod&&e){var i=24*r.rawProperties.maxShownPeriod*3600*1e3;e=new Date(Math.max(e.valueOf(),t.valueOf()-i))}r.beginDate=e,r.endDate=t;var n=null,o=r.dataManager;for(var a in r.tileSubscriptions)n=o.getObserver(a),n.setDateInterval(e,t);n=o.getObserver("_Labels"),n&&n.setDateInterval(e,t),"NotVisible"!==window.gmxSkipTiles&&r.properties.UseTiles!==!1||(r.properties.LayerVersion=-1,o.setOptions({LayerVersion:-1}),this._map&&L.gmx.layersVersion.now()),this.fire("dateIntervalChanged")}return this},getDateInterval:function(){return{beginDate:this._gmx.beginDate,endDate:this._gmx.endDate}},addObserver:function(e){return this._gmx.dataManager.addObserver(e)},removeObserver:function(e){return this._gmx.dataManager.removeObserver(e.id)},setPositionOffset:function(e,t){var r=this._gmx;return r.shiftXlayer=e,r.shiftYlayer=t,this._update(),this},getPositionOffset:function(){var e=this._gmx;return{shiftX:e.shiftXlayer,shiftY:e.shiftYlayer}},setZIndexOffset:function(e){return arguments.length&&(this.options.zIndexOffset=e),this._updateZIndex(),this},repaint:function(e){if(this._map){if(!e){e={};for(var t in this._gmx.tileSubscriptions)e[t]=!0;L.extend(e,this.repaintObservers)}this._gmx.dataManager._triggerObservers(e)}},redrawItem:function(e){if(this._map){var t=this._gmx.dataManager.getItem(e),r=this._getTilesByBounds(t.bounds);this.repaint(r)}},gmxGetCanvasTile:function(e){var t=this._tileCoordsToKey(e);if(t in this._tiles)return this._tiles[t];var r=this._getTile();return this._tiles[t]={el:r,coords:e,current:!0},r._zoom=this._map._zoom,r._tileComplete=!0,r._tilePoint=e,this.tileDrawn(r),this._tiles[t]},appendTileToContainer:function(e){this._tileContainer.appendChild(e);var t=this._getTilePos(e._tilePoint);L.DomUtil.setPosition(e,t,L.Browser.chrome||L.Browser.android23)},addData:function(e,t){return this._gmx.mapName||(this._gmx.dataManager.addData(e,t),this.repaint()),this},removeData:function(e,t){return this._gmx.mapName||(this._gmx.dataManager.removeData(e,t),this.repaint()),this},getStylesByProperties:function(e,t){return this._gmx.styleManager.getCurrentFilters(e,t)},getItemStyle:function(e){var t=this._gmx,r=t.dataManager.getItem(e);return t.styleManager.getObjStyle(r)},getTileAttributeTypes:function(){return this._gmx.tileAttributeTypes},getTileAttributeIndexes:function(){return this._gmx.tileAttributeIndexes},getItemBalloon:function(e){var t=this._gmx,r=t.dataManager.getItem(e),i=this.getStyles(),n="";if(r&&i[r.currentFilter]){var o=r.properties;n=L.gmxUtil.parseBalloonTemplate(i[r.currentFilter].Balloon,{properties:this.getItemProperties(o),geometries:[o[o.length-1]],tileAttributeTypes:t.tileAttributeTypes,unitOptions:this._map?this._map.options:{}})}return n},getItemProperties:function(e){var t={},r=this._gmx.tileAttributeIndexes;for(var i in r)t[i]=e[r[i]];return t},addPreRenderHook:function(e){this._gmx.preRenderHooks.push(e),this.repaint()},removePreRenderHook:function(e){for(var t=this._gmx.preRenderHooks,r=0,i=t.length;r<i;r++)if(t[r]===e){t.splice(r,1),this.repaint();break}},addRenderHook:function(e){this._gmx.renderHooks.push(e),this.repaint()},removeRenderHook:function(e){for(var t=this._gmx.renderHooks,r=0,i=t.length;r<i;r++)if(t[r]===e){t.splice(r,1),this.repaint();break}},getGmxProperties:function(){return this._gmx.rawProperties},getBounds:function(){var e=L.Projection.Mercator,t=this._gmx.layerID?i.gmxAPIutils.geoItemBounds(this._gmx.geometry).bounds:this._gmx.dataManager.getItemsBounds();return t?L.latLngBounds([e.unproject(t.min),e.unproject(t.max)]):new L.LatLngBounds},getGeometry:function(){return this._gmx.latLngGeometry||(this._gmx.latLngGeometry=L.gmxUtil.geometryToGeoJSON(this._gmx.geometry,!0)),this._gmx.latLngGeometry},_clearTileSubscription:function(e){var t=this._gmx;if(e in t.tileSubscriptions){var r=t.tileSubscriptions[e];r.screenTile&&r.screenTile.destructor();var i=t.dataManager.getObserver(e);i&&i.deactivate(),delete t.tileSubscriptions[e],this._removeTile(e),this._anyDrawings&&this._chkDrawingState()}e in this._drawQueueHash&&this._drawQueueHash[e].cancel()},_clearAllSubscriptions:function(){for(;this._drawQueue.length;)this._drawQueue[0].def.cancel();var e=this._gmx;for(var t in e.tileSubscriptions){var r=e.tileSubscriptions[t];r.screenTile&&r.screenTile.destructor();var i=e.dataManager.getObserver(t);i&&i.deactivate(),e.dataManager.removeObserver(t),delete e.tileSubscriptions[t],delete this._tiles[t]}this._anyDrawings&&this._chkDrawingState(),e._tilesToLoad=0},_zoomStart:function(){this._gmx.zoomstart=!0},_zoomEnd:function(){this._gmx.zoomstart=!1,this.setCurrentZoom(this._map)},_moveEnd:function(){"dataManager"in this._gmx&&this._gmx.dataManager.fire("moveend")},_onStyleChange:function(){var e=this._gmx;if(!e.balloonEnable&&this._popup?this.unbindPopup():e.balloonEnable&&!this._popup&&this.bindPopup(""),this._map)if(this.options.minZoom===e.styleManager.minZoom&&this.options.maxZoom===e.styleManager.maxZoom||(this.options.minZoom=e.styleManager.minZoom,this.options.maxZoom=e.styleManager.maxZoom,this._map._updateZoomLevels()),e.labelsLayer?this._map._labelsLayer.add(this):e.labelsLayer||this._map._labelsLayer.remove(this),Object.keys(e.tileSubscriptions).length>0)for(var t in e.tileSubscriptions){var r=e.dataManager.getObserver(t),n=e.tileSubscriptions[t],o=i.gmxAPIutils.getTileNumFromLeaflet(n,n.z),a=e.styleManager.getStyleBounds(o);if(!r.bbox.isEqual(a)){var s=L.Projection.Mercator;r.setBounds(L.latLngBounds([s.unproject(a.min),s.unproject(a.max)]))}}else this.redraw()},_removeInProgressDrawing:function(e){delete this._drawInProgress[e],this._chkDrawingState()},_drawTileAsync:function(e,t,r){var n=this._drawQueue,o=0===n.length,a=this._tileCoordsToKey(e,t),s=this;this._drawQueueHash[a]&&this._drawQueueHash[a].cancel();var l=function e(){if(s._chkDrawingState(),n.length){var t=n.shift();delete s._drawQueueHash[t.zKey],s._map&&t.z===s._map._zoom?(t.drawDef=s._gmxDrawTile(t.tp,t.z,t.data),s._drawInProgress[t.zKey]=!0,t.drawDef.always(s._removeInProgressDrawing.bind(s,t.zKey)),t.drawDef.then(t.def.resolve.bind(t.def,t.data),t.def.reject)):t.def.reject(),setTimeout(e,0)}},u=i.gmxAPIutils.getTileNumFromLeaflet(e,t),h={gtp:u,tp:e,z:t,zKey:a,data:r},c=h.def=new L.gmx.Deferred(function(){h.drawDef&&h.drawDef.cancel(),s._removeInProgressDrawing(a),delete s._drawQueueHash[a];for(var e=n.length-1;e>=0;e--){var t=n[e];if(t.zKey===a){n.splice(e,1);break}}});return n.push(h),this._drawQueueHash[a]=c,o&&setTimeout(l,0),c},_updateShiftY:function(){var e=this._gmx,t=this._map,r=0;if(t){var i=t.getCenter();r=t.options.crs.project(i).y-L.Projection.Mercator.project(i).y}e.shiftX=Math.floor(e.mInPixel*(e.shiftXlayer||0)),e.shiftY=Math.floor(e.mInPixel*(r+(e.shiftYlayer||0))),e.shiftPoint=new L.Point(e.shiftX,-e.shiftY),L.DomUtil.setPosition(this._tileContainer,e.shiftPoint)},_prpZoomData:function(){this.setCurrentZoom(this._map)},setCurrentZoom:function(e){var t=this._gmx;t.currentZoom=e._zoom,t.tileSize=i.gmxAPIutils.tileSizes[t.currentZoom],t.mInPixel=256/t.tileSize},_setClearBgBuffer:function(e){this._clearBgBufferTimer&&clearTimeout(this._clearBgBufferTimer);var t=this;this._clearBgBufferTimer=setTimeout(function(){t._bgBuffer&&t._clearBgBuffer()},e||0)},_getNeedPopups:function(){for(var e={},t=this.options.openPopups,r=0,i=t.length;r<i;r++)e[t[r]]=!1;return e},__update:function(){var e=this._map;if(e){var t=e.getZoom(),r=e.getCenter();this._gmx.applyShift&&this._updateShiftY(),this._tileZoom=t,this.options.openPopups.length&&(this._gmx._needPopups=this._getNeedPopups(),this.options.openPopups=[]);var i=this._getTiledPixelBounds(r),n=this._pxBoundsToTileRange(i),o=this._getWrapTileNum();if(n.min.y<0&&(n.min.y=0),n.max.y>=o.y&&(n.max.y=o.y-1),this._chkTileSubscriptions(t,n),t>this.options.maxZoom||t<this.options.minZoom)return void this._setClearBgBuffer(500);for(var a=n.min.y;a<=n.max.y;a++)for(var s=n.min.x;s<=n.max.x;s++){var l=new L.Point(s,a);l.z=this._tileZoom,this._tiles[this._tileCoordsToKey(l)]||this._addTile(l)}}},_chkTileSubscriptions:function(e,t){var r=this._gmx,i=t.min,n=t.max;for(var o in r.tileSubscriptions){var a=r.tileSubscriptions[o];(a.z!==e||a.x<i.x||a.x>n.x||a.y<i.y||a.y>n.y)&&this._clearTileSubscription(o)}},_getScreenTile:function(e,t){var r=this._gmx,i=this._tileCoordsToKey(e,t),n=r.tileSubscriptions[i],a=null;return n&&(n.screenTile?a=n.screenTile:n.screenTile=a=new o.ScreenVectorTile(this,e,t)),a},_gmxDrawTile:function(e,t,r){var i=this._gmx,n=!1,o=null,a=new L.gmx.Deferred(function(){n=!0,o&&o.cancel()});if(!this._map)return a.reject(),a;var s=this._getScreenTile(e,t||this._map._zoom);return s&&i.styleManager.deferred.then(function(){n||(o=s.drawTile(r),o.then(a.resolve.bind(a,r),a.reject))}),a},_getTilesByBounds:function(e){var t=this._gmx,r=this._map._zoom,i=t.shiftX||0,n=t.shiftY||0,o=L.Projection.Mercator.unproject(new L.Point(e.min.x,e.min.y)),a=L.Projection.Mercator.unproject(new L.Point(e.max.x,e.max.y)),s=this._map.getBounds(),l=s.getSouthWest(),u=s.getNorthEast(),h=0;u.lng-l.lng<360&&(a.lng<l.lng?h=360*(1+Math.floor((l.lng-a.lng)/360)):o.lng>u.lng&&(h=360*Math.floor((u.lng-o.lng)/360))),o.lng+=h,a.lng+=h;var c,d,m,f,g=this._map.getPixelBounds(),p=this._map.project(o),v=this._map.project(a);g?(c=Math.floor((Math.max(v.y,g.min.y)+n)/256),d=Math.floor((Math.min(p.y,g.max.y)+n)/256),m=o.lng<=-180?g.min.x:Math.max(p.x,g.min.x),m=Math.floor((m+i)/256),f=a.lng>=180?g.max.x:Math.min(v.x,g.max.x),f=Math.floor((f+i)/256)):(c=Math.floor((v.y+n)/256),d=Math.floor((p.y+n)/256),m=Math.floor((p.x+i)/256),f=Math.floor((v.x+i)/256));for(var y={},x=m;x<=f;x++)for(var _=c;_<=d;_++){var b=this._tileCoordsToKey({x:x,y:_},r);y[b]=!0}return y},_updateProperties:function(e){var t=this._gmx,r=this.options.apikeyRequestHost||t.hostName;t.sessionKey=e.sessionKey=this.options.sessionKey||L.gmx.gmxSessionManager.getSessionKey(r),this.options.parentOptions&&(e=this.options.parentOptions),t.identityField=e.identityField,t.GeometryType=(e.GeometryType||"").toLowerCase(),t.minZoomRasters=e.RCMinZoomForRasters||1,t.minZoomQuicklooks=t.minZoomRasters;var i=e.type||"Vector";if(e.Temporal&&(i+="Temporal"),t.layerType=i,t.items={},L.extend(t,L.gmxUtil.getTileAttributes(e)),t.dataManager&&t.dataManager.setOptions(e),"ZIndexField"in e&&e.ZIndexField in t.tileAttributeIndexes&&(t.zIndexField=t.tileAttributeIndexes[e.ZIndexField]),this._objectsReorder&&this._objectsReorder.initialize(),t.filter=e.filter,t.dateBegin=e.dateBegin,t.dateEnd=e.dateEnd,t.dataSource=e.dataSource,"MetaProperties"in t.rawProperties){var n=t.rawProperties.MetaProperties;"parentLayer"in n&&(t.dataSource=n.parentLayer.Value||""),"filter"in n&&(t.filter=n.filter.Value||""),"dateBegin"in n&&(t.dateBegin=L.gmxUtil.getDateFromStr(n.dateBegin.Value||"01.01.1980")),"dateEnd"in n&&(t.dateEnd=L.gmxUtil.getDateFromStr(n.dateEnd.Value||"01.01.1980")),("shiftX"in n||"shiftY"in n)&&(t.shiftXlayer=n.shiftX?Number(n.shiftX.Value):0,t.shiftYlayer=n.shiftY?Number(n.shiftY.Value):0),("shiftXfield"in n||"shiftYfield"in n)&&(n.shiftXfield&&(t.shiftXfield=n.shiftXfield.Value),n.shiftYfield&&(t.shiftYfield=n.shiftYfield.Value)),"quicklookPlatform"in n&&(t.quicklookPlatform=n.quicklookPlatform.Value,"image"===t.quicklookPlatform&&delete t.quicklookPlatform),"quicklookX1"in n&&(t.quicklookX1=n.quicklookX1.Value),"quicklookY1"in n&&(t.quicklookY1=n.quicklookY1.Value),"quicklookX2"in n&&(t.quicklookX2=n.quicklookX2.Value),"quicklookY2"in n&&(t.quicklookY2=n.quicklookY2.Value),"quicklookX3"in n&&(t.quicklookX3=n.quicklookX3.Value),"quicklookY3"in n&&(t.quicklookY3=n.quicklookY3.Value),"quicklookX4"in n&&(t.quicklookX4=n.quicklookX4.Value),"quicklookY4"in n&&(t.quicklookY4=n.quicklookY4.Value),"multiFilters"in n&&(t.multiFilters="1"===n.multiFilters.Value),"isGeneralized"in n&&(this.options.isGeneralized="false"!==n.isGeneralized.Value),"isFlatten"in n&&(this.options.isFlatten="false"!==n.isFlatten.Value)}if(e.Temporal&&(this.options.isGeneralized=!1),e.IsRasterCatalog){t.IsRasterCatalog=e.IsRasterCatalog;var o=t.tileAttributeIndexes.GMX_RasterCatalogID;o&&(t.rasterBGfunc=function(e,r,i,n){var a=n.properties;return"http://"+t.hostName+"/TileSender.ashx?ModeKey=tile&x="+e+"&y="+r+"&z="+i+"&LayerName="+a[o]+"&key="+encodeURIComponent(t.sessionKey)})}if(e.Quicklook){var a;a="{"===e.Quicklook[0]?JSON.parse(e.Quicklook):{minZoom:t.minZoomRasters,template:e.Quicklook},"X1"in a&&(t.quicklookX1=a.X1),"Y1"in a&&(t.quicklookY1=a.Y1),"X2"in a&&(t.quicklookX2=a.X2),"Y2"in a&&(t.quicklookY2=a.Y2),"X3"in a&&(t.quicklookX3=a.X3),"Y3"in a&&(t.quicklookY3=a.Y3),"X4"in a&&(t.quicklookX4=a.X4),"Y4"in a&&(t.quicklookY4=a.Y4);var s=t.Quicklook=a.template;"minZoom"in a&&(t.minZoomQuicklooks=a.minZoom),t.quicklookBGfunc=function(e){for(var r=s,i=/\[([^\]]+)\]/,n=i.exec(r);n&&n.length>1;)r=r.replace(n[0],e.properties[t.tileAttributeIndexes[n[1]]]),n=i.exec(r);return r},t.imageQuicklookProcessingHook=L.gmx.gmxImageTransform}this.options.attribution=e.Copyright||""},_onVersionChange:function(){this._updateProperties(this._gmx.rawProperties)},getViewRasters:function(){var e=this._gmx,t={},r=[];for(var i in e.tileSubscriptions){var n=e.tileSubscriptions[i],o=n.screenTile;o&&o.itemsView.forEach(function(e){t[e.id]=!0})}for(var a in t)r.push(a);return r},getPropItem:function(e,t){return i.gmxAPIutils.getPropItem(e,t,this._gmx.tileAttributeIndexes)}})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StyleManager=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=r(4),o=function(e){this.gmx=e,this.deferred=new L.gmx.Deferred,this._maxVersion=0,this._maxStyleSize=0,this._styles=[],this._deferredIcons=[],this._parserFunctions={},this._serverStylesParsed=!1;for(var t=1/0,r=-(1/0),i=e.properties.styles||[],n=0,o=i.length;n<o;n++){var a=i[n];t=Math.min(t,a.MinZoom),r=Math.max(r,a.MaxZoom)}this.minZoom=t===1/0?0:t,this.maxZoom=r===-(1/0)?18:r};o.prototype={_getMaxStyleSize:function(e){for(var t=0,r=0,i=this._styles.length;r<i;r++){var n=this._styles[r];if(!(e>n.MaxZoom||e<n.MinZoom)){var a=n.RenderStyle;if(this._needLoadIcons||!a||!("maxSize"in a)){t=o.MAX_STYLE_SIZE;break}var s=0;"iconAnchor"in a&&!a.iconCenter&&(s=Math.max(Math.abs(a.iconAnchor[0]),Math.abs(a.iconAnchor[1]))),t=Math.max(a.maxSize+s,t)}}return t},getStyleBounds:function(e){if(!e)return n.gmxAPIutils.bounds();this._maxStyleSize=this._getMaxStyleSize(this.gmx.currentZoom);var t=2*this._maxStyleSize*n.gmxAPIutils.tileSizes[e.z]/256;return n.gmxAPIutils.getTileBounds(e.x,e.y,e.z).addBuffer(t)},isVisibleAtZoom:function(e){for(var t=0,r=this._styles.length;t<r;t++){var i=this._styles[t];if(e>=i.MinZoom&&e<=i.MaxZoom)return!0}return!1},getIcons:function(e){var t=this;this.deferred.then(function(){for(var r=[],i=0,n=t._styles.length;i<n;i++){var o=t._styles[i],a={};o.RenderStyle&&(a.RenderStyle={image:o.RenderStyle.image}),o.HoverStyle&&(a.HoverStyle={image:o.HoverStyle.image}),r.push(a)}e&&e(r)}),this.initStyles()},_chkReady:function(){if(this._needLoadIcons<1){var e=this;this.gmx.dataManager&&this.gmx.dataManager.addFilter("styleFilter",function(t){return e._chkStyleFilter(t)}),this.deferred.resolve()}},initStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var e=0,t=this._deferredIcons.length;e<t;e++)this._getImageSize(this._deferredIcons[e]);return this._deferredIcons=[],this._chkReady(),this.deferred},getStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var e=[],t=0,r=this._styles.length;t<r;t++){var i=L.extend({},this._styles[t]);i.RenderStyle=o.getStyleKeys(i.RenderStyle),i.HoverStyle&&(i.HoverStyle=o.getStyleKeys(i.HoverStyle)),delete i.filterFunction,delete i.version,delete i.common,delete i.type,e.push(i)}return e},clearStyles:function(){this._styles=[],this.gmx.balloonEnable=!1,this.gmx.labelsLayer=!1},_changeStylesVersion:function(){var e=this;this._styles.map(function(t){t.version=++e._maxVersion})},setStyle:function(e,t,r){if(t=t||0,t<this._styles.length||r){var n=this._styles[t];if(n||(n=this._prepareItem({}),this._styles[t]=n),this.deferred=new L.gmx.Deferred,n.version=++this._maxVersion,"Filter"in e){n.Filter=e.Filter;var a=i(e.Filter);n.filterFunction="string"===a?L.gmx.Parsers.parseSQL(n.Filter.replace(/[\[\]]/g,'"')):"function"===a?n.Filter:null,this._changeStylesVersion()}for(var s=0,l=o.DEFAULT_KEYS.length;s<l;s++){var u=o.DEFAULT_KEYS[s];u in e&&(n[u]=e[u])}e.RenderStyle&&(n.RenderStyle=this._parseStyle(e.RenderStyle)),e.HoverStyle&&(n.HoverStyle=this._parseStyle(e.HoverStyle,n.RenderStyle)),this._checkStyles()}return this.initStyles()},getItemBalloon:function(e){var t=this.gmx.dataManager.getItem(e),r=t?t.currentFilter:0,i=this._styles[r];return i?{DisableBalloonOnMouseMove:i.DisableBalloonOnMouseMove||!1,DisableBalloonOnClick:i.DisableBalloonOnClick||!1,templateBalloon:i.Balloon||null,isSummary:/\[SUMMARY\]/.test(i.Balloon)}:null},getObjStyle:function(e){this._chkStyleFilter(e);var t,r=this._styles[e.currentFilter];return r?r.hoverDiff&&this.gmx.lastHover&&e.id===this.gmx.lastHover.id?r.HoverStyle?(t=r.HoverStyle.version||-1,t!==e.styleVersion&&(e.parsedStyleHover=this._itemStyleParser(e,r.HoverStyle)),r.HoverStyle):(delete e.parsedStyleHover,null):(t=r.version||-1,t!==e.styleVersion&&(e.parsedStyleKeys=this._itemStyleParser(e,r.RenderStyle)),r.RenderStyle):null},_needLoadIcons:0,_getImageSize:function(e){var t=e.iconUrl||e.fillIconUrl,r=e.iconAngle||e.iconScale?{crossOrigin:"anonymous"}:{},i=this;L.gmxUtil.isIE11&&/\.svg$/.test(t)&&(r={}),r.layerID=this.gmx.layerID,++this._needLoadIcons,L.gmx.imageLoader.unshift(t,r).def.then(function(r){if(e.version=++i._maxVersion,e.fillIconUrl)e.imagePattern=r;else{var n=r.width,o=r.height;L.gmxUtil.isIE11&&/\.svg$/.test(t)&&(document.body.appendChild(r),n=r.offsetWidth,o=r.offsetHeight,document.body.removeChild(r)),e.sx=n,e.sy=o,e.image=r;var a=e.iconAngle?Math.sqrt(e.sx*e.sx+e.sy*e.sy):Math.max(e.sx,e.sy);e.scaleFunction||e.rotateFunction||((e.iconScale||1===e.iconScale)&&(a*=e.iconScale),e.common=!0),e.maxSize=Number(a.toFixed())}i._needLoadIcons--,i._chkReady()},function(){e.version=++i._maxVersion,e.sx=1,e.sy=0,e.image=null,i._needLoadIcons--,i._chkReady(),console.log({url:t,func:"_getImageSize",Error:"image not found"})})},getCurrentFilters:function(e,t){var r=this.gmx,i=r.tileAttributeIndexes,n=r.tileAttributeTypes,o=t||1,a=[];this._serverStylesParsed||this._parseServerStyles();for(var s=0,l=this._styles.length;s<l;s++){var u=this._styles[s];if(!(o>u.MaxZoom||o<u.MinZoom||u.filterFunction&&!u.filterFunction(e,i,n)||(a.push(s),r.multiFilters)))break}return a},_chkStyleFilter:function(e){var t=this.gmx,r=t.currentZoom,i=t.multiFilters?-1:e.currentFilter,n=this._styles[i],o=!n||n.version!==e.styleVersion;if(o||e._lastZoom!==r){e.currentFilter=-1,e.multiFilters=[];for(var a=this.getCurrentFilters(e.properties,r),s=0,l=a.length;s<l;s++){var u=a[s],h=this._styles[u];if(e.hoverDiff=h.hoverDiff,e.currentFilter=u,o||i!==u){var c=h.common&&h.common.RenderStyle||this._itemStyleParser(e,h.RenderStyle),d=null;e.parsedStyleKeys=c,h.HoverStyle&&(d=h.common&&h.common.HoverStyle||this._itemStyleParser(e,h.HoverStyle),e.parsedStyleHover=d),t.multiFilters&&e.multiFilters.push({style:h.RenderStyle,styleHover:h.HoverStyle,parsedStyle:c,parsedStyleHover:d})}if(e.styleVersion=h.version,!t.multiFilters)break}e._lastZoom=r}return!!this._styles[e.currentFilter]||(e.currentFilter=-1,!1)},_parseServerStyles:function(){for(var e=this.gmx,t=e.properties,r=t.styles||[{MinZoom:1,MaxZoom:21,RenderStyle:o.DEFAULT_STYLE}],i=Math.max(r.length,e.styles.length),n=0;n<i;n++)if(!this._styles[n]){var a=e.styles[n]||r[n];if(a.RenderStyle||(a.RenderStyle=o.DEFAULT_STYLE),void 0===a.HoverStyle){var s=JSON.parse(JSON.stringify(a.RenderStyle));s.outline&&(s.outline.thickness+=1),a.HoverStyle=s}else null===a.HoverStyle&&delete a.HoverStyle;var l=this._prepareItem(a);this._styles.push(l),this._isLabel(l.RenderStyle)&&(e.labelsLayer=!0)}this._checkStyles(),this._serverStylesParsed=!0},_checkStyles:function(){for(var e=1/0,t=-(1/0),r=!1,i=!1,n=0,a=this._styles.length;n<a;n++){var s=this._styles[n];s.DisableBalloonOnMouseMove=s.DisableBalloonOnMouseMove!==!1,s.DisableBalloonOnClick=s.DisableBalloonOnClick||!1,s.DisableBalloonOnMouseMove!==!1&&s.DisableBalloonOnClick!==!1||(r=!0,s.BalloonEnable=!0),s.hoverDiff=null,s.common={},s.RenderStyle&&(i||this._isLabel(s.RenderStyle)&&(i=!0),s.RenderStyle.common&&(s.common.RenderStyle=this._itemStyleParser({},s.RenderStyle)),s.HoverStyle&&(s.hoverDiff=o.checkDiff(s.RenderStyle,s.HoverStyle))),s.HoverStyle&&s.HoverStyle.common&&(s.common.HoverStyle=this._itemStyleParser({},s.HoverStyle)),e=Math.min(e,s.MinZoom),t=Math.max(t,s.MaxZoom)}this.minZoom!==1/0&&(this.minZoom=e),this.maxZoom!==-(1/0)&&(this.maxZoom=t),this.gmx.balloonEnable=r,this.gmx.labelsLayer=i},_parseStyle:function(e,t){if(e){e.common=!0;for(var r in e)if(n.gmxAPIutils.styleFuncKeys[r]){var i=n.gmxAPIutils.styleFuncKeys[r],a=e[r];"string"==typeof a?(e.common=!1,t&&t[r]===a?e[i]=t[i]:(this._parserFunctions[a]||(this._parserFunctions[a]=L.gmx.Parsers.parseExpression(a)),e[i]=this._parserFunctions[a])):"function"==typeof a&&(e.common=!1,e[i]=a)}var s="";if("iconUrl"in e)s="image",e.iconUrl&&(e.maxSize=256,this._deferredIcons.push(e));else if(e.fillIconUrl)s="square",this._deferredIcons.push(e);else if(e.fillPattern)s="square",e.common=o.parsePattern(e.fillPattern),e.canvasPattern=n.gmxAPIutils.getPatternIcon(null,e);else if(e.iconCircle)s="circle","iconSize"in e||(e.iconSize=4);else if(e.iconPath){s="iconPath";var l=0,u=L.Util.isArray(e.iconPath)?e.iconPath:o.DEFAULT_ICONPATH;e.iconPath=o.DEFAULT_ICONPATH.map(function(e,t){var r=u[t]||e;return l=Math.max(l,r),r}),e.iconSize=2*l}else if(e.fillRadialGradient){s="circle","iconCenter"in e||(e.iconCenter=!0);var h=o.parseRadialGradient(e.fillRadialGradient);null===h?e.common=!1:e.iconSize=h}else e.fillLinearGradient?(s="square",e.common=o.parseLinearGradient(e.fillLinearGradient)):e.iconSize&&(s="square","iconCenter"in e||(e.iconCenter=!0));e.type=s,e.common&&!e.maxSize&&(e.maxSize=e.iconSize||0,e.maxSize+=e.weight?e.weight:0,"iconScale"in e&&(e.maxSize*=e.iconScale))}return e},_prepareItem:function(e){var t={MinZoom:e.MinZoom||0,MaxZoom:e.MaxZoom||18,Filter:e.Filter||null,Balloon:e.Balloon||"",RenderStyle:e.RenderStyle?this._parseStyle(L.gmxUtil.fromServerStyle(e.RenderStyle)):{},version:++this._maxVersion};if(t.DisableBalloonOnMouseMove=e.DisableBalloonOnMouseMove!==!1,t.DisableBalloonOnClick=e.DisableBalloonOnClick||!1,e.HoverStyle&&(t.HoverStyle=this._parseStyle(L.gmxUtil.fromServerStyle(e.HoverStyle),t.RenderStyle)),"Filter"in e){var r=L.gmx.Parsers.parseSQL(e.Filter.replace(/[\[\]]/g,'"'));r&&(t.filterFunction=r)}return t},_isLabel:function(e){var t=this.gmx.tileAttributeIndexes;return e&&(e.labelTemplate||e.labelField&&e.labelField in t)},_itemStyleParser:function(e,t){t=t||{};var r,i,o,a={},s=this.gmx.tileAttributeIndexes,l=e.properties||{},u=e.type,h=t.type,c="color"in t?t.color:255,d="opacity"in t?t.opacity:1;if(a.sx=t.sx,a.sy=t.sy,t.maxSize&&(a.maxSize=t.maxSize),t.iconAngle){var m=t.iconAngle||0;m&&"string"==typeof m&&(m=t.rotateFunction?t.rotateFunction(l,s):0),a.rotate=m||0}if("iconColor"in t&&(a.iconColor="iconColorFunction"in t?t.iconColorFunction(l,s):t.iconColor),"iconScale"in t&&(a.iconScale="scaleFunction"in t?t.scaleFunction?t.scaleFunction(l,s):1:t.iconScale),"image"===h)a.type=h,t.iconUrl&&(a.iconUrl=t.iconUrl),t.image&&(a.image=t.image);else if(t.fillRadialGradient){var f=t.fillRadialGradient,g=f.r1Function?f.r1Function(l,s):f.r1,p=f.r2Function?f.r2Function(l,s):f.r2,v=f.x1Function?f.x1Function(l,s):f.x1,y=f.y1Function?f.y1Function(l,s):f.y1,x=f.x2Function?f.x2Function(l,s):f.x2,_=f.y2Function?f.y2Function(l,s):f.y2;f.r2max&&(p=Math.min(p,f.r2max));var L=[];for(o=f.addColorStop.length,f.addColorStopFunctions||(f.addColorStopFunctions=new Array(o)),i=0;i<o;i++){r=f.addColorStop[i];var b=f.addColorStopFunctions[i]||[],P=b[0]?b[0](l,s):r[0],I=r[3];if(r.length<4){var S=r.length<3?1:b[2]?b[2](l,s):r[2];I=n.gmxAPIutils.dec2color(b[1]?b[1](l,s):r[1],S)}L.push([P,I])}a.maxSize=a.sx=a.sy=a.iconSize=p,a.fillRadialGradient={x1:v,y1:y,r1:g,x2:x,y2:_,r2:p,addColorStop:L},a._radialGradientParsed={create:[v,y,g,x,_,p],colorStop:L}}else if(t.fillLinearGradient)a.fillLinearGradient=t.fillLinearGradient;else{if(t.fillPattern&&(a.canvasPattern=t.canvasPattern?t.canvasPattern:n.gmxAPIutils.getPatternIcon(e,t,s)),"iconPath"===h&&(a.type=h,a.iconPath=t.iconPath),"POLYGON"!==u&&"MULTIPOLYGON"!==u&&"polygon"!==this.gmx.GeometryType||(h="polygon"),t.iconSize){var T="sizeFunction"in t?t.sizeFunction(l,s):t.iconSize;a.sx=a.sy=T,a.iconSize=T,"iconScale"in t&&(a.iconSize*=t.iconScale),a.maxSize=T}a.stroke=!0,("colorFunction"in t||"opacityFunction"in t)&&(c="colorFunction"in t?t.colorFunction(l,s):c,d="opacityFunction"in t?t.opacityFunction(l,s):d),a.strokeStyle=n.gmxAPIutils.dec2color(c,d),a.lineWidth="weight"in t?t.weight:1}if("iconScale"in t&&(a.iconScale="scaleFunction"in t?t.scaleFunction?t.scaleFunction(l,s):1:t.iconScale),"iconAnchor"in t&&(a.iconAnchor=t.iconAnchor),"iconCenter"in t&&(a.iconCenter=t.iconCenter),"square"===h||"polygon"===h||"circle"===h||"iconPath"===h){a.type=h;var M=t.fillOpacity,k=t.fillColor,C="string"==typeof k?parseInt(k.replace(/#/,""),16):k;"fillColor"in t&&(a.fillStyle=n.gmxAPIutils.dec2color(C,1)),"fillColorFunction"in t||"fillOpacityFunction"in t?(c="fillColorFunction"in t?t.fillColorFunction(l,s):k||255,d="fillOpacityFunction"in t?t.fillOpacityFunction(l,s):M||1,a.fillStyle=n.gmxAPIutils.dec2color(c,d)):"fillOpacity"in t&&"fillColor"in t&&(a.fillStyle=n.gmxAPIutils.dec2color(C,M))}if("dashArray"in t&&(a.dashArray=t.dashArray),"dashOffset"in t&&(a.dashOffset=t.dashOffset),this.gmx.labelsLayer){for(r=n.gmxAPIutils.styleKeys.label.client,i=0,o=r.length;i<o;i++){var D=r[i];if(D in t){if("labelField"===D){if(!s[t[D]])continue}else if("labelTemplate"===D){var A=n.gmxAPIutils.getPropertiesHash(l,s);a.labelText=n.gmxAPIutils.parseTemplate(t[D],A)}a[D]=t[D]}}"labelAnchor"in t&&(a.labelAnchor=t.labelAnchor)}return a}},o.MAX_STYLE_SIZE=256,o.DEFAULT_STYLE={outline:{color:255,thickness:1},marker:{size:8
}},o.DEFAULT_KEYS=["MinZoom","MaxZoom","Balloon","BalloonEnable","DisableBalloonOnMouseMove","DisableBalloonOnClick"],o.DEFAULT_ICONPATH=[0,10,5,-10,-5,-10,0,10],o.parsePattern=function(e){var t=!0,r=L.gmx.Parsers;if("step"in e&&"string"==typeof e.step&&(e.patternStepFunction=r.parseExpression(e.step),t=!1),"width"in e&&"string"==typeof e.width&&(e.patternWidthFunction=r.parseExpression(e.width),t=!1),"colors"in e){for(var i=[],n=0,o=e.colors.length;n<o;n++){var a=e.colors[n];"string"==typeof a?(i.push(r.parseExpression(a)),t=!1):i.push(null)}e.patternColorsFunction=i}return t},o.getStyleKeys=function(e){var t={};for(var r in n.gmxAPIutils.styleKeys)for(var i=n.gmxAPIutils.styleKeys[r],o=0,a=i.client.length;o<a;o++){var s=i.client[o];s in e&&(void 0!==e[s]&&(t[s]=JSON.parse(JSON.stringify(e[s]))),"fillPattern"===s?delete t[s].patternColorsFunction:"fillLinearGradient"===s&&delete t[s].addColorStopFunctions)}return"iconAnchor"in e&&(t.iconAnchor=e.iconAnchor),"labelAnchor"in e&&(t.labelAnchor=e.labelAnchor),t},o.checkDiff=function(e,t){for(var r in e)if(e[r]!==t[r])return r;return null},o.parseRadialGradient=function(e){var t=!0,r=L.gmx.Parsers,i=0,o=["r1","x1","y1","r2","x2","y2"],a=o.length;for(i=0;i<a;i++){var s=o[i];e[s]||(e[s]=0),"string"==typeof e[s]&&(e[s+"Function"]=r.parseExpression(e[s]),t=!1)}for(e.addColorStop=e.addColorStop||[[0,16711680,.5],[1,16777215,.5]],e.addColorStopFunctions=[],i=0,a=e.addColorStop.length;i<a;i++){o=e.addColorStop[i];var l=["string"==typeof o[0]?r.parseExpression(o[0]):null,"string"==typeof o[1]?r.parseExpression(o[1]):null,"string"==typeof o[2]?r.parseExpression(o[2]):null];e.addColorStopFunctions.push(l),null===l[1]&&null===l[2]?o[3]=n.gmxAPIutils.dec2color(o[1],o[2]>1?o[2]/100:o[2]):t=!1}return"r2Function"in e&&(t=!1),t?Math.max(e.r1,e.r2):null},o.parseLinearGradient=function(e){var t=!0,r=0,i=L.gmx.Parsers,n=["x1","y1","x2","y2"],o=[0,0,0,256],a=n.length;for(r=0;r<a;r++){var s=n[r];s in e?"string"==typeof e[s]&&(e[s+"Function"]=i.parseExpression(e[s]),t=!1):e[s]=o[r]}for(e.addColorStop=e.addColorStop||[[0,16711680],[1,16777215]],e.addColorStopFunctions=[],r=0,a=e.addColorStop.length;r<a;r++)n=e.addColorStop[r],e.addColorStopFunctions.push(["string"==typeof n[0]?i.parseExpression(n[0]):null,"string"==typeof n[1]?i.parseExpression(n[1]):null,"string"==typeof n[2]?i.parseExpression(n[2]):null]);return t},t.StyleManager=o},function(e,t,r){"use strict";function i(e,t,r){this.layer=e,this.tilePoint=t,this.zoom=r,this.gmx=e._gmx,this.zKey=this.layer._tileCoordsToKey(t,r);var i=n.gmxAPIutils;this.worldWidthMerc=i.worldWidthMerc;var o=i.getTileNumFromLeaflet(t,r);this.tbounds=i.getTileBounds(o.x,o.y,o.z),this.tpx=256*o.x,this.tpy=256*(1+o.y),this.gmxTilePoint=o,this.showRaster=r>=this.gmx.minZoomRasters&&"rasterBGfunc"in this.gmx||r>=this.gmx.minZoomQuicklooks&&"quicklookBGfunc"in this.gmx,this.rasters={},this.rasterRequests={},this.itemsView=[],this._uniqueID=0,this.gmx.badTiles=this.gmx.badTiles||{}}Object.defineProperty(t,"__esModule",{value:!0}),t.ScreenVectorTile=void 0;var n=r(4);i.prototype={_loadTileRecursive:function(e,t){var r,i=this.gmx,n=this,o=null,a=new L.gmx.Deferred(function(){o&&(delete n.rasterRequests[r],o.cancel())}),s=function e(s,l){var u=t(s),h=function(){s.z>1?e({x:Math.floor(s.x/2),y:Math.floor(s.y/2),z:s.z-1},""):a.reject()};if(i.badTiles[u]||i.maxNativeZoom&&i.maxNativeZoom<s.z)return void h();var c=n.rasterRequests[u];c?c.options.tileRastersId=n._uniqueID:(i.rasterProcessingHook&&(l="anonymous"),c=L.gmx.imageLoader.push(u,{tileRastersId:n._uniqueID,zoom:n.zoom,cache:!0,crossOrigin:l||""}),n.rasterRequests[u]=c),r=u,o=c.def,o.then(function(e){a.resolve({gtp:s,image:e})},function(){i.badTiles[u]=!0,h()})};return s(e),a},_rasterHook:function(e){var t=e.sourceTilePoint||e.destinationTilePoint,r={geoItem:e.geoItem,destination:{z:e.destinationTilePoint.z,x:e.destinationTilePoint.x,y:e.destinationTilePoint.y},source:{z:t.z,x:t.x,y:t.y}};return e.url&&(r.quicklook=e.url),(this.gmx.rasterProcessingHook||this._defaultRasterHook)(e.res,e.image,e.sx||0,e.sy||0,e.sw||256,e.sh||256,e.dx||0,e.dy||0,e.dw||256,e.dh||256,r)},_defaultRasterHook:function(e,t,r,i,n,o,a,s,l,u){var h=e.getContext("2d");h.drawImage(t,r,i,n,o,a,s,l,u)},_getShiftPixels:function(e){var t=e.dx+(e.dx<0?256:0),r=e.dy+(e.dy<0?256:0),i=0,n=256-t,o=t,a=n;if(e.tx>e.x&&(i=n,n=t,o=0,a=n),256===i||n<1)return null;var s=r,l=256-r,u=0,h=l;return e.ty>e.y&&(s=0,u=l,l=r,h=l),256===s||l<1?null:{sx:i,sy:s,sw:n,sh:l,dx:o,dy:u,dw:a,dh:h}},_getShiftTilesArray:function(e,t,r){var i=this.gmx.mInPixel,n=this.gmxTilePoint,o=t*i,a=r*i,s=Math.floor(.5+o%256),l=Math.floor(.5+a%256),u=256/i,h=n.x-t/u,c=n.y-r/u,d=Math.floor(h),m=d+(h===d?0:1),f=Math.floor(c),g=f+(c===f?0:1),p=Math.floor((e.min.x-t)/u),v=Math.floor((e.max.x-t)/u),y=Math.floor((e.min.y-r)/u),x=Math.floor((e.max.y-r)/u);d<p&&(d=p),m>v&&(m=v),f<y&&(f=y),g>x&&(g=x);for(var _=[],L=f;L<=g;L++)for(var b=d;b<=m;b++)_.push({z:n.z,x:b,y:L,dx:s,dy:l,tx:h,ty:c});return _},_getItemRasters:function(e){var t,r=e.properties,i=r[0],o=this,a=this.gmx,s=a.tileAttributeIndexes,l=this.rasters,u=null,h=Number(a.shiftXfield?n.gmxAPIutils.getPropItem(a.shiftXfield,r,s):0)%this.worldWidthMerc,c=Number(a.shiftYfield?n.gmxAPIutils.getPropItem(a.shiftYfield,r,s):0),d=h||c,m=n.gmxAPIutils.getPropItem("urlBG",r,s),f="",g=null,p=!1,v=a.dataManager.getItem(i),y=this.gmxTilePoint,x=null,_=null;if(a.IsRasterCatalog&&("Raster"===a.rawProperties.type||n.gmxAPIutils.getPropItem("GMX_RasterCatalogID",r,s))?p=!0:a.quicklookBGfunc?(f=a.quicklookBGfunc(v),g=a.imageQuicklookProcessingHook):m&&(f=m,g=a.imageQuicklookProcessingHook),p)u=new L.gmx.Deferred(function(){t.forEach(function(e){e.cancel()}),t=null});else{f+=(f.indexOf("?")===-1?"?":"&")+a.sessionKey;var b=this.rasterRequests[f];b?b.options.tileRastersId=this._uniqueID:(b=L.gmx.imageLoader.push(f,{tileRastersId:o._uniqueID,crossOrigin:a.crossOrigin||"anonymous"}),this.rasterRequests[f]=b),u=new L.gmx.Deferred(function(){delete o.rasterRequests[f],b.def.cancel()}),b.def.then(u.resolve,u.reject)}var P=new L.gmx.Deferred(function(){u&&(u.cancel(),u=null)});if(p){var I=e.dataOption||{},S=d?this._getShiftTilesArray(I.bounds,h,c):[y],T=S.length,M=function(){T<1&&u.resolve()},k=function(){T--,M()},C=function(e){return a.rasterBGfunc(e.x,e.y,e.z,v)},D=function(t,r,i){v.skipRasters=!1;var s=!0;g&&(i=g(i,{gmx:a,geoItem:e,item:v,gmxTilePoint:t}),s=!1);var l={geoItem:e,image:i,destinationTilePoint:y,sourceTilePoint:t,sx:0,sy:0,sw:256,sh:256,dx:0,dy:0,dw:256,dh:256};if(d){var u=o._getShiftPixels(r);if(null===u)return void k();L.extend(l,u),s=!1}if(t.z!==y.z){var h=n.gmxAPIutils.getTilePosZoomDelta(y,y.z,t.z);if(h.size<1/256)return void M();if(s=!1,l.sx=Math.floor(h.x),l.sy=Math.floor(h.y),l.sw=l.sh=h.size,d){var c=Math.floor(l.dw/h.zDelta);l.sx=(0===l.dx?l.sw:256)-c,l.sw=c;var m=Math.floor(l.dh/h.zDelta);l.sy=(0===l.dy?l.sh:256)-m,l.sh=m}}if(s&&!a.rasterProcessingHook)T--,x=i,M();else{x||(x=document.createElement("canvas"),x.width=x.height=256),l.res=x;var f=o._rasterHook(l),p=function(){T--,r.resImage=x,M()};f?f instanceof L.gmx.Deferred&&f.then(p):null===f?(v.skipRasters=!0,k()):p()}};t=S.map(function(e){var t=o._loadTileRecursive(e,C);return t.then(function(t){D(t.gtp,e,t.image)},k),t}),u.then(function(){l[i]=x,P.resolve()})}else{v.skipRasters=!1;var A=function(t){var r={gmx:a,geoItem:e,item:v,gmxTilePoint:y};x||(x=document.createElement("canvas"),x.width=x.height=256);var n=function(t){var n=o._rasterHook({geoItem:e,res:x,image:g?g(t,r):t,destinationTilePoint:y,url:f}),a=function(){l[i]=x,P.resolve()};n?n instanceof L.gmx.Deferred&&n.then(a):null===n?(v.skipRasters=!0,P.resolve()):a()};n(t),delete o.rasterRequests[f]};_?A(_):u.then(A.bind(this),P.resolve)}return P.always(function(){u=null,t&&(t=null)}),P},_getVisibleItems:function(e){if(e.length<2)return this.itemsView=e,e;n.gmxAPIutils._tileCanvas||(n.gmxAPIutils._tileCanvas=document.createElement("canvas"),n.gmxAPIutils._tileCanvas.width=n.gmxAPIutils._tileCanvas.height=256);var t,r,i=this.gmx,o=i.dataManager,a=n.gmxAPIutils._tileCanvas,s=a.getContext("2d"),l={tbounds:this.tbounds,gmx:i,tpx:this.tpx,tpy:this.tpy,ctx:s};for(s.clearRect(0,0,256,256),s.imageSmoothingEnabled=!1,t=0,r=e.length;t<r;t++){s.fillStyle=n.gmxAPIutils.dec2rgba(t+1,1);var u=e[t];L.gmxUtil.drawGeoItem(u,o.getItem(u.properties[0]),l,{fillStyle:s.fillStyle})}var h={},c=s.getImageData(0,0,256,256).data;for(t=0,r=c.length;t<r;t+=4)if(255===c[t+3]){var d=c[t+2];c[t+1]&&(d+=c[t+1]<<8),c[t]&&(d+=c[t]<<16),d&&(h[d]=!0)}var m=[];for(var f in h){var g=e[Number(f)-1];g&&m.push(g)}return this.itemsView=m,m},_getNeedRasterItems:function(e){for(var t=this.gmx,r=t.tileAttributeIndexes,i=this.tbounds,o=[],a=0,s=e.length;a<s;a++){var l=e[a],u=l.properties,h=u[0],c=l.dataOption||{},d=!1;if(t.quicklookBGfunc&&!n.gmxAPIutils.getPropItem("GMX_RasterCatalogID",u,r)){if(t.minZoomQuicklooks&&this.zoom<t.minZoomQuicklooks)continue;var m=n.gmxAPIutils.getPropItem(t.quicklookPlatform,u,r)||t.quicklookPlatform||"";if(!(m&&"imageMercator"!==m||n.gmxAPIutils.getQuicklookPointsFromProperties(u,t)))continue}t.styleHook&&(l.styleExtend=t.styleHook(t.dataManager.getItem(h),t.lastHover&&h===t.lastHover.id),d=l.styleExtend&&l.styleExtend.skipRasters),!d&&i.intersectsWithDelta(c.bounds,-1,-1)&&o.push(l)}return this._getVisibleItems(o)},_getTileRasters:function(e){var t=[],r=new L.gmx.Deferred(function(){t.forEach(function(e){e.cancel()}),t=null}),i=this._getNeedRasterItems(e),n=i.length;if(n){var o=this,a=function(){n<1&&r.resolve()};i.forEach(function(e){var r=o._getItemRasters(e);r.then(function(){n--,a()}),t.push(r)})}else r.resolve();return r},_chkItems:function(e){var t=this.layer;if(!t._map)return null;var r=e&&e.added&&e.added.length?e.added:null;if(!r){var i=t._tiles[this.zKey];return i&&i.el&&i.el.getContext("2d").clearRect(0,0,256,256),null}return this.gmx.sortItems?t.getSortedItems(r):r},_cancelRastersPromise:function(){this.rastersPromise&&(this.rastersPromise.cancel(),this.rastersPromise=null)},drawTile:function(e){var t=this.currentDrawPromise,r=this;this._uniqueID++,t&&(this._cancelRastersPromise(),this._preRenderPromise&&this._preRenderPromise.cancel(),this._renderPromise&&this._renderPromise.cancel(),t.reject()),t=new L.gmx.Deferred(this._cancelRastersPromise.bind(this)),t.always(function(){r._drawDone(),r.currentDrawPromise=null,r.rastersPromise=null,r._preRenderPromise=null,r._renderPromise=null}),this.currentDrawPromise=t;var i=this._chkItems(e);if(!i)return t.resolve(),t;var n=this.layer.gmxGetCanvasTile(this.tilePoint),o=n.el,a=o.getContext("2d"),s=this.gmx,l={tbounds:this.tbounds,rasters:this.rasters,gmx:s,tpx:this.tpx,tpy:this.tpy,ctx:a};o.zKey=n.el._zKey=this.zKey;var u=function(){a.clearRect(0,0,256,256);var e={tpx:r.tpx,tpy:r.tpy,x:r.tilePoint.x,y:r.tilePoint.y,z:r.zoom},n=null;r._preRenderPromise=new L.gmx.Deferred,r._preRenderPromise.resolve(n),s.preRenderHooks.forEach(function(t){r._preRenderPromise=r._preRenderPromise.then(function(r){return n=r||n,n||(n=document.createElement("canvas"),n.width=n.height=256),t(n,e)})}),r._preRenderPromise.then(function(a){n=a||n,n&&(l.bgImage=n);for(var u=0,h=i.length;u<h;u++){var c=i[u],d=c.id,m=s.dataManager.getItem(d);if(m){var f=s.styleManager.getObjStyle(m),g=s.lastHover&&s.lastHover.id===c.id&&f;if(s.multiFilters)for(var p=0,v=m.multiFilters.length;p<v;p++){var y=m.multiFilters[p];L.gmxUtil.drawGeoItem(c,m,l,g?y.parsedStyleHover:y.parsedStyle,y.style)}else L.gmxUtil.drawGeoItem(c,m,l,g?m.parsedStyleHover:m.parsedStyleKeys,f);d in s._needPopups&&!s._needPopups[d]&&(s._needPopups[d]=!0)}}r.rasters={},r.layer._map&&!o.parentNode&&r.layer.appendTileToContainer(o),r._renderPromise=new L.gmx.Deferred,r._renderPromise.resolve(o),s.renderHooks.forEach(function(t){r._renderPromise=r._renderPromise.then(function(r){return o=r||o,t(o,e)})}),r._renderPromise.then(t.resolve,t.reject)},t.reject)};return this.showRaster?(this.rastersPromise=this._getTileRasters(i),this.rastersPromise.then(u,t.reject)):u(),t},destructor:function(){this._cancelRastersPromise(),this._clearCache(),this.currentDrawPromise&&this.currentDrawPromise.reject()},_drawDone:function(){for(var e in this.rasterRequests){var t=this.rasterRequests[e];this._uniqueID!==t.options.tileRastersId&&(t.remove(),delete this.rasterRequests[e])}},_clearCache:function(){for(var e in this.rasterRequests)this.rasterRequests[e].remove();this.rasterRequests={}}},t.ScreenVectorTile=i},function(e,t){"use strict";!function(){var e=1e6,t=function(e){this.all={},this.userSetSortFunc=!1,this.sortFunc=null,this.count=0,this.disabled=!1,this.layer=e,e.on("add",this.onAdd,this),e.on("remove",this.onRemove,this)};t.prototype={addToReorder:function(e,t){++this.count,this.all[e]=t?-this.count:this.count},clickFunc:function(e){if(!this.disabled){var t=e.gmx.id;this.addToReorder(t,e.originalEvent.ctrlKey),this.layer.redrawItem(t)}},sortItems:function(t,r){var i=this._objectsReorder;if(i.count>0){var n=i.all[t.id],o=i.all[r.id];if(n||o)return n=n?n+(n>0?e:-e):0,o=o?o+(o>0?e:-e):0,n-o}return i.sortFunc?i.sortFunc.call(this,t,r):0},resetSortFunc:function(){var e=this.layer,t=e._gmx,r=t.zIndexField;t.sortItems=this.sortItems,this.sortFunc=r&&!this.userSetSortFunc?function(e,t){var i=Number(e.properties[r])-Number(t.properties[r]);return i?i:e.id-t.id}:function(e,t){return e.id-t.id}},initialize:function(){var e=this.layer._gmx;this.userSetSortFunc||"polygon"!==e.GeometryType&&"linestring"!==e.GeometryType||this.resetSortFunc()},onAdd:function(){this.initialize(),this.layer.on("click",this.clickFunc,this)},onRemove:function(){this.layer.off("click",this.clickFunc,this)}},L.gmx.VectorLayer.include({_objectsReorder:null,_objectsReorderInit:function(){this._objectsReorder||(this._objectsReorder=new t(this))},getReorderArrays:function(){var e={top:[],bottom:[]};if(this._objectsReorder)for(var t=this._objectsReorder,r=Object.keys(t.all).sort(function(e,r){return t.all[e]-t.all[r]}),i=0,n=r.length;i<n;i++){var o=r[i];t.all[o]>0?e.top.push(o):e.bottom.push(o)}return e},bringToTopItem:function(e){return this._objectsReorderInit(),this._objectsReorder.addToReorder(e),this.redrawItem(e),this},bringToBottomItem:function(e){return this._objectsReorderInit(),this._objectsReorder.addToReorder(e,!0),this.redrawItem(e),this},clearReorderArrays:function(){if(this._objectsReorder){var e=this._objectsReorder;e.all={},e.count=0,this.repaint()}return this},setReorderArrays:function(e,t){this._objectsReorderInit();var r=this._objectsReorder;return r.all={},r.count=0,t.forEach(function(e){r.addToReorder(e,!0)}),e.forEach(function(e){r.addToReorder(e)}),this.repaint(),this},getSortedItems:function(e){return this._objectsReorderInit(),e.sort(L.bind(this._objectsReorder.count>0?this._gmx.sortItems:this._objectsReorder.sortFunc,this))},setSortFunc:function(e){this._objectsReorderInit();var t=this._objectsReorder;return t.sortFunc=e,t.userSetSortFunc=!!e,this._gmx.sortItems=t.sortItems,this.repaint(),this},disableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!0,this},enableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!1,this}})}()},function(e,t){"use strict";L.gmx.VectorLayer.include({bindPopup:function(e,t){var r=L.extend({maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID},t);return this._popup&&this.unbindPopup(),e instanceof L.Popup?this._popup=e:(this._popup&&!t||(this._popup=new L.Popup(r)),this._popup.setContent(e)),this._popup._initContent=e,this._popup._state="",this._popupHandlersAdded||(this.on("click",this._openClickPopup,this).on("mousemove",this._movePopup,this).on("mouseover",this._overPopup,this).on("mouseout",this._outPopup,this).on("doneDraw",this._chkNeedOpenPopup,this),this._popupHandlersAdded=!0),r&&r.popupopen&&(this._popupopen=r.popupopen),this._popup.updateLayout=this._popup._updateLayout,this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this._openClickPopup,this).off("mousemove",this._movePopup,this).off("mouseover",this._overPopup,this).off("mouseout",this._outPopup,this).off("doneDraw",this._chkNeedOpenPopup,this),this._popupopen=null,this._popupHandlersAdded=!1),this._gmx.balloonEnable=!1,this},_chkNeedOpenPopup:function(){for(var e in this._gmx._needPopups)this._gmx._needPopups[e]&&(this.addPopup(e),delete this._gmx._needPopups[e])},disablePopup:function(){return this._popupDisabled=!0,this},enablePopup:function(){return this._popupDisabled=!1,this},openPopup:function(e,t){return this._popup&&(e=e||this._latlng||this._latlngs[Math.floor(this._latlngs.length/2)],t=t||{},t.latlng=e,this._openPopup(t)),this},closePopup:function(){return this._popup&&(this._popup._close(),this.fire("popupclose",{popup:this._popup})),this},_movePopup:function(e){if("mouseover"===this._popup._state){var t=this._popup.options._gmxID||-1;t!==e.gmx.id&&this._setPopupContent(e),this._popup.setLatLng(e.latlng)}},_overPopup:function(e){var t=this._popup;t._map?this.fire("popupopen",{popup:t,gmx:this._setPopupContent(e,t)}):this._openPopup(e),"mouseover"===t._state&&t.setLatLng(e.latlng)},_outPopup:function(e){"mouseover"!==this._popup._state||e.gmx.prevId||this.closePopup()},_callBalloonHook:function(e,t){var r,i,n,o=t.getElementsByTagName("span"),a={};for(r in this._balloonHook){var s=this._balloonHook[r].hookID;for(a[r]=0,i=0,n=o.length;i<n;i++)o[i].id===s&&a[r]++}for(r in this._balloonHook){var l=this._balloonHook[r],u=l.hookID,h=!0;for(i=0,n=o.length;i<n;i++){var c=o[i];c.id===u&&(h=!1,c.id+="_"+i,l.callback(e,t,c,a))}h&&l.callback(e,t,null,a)}},_setPopupContent:function(e,t){t||(t=this._popup);var r=e.gmx||{},i=r.balloonData||{},n=L.extend({},r.properties),o=r.target||{},a=o.geometry||{},s=o.offset,l=t._initContent||i.templateBalloon||"",u=e.type,h=this.options.isGeneralized&&("mouseover"===u||"mousemove"===u),c={id:r.id,type:u,nodePoint:r.nodePoint,latlng:e.latlng,properties:n,templateBalloon:l};if("POINT"===a.type){var d=a.coordinates;c.latlng=L.Projection.Mercator.unproject({x:d[0],y:d[1]})}if(s){var m=L.Popup.prototype.options.offset;t.options.offset=[-m[0]-s[0],m[1]-s[1]]}if(this._popupopen)this._popupopen({popup:t,latlng:c.latlng,layerPoint:e.layerPoint,contentNode:t._contentNode,containerPoint:e.containerPoint,originalEvent:e.originalEvent,gmx:c});else if(!(l instanceof L.Popup)){if(!(l instanceof HTMLElement)){var f,g="",p=this._map?this._map.options:{};if(h||(f=o.geometry?[o.geometry]:r.geometries||this._gmx.dataManager.getItemGeometries(r.id)||[],c.summary=g=L.gmxUtil.getGeometriesSummary(f,p)),this._balloonHook){l||(l=gmxAPIutils.getDefaultBalloonTemplate(n));for(var v in this._balloonHook)n[v]=gmxAPIutils.parseTemplate(this._balloonHook[v].resStr,n)}l=L.gmxUtil.parseBalloonTemplate(l,{properties:n,tileAttributeTypes:this._gmx.tileAttributeTypes,unitOptions:p,summary:g,geometries:f})}var y=L.DomUtil.create("div","");y.innerHTML=l,t.setContent(y),this._balloonHook&&this._callBalloonHook(r.properties,t.getContent())}return t.options._gmxID=r.id,c},_openClickPopup:function(e){var t=e.originalEvent||{},r=!e.gmx||this._popupDisabled||t.ctrlKey||t.altKey||t.shiftKey;if(!r){var i=e.type,n=e.gmx,o=n.balloonData,a="click"===i&&o.isSummary&&!o.DisableBalloonOnClick,s=n.target;if(a&&s.options.isGeneralized&&!s.geometry){var l=n.layer.getGmxProperties();gmxAPIutils.getLayerItemFromServer({options:e,layerID:l.name,value:s.id,field:l.identityField}).then(function(e,t){if(e&&"ok"===e.Status&&e.Result){var r=e.Result.values[0];t.options.gmx.target.fromServerProps=r,t.options.gmx.target.geometry=r[r.length-1],this._openPopup(t.options)}}.bind(this))}else this._openPopup(e)}},_openPopup:function(e,t){var r=this._map,i=e.originalEvent||{},n=t?!t:this._popupDisabled||i.ctrlKey||i.altKey||i.shiftKey;if(!n){var o=e.type,a=this._popup,s=e.gmx||{},l=s.balloonData||{};if("click"===o){if(!t&&l.DisableBalloonOnClick&&!this.hasEventListeners("popupopen"))return;"_gmxPopups"in r||(r._gmxPopups=[]),"maxPopupCount"in r.options||(r.options.maxPopupCount=1),this._gmx._gmxPopupsInit||(this._gmx._gmxPopupsInit=!0,r.on({layerremove:function(e){if(e.layer instanceof L.Popup)this._clearPopup(e.layer);else if(e.layer===this){if(r._gmxPopups){var t=this._gmx.layerID;r._gmxPopups=r._gmxPopups.reduce(function(e,r){return r._map&&(r.options.layerId===t?r._map.removeLayer(r):e.push(r)),e},[])}this.closePopup()}}},this)),this._clearPopup(s.id);var u=this._popup?this._popup.options:{maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID};a=new L.Popup(L.extend({},u,{closeOnClick:1===r.options.maxPopupCount,autoPan:!0}))}else{if("mouseover"!==o)return;if(l.DisableBalloonOnMouseMove)return void(a._state="");a.options.autoPan=!1}a.options.objectId=s.id,a._state=o;var h=this._setPopupContent(e,a);if(a.setLatLng(h.latlng),this.fire("popupopen",{popup:a,gmx:h}),"click"===o&&(r._gmxPopups.length>=r.options.maxPopupCount&&r.removeLayer(r._gmxPopups.shift()),r._gmxPopups.push(a)),a.addTo(r),a._closeButton){var c=a._closeButton.style;"mouseover"===o&&"hidden"!==c?(c.visibility="hidden",a._container.style.marginBottom="7px",a._container.style.pointerEvents="none"):"click"===o&&"inherit"!==c&&(c.visibility="inherit",a._container.style.marginBottom="",a._container.style.pointerEvents="")}}},_clearPopup:function(e){var t=this._map;if(t&&t._gmxPopups){var r=this._gmx.layerID,i=e instanceof L.Popup;t._gmxPopups=t._gmxPopups.reduce(function(t,n){return n._map&&(i&&n===e?n._map.removeLayer(n):n.options.layerId===r&&n.options.objectId===e?n._map.removeLayer(n):t.push(n)),t},[])}},getPopups:function(e){var t=this._map,r=[];if(t&&t._gmxPopups){var i=this._gmx.layerID;t._gmxPopups.reduce(function(t,r){return r.options.layerId===i&&t.push(e?r:r.options.objectId),t},r)}return r},addPopup:function(e){var t=this._gmx,r=t.dataManager.getItem(e);if(r&&this._map){var i=r.bounds.getCenter(),n=L.Projection.Mercator.unproject(new L.Point(i[0],i[1]));this._openPopup({type:"click",latlng:n,gmx:this.getHoverOption(r)},!0),delete t._needPopups[e]}else t._needPopups[e]=!1;return this},addPopupHook:function(e,t){if(this._balloonHook||(this._balloonHook={}),!this._balloonHook[e]){var r="_"+L.stamp({});this._balloonHook[e]={key:e,hookID:r,resStr:'<span id="'+r+'"></span>',callback:t}}return this},removePopupHook:function(e){return this._balloonHook&&delete this._balloonHook[e],this}})},function(e,t,r){"use strict";var i=r(4);L.gmx.VectorLayer.include({_gmxFirstObjectsByPoint:function(e,t,r){for(var n,o,a=this._gmx,s=a.mInPixel,l=e.length-1;l>=0;l--){var u=e[l].properties,h=u[0],c=e[l].dataOption||{},d=a.dataManager.getItem(h),m=d.currentStyle||d.parsedStyleKeys||{},f=m.iconScale||1,g=m.iconCenter,p=!g&&m.iconAnchor?m.iconAnchor:null,v=a.styleManager.getObjStyle(d),y=m.lineWidth||v.lineWidth||0,x=y+(v.sx||m.sx||0),_=y+(v.sy||m.sy||0),L=[f*x/2,f*_/2],b=t,P=u[u.length-1],I=P.type;"POINT"===I&&"circle"===v.type&&(L[0]*=2,L[1]*=2);var S=L[0],T=i.gmxAPIutils.bounds().extendBounds(c.bounds).addBuffer(L[0]/s,L[1]/s);if(p&&(L=[p[0]-L[0],p[1]-L[1]],b=[t[0]+L[0]/s,t[1]-L[1]/s]),T.contains(b)){var M=m.fillStyle||m.canvasPattern||v.bgImage||v.fillColor,k=v&&v.image?v.image:null,C=I,D=c.hiddenLines||[],A=c.boundsArr,O=P.coordinates,w=null,F={point:t,bounds:r,coords:O,boundsArr:A};if("MULTIPOLYGON"!==I&&"POLYGON"!==I||(k?C="POINT":M||("POLYGON"===I?(C="MULTILINESTRING",D=D[0]):C="LIKEMULTILINESTRING",F.hidden=D)),"LINESTRING"===C){if(!i.gmxAPIutils.isPointInPolyLine(t,y/s,O)&&(w=i.gmxAPIutils.bounds([b]).addBuffer(L[0]/s,L[1]/s).isNodeIntersect(O),null===w))continue}else if("LIKEMULTILINESTRING"===C){F.delta=y/s;var R=!1;for(n=0,o=O.length;n<o;n++)if(F.coords=O[n],F.hidden=D?D[n]:null,F.boundsArr=A[n],i.gmxAPIutils.isPointInLines(F)){R=!0;break}if(!R)continue}else if("MULTILINESTRING"===C){if(F.delta=y/s,F.hidden=D,!i.gmxAPIutils.isPointInLines(F)){var N=i.gmxAPIutils.bounds([b]).addBuffer(L[0]/s,L[1]/s);for(n=0,o=O.length;n<o;n++)if(w=N.isNodeIntersect(O[n]),null!==w){w.ring=n;break}if(null===w)continue}}else if("MULTIPOLYGON"===C||"POLYGON"===C){var E=t;for(R=!1,"POLYGON"===C&&(O=[P.coordinates],A=[c.boundsArr]),n=0,o=O.length;n<o;n++)for(var G=O[n],z=A[n],B=0,U=G.length;B<U;B++){var j=z[B];if(j.intersects(r)&&i.gmxAPIutils.isPointInPolygonWithHoles(E,G)){R=0===B;break}}if(!R)continue}else if("POINT"===C&&"circle"===v.type){var H=(O[0]-b[0])*s,V=(O[1]-b[1])*s;if(H*H+V*V>S*S)continue}if(this.isPointInClipPolygons(t))return{id:h,properties:d.properties,geometry:P,bounds:d.bounds,nodePoint:w,offset:p?L:null,parsedStyle:v}}}return null},gmxEventCheck:function(e,t){if(!this._map)return 0;var r=this,n=r._gmx,o=e.type,a=n.lastHover,s=function(t){a&&"mousemove"===o&&(t&&r.hasEventListeners(t)&&(e.gmx=a,r.fire(t,e)),a.hoverDiff&&r.redrawItem(a.id))},l=this._map.getZoom();if((l>this.options.maxZoom||l<this.options.minZoom)&&(t=!0),t)a&&(a.prevId=null),s("mouseout"),n.lastHover=null;else if(this.hasEventListeners("mouseover")||this.hasEventListeners("mouseout")||this.hasEventListeners(o)||"mousemove"===o&&"Raster"!==n.properties.fromType){var u=e.latlng.lng%360,h=new L.LatLng(e.latlng.lat,u+(u<-180?360:u>180?-360:0)),c=L.Projection.Mercator.project(h)._subtract({x:n.shiftXlayer||0,y:n.shiftYlayer||0}),d=Math.max(5,n.styleManager._getMaxStyleSize(l))/n.mInPixel,m=[c.x,c.y],f={type:"resend",bbox:i.gmxAPIutils.bounds([m]).addBuffer(d),dateInterval:"VectorTemporal"===n.layerType?[n.beginDate,n.endDate]:null,filters:["clipFilter","userFilter_"+n.layerID,"styleFilter","userFilter"],active:!1};this.options.isGeneralized&&(f.targetZoom=l),n.dataManager.addObserver(f,"hover");var g=n.dataManager.getItems("hover");if(n.dataManager.removeObserver("hover"),g&&g.length){g.length>1&&n.sortItems&&(g=this.getSortedItems(g));var p=this._gmxFirstObjectsByPoint(g,m,f.bbox);if(p){var v=p.id,y=n.dataManager.getItem(v),x=a?a.id:null,_=!a||a.id!==v;if("mousemove"===o&&a){if(!_)return e.gmx=a,this.fire(o,e),v;s(y.currentFilter!==a.currentFilter?"mouseout":""),n.lastHover=null}return e.gmx=L.extend(this.getHoverOption(y),{targets:g,nodePoint:p.nodePoint,prevId:x,hoverDiff:y.hoverDiff}),this.hasEventListeners(o)&&this.fire(o,e),"mousemove"===o&&_&&(a=n.lastHover=e.gmx,s("mouseover"),n.lastMouseover=n.lastHover),this._map.doubleClickZoom.disable(),v}}}return this._map&&this._map.doubleClickZoom.enable(),0},getHoverOption:function(e){return{layer:this,target:e,balloonData:this._gmx.styleManager.getItemBalloon(e.id),properties:this.getItemProperties(e.properties),currentFilter:e.currentFilter||0,id:e.id}}})},function(e,t,r){"use strict";var i=r(4);!function(){var e=2e4,t={},r={},n="/Layer/CheckVersion.ashx",o=null,a=null,s="",l=function(e){var t=e.Temporal?"TemporalTiles":"tiles";return t in e},u=function(e,t,r){var i={Name:e.name,Version:l(e)?e.LayerVersion:-1};if(t&&(e.UseTiles===!1||"NotVisible"===window.gmxSkipTiles)){var n=t.getMaxDateInterval(),o=n.beginDate||r.beginDate,a=n.endDate||r.endDate;o&&(i.dateBegin=Math.floor(o.getTime()/1e3)),a&&(i.dateEnd=Math.floor(a.getTime()/1e3))}return i},h=function(e){var r,i,n,o,a={};if(e)e instanceof L.gmx.DataManager?(n=e,r=n.options):(r=e._gmx.properties,n=e._gmx.dataManager,o=e._gmx),i=r.hostName||e._gmx.hostName,a[i]=[u(r,n,o)];else{var s={};for(var l in t){var h=t[l],c=h instanceof L.gmx.DataManager;if(h.options.chkUpdate||c){n=c?h:h._gmx.dataManager,r=c?h.options:h._gmx.properties,o=c?h:h._gmx,i=r.hostName||h._gmx.hostName;var d=u(r,n,o),m=d.Name+d.Version;s[m]||(a[i]?a[i].push(d):a[i]=[d]),s[m]=!0}}}return a},c=function(e,r){var o=function(i){if(i&&"ok"===i.Status&&i.Result)for(var n=0,o=i.Result.length;n<o;n++){var a=i.Result[n],l=a.properties.name;e&&e._gmx.properties.name===l&&"updateVersion"in e&&e.updateVersion(a);for(var u in t){var h=t[u];e&&e===h||(h._gmx&&h._gmx.properties.name===l&&"updateVersion"in h?h.updateVersion(a):h instanceof L.gmx.DataManager&&h.options.name===l&&h.updateVersion(a.properties))}}s="",r&&r(i)};if(document.body&&!i.gmxAPIutils.isPageHidden()){var a=h(e),l=function(e){var r="http://"+e+n,l=JSON.stringify(a[e]);if(s!==l){s=l,"FormData"in window?i.gmxAPIutils.request({url:r,async:!0,headers:{"Content-type":"application/x-www-form-urlencoded"},type:"POST",params:"WrapStyle=None&layers="+encodeURIComponent(l),withCredentials:!0,callback:function(e){o(JSON.parse(e))},onError:function(e){console.log("Error: LayerVersion ",e)}}):i.gmxAPIutils.sendCrossDomainPostRequest(r,{WrapStyle:"message",layers:l},o);var u=Date.now();for(var h in t){var c=t[h],d=c._gmx||c.options;d.hostName===e&&(d._stampVersionRequest=u)}}};for(var u in a)l(u)}},d={addDataManager:function(e){var r=e.options.name;r in t||(e.on("chkLayerUpdate",c.bind(e)),t[r]=e)},removeDataManager:function(e){var r=e.options.name;r in t&&(e.off("chkLayerUpdate",c.bind(e)),delete t[r])},remove:function(e){delete t[e._leaflet_id];var i=e._gmx,n=e.options.parentOptions;if(n){var o=n.name;r[o]&&(delete r[o][i.properties.name],Object.keys(r[o]).length||(d.removeDataManager(i.dataManager),delete r[o]))}else i.dataManager.off("chkLayerUpdate",i._chkVersion)},add:function(e){var i=e._leaflet_id;if(!(i in t)){var n=e._gmx,o=n.properties;if("LayerVersion"in o){t[i]=e,n._chkVersion=function(){c(e)},n.dataManager.on("chkLayerUpdate",n._chkVersion);var a=e.options.parentOptions;if(a){var s=a.name;d.addDataManager(n.dataManager),r[s]||(r[s]={}),r[s][o.name]=e}d.start(),(!n._stampVersionRequest||n._stampVersionRequest<Date.now()-19e3||!l(o))&&d.now()}}},chkVersion:c,now:function(){a&&clearTimeout(a),a=setTimeout(c,0)},stop:function(){o&&clearInterval(o),o=null},start:function(t){t&&(e=t),d.stop(),o=setInterval(c,e)}};L.gmx||(L.gmx={}),L.gmx.layersVersion=d,L.gmx.VectorLayer.include({updateVersion:function(e){if(e){var t=this._gmx;e.geometry&&(t.geometry=e.geometry),e.properties&&(L.extend(t.properties,e.properties),t.properties.GeoProcessing=e.properties.GeoProcessing,t.rawProperties=t.properties,this.fire("versionchange"),t.dataSource||t.dataManager.updateVersion(t.rawProperties))}}})}()},function(e,t){"use strict";L.gmx.RasterLayer=L.gmx.VectorLayer.extend({options:{isGeneralized:!1,zIndexOffset:0},initFromDescription:function(e){var t=e.properties,r=t.styles[0]||{MinZoom:t.MinZoom||0,MaxZoom:t.MaxZoom||21},i={type:"Vector",fromType:t.type,identityField:"ogc_fid",GeometryType:"POLYGON",IsRasterCatalog:!0,Copyright:t.Copyright||"",RCMinZoomForRasters:r.MinZoom,visible:t.visible,styles:[{DisableBalloonOnClick:!0,MinZoom:r.MinZoom,MaxZoom:r.MaxZoom,RenderStyle:{outline:{thickness:0},fill:{opacity:100}},HoverStyle:null}]},n=this._gmx,o=gmxAPIutils.tileSizes[1];t.MaxZoom&&(n.maxNativeZoom=t.MaxZoom),e.geometry||(e.geometry={type:"POLYGON",coordinates:[[[-o,-o],[-o,o],[o,o],[o,-o],[-o,-o]]]}),L.gmx.VectorLayer.prototype.initFromDescription.call(this,{geometry:e.geometry,properties:i,rawProperties:e.properties}),n.rasterBGfunc=function(e,t,r){return"http://"+n.hostName+"/TileSender.ashx?ModeKey=tile&key="+encodeURIComponent(n.sessionKey)+"&LayerName="+n.layerID+"&z="+r+"&x="+e+"&y="+t};var a={load:function(t,r,i,n,a,s,l){var u=[[777,e.geometry]],h=gmxAPIutils.geoItemBounds(e.geometry),c=h.bounds;if(c.max.x>o){var d=2*o,m=777,f=e.geometry.coordinates,g=h.boundsArr;u=[],"POLYGON"===e.geometry.type&&(f=[f],g=[g]);for(var p=0,v=f.length;p<v;p++){var y=f[p],x=g[p][0],_=y;if(u.push([m++,{type:"POLYGON",coordinates:_}]),x.max.x>o){_=[];for(var L=0,b=y.length;L<b;L++){for(var P=y[L],I=0,S=[],T=P.length;I<T;I++){var M=P[I];S.push([M[0]-d,M[1]])}_.push(S)}u.push([m++,{type:"POLYGON",coordinates:_}])}}}l(u,[c.min.x,c.min.y,c.max.x,c.max.y])}};return n.dataManager._rasterVectorTile=new VectorTile(a,{x:-.5,y:-.5,z:0,v:0,s:-2,d:-2}),n.dataManager.addTile(n.dataManager._rasterVectorTile),this},setZoomBounds:function(e,t){var r=this.getStyles().slice(0);r[0]=L.extend({},r[0]),r[0].MinZoom=e,r[0].MaxZoom=t,this.setStyles(r)}})},function(e,t,r){"use strict";var i=r(4);L.LabelsLayer=L.Class.extend({options:{pane:"overlayPane"},initialize:function(e,t){L.setOptions(this,t),this._observers={},
this._styleManagers={},this._labels={};var r=this;this.bbox=i.gmxAPIutils.bounds();var n=function(t,n){if(t.added||t.removed){for(var o=n.options,a=e._zoom>=o.minZoom&&e._zoom<=o.maxZoom?t.added:[],s="_"+n._leaflet_id,l=n._gmx,u={},h=0,c=a.length;h<c;h++){var d=a[h].item,m="POINT"===d.type||"MULTIPOINT"===d.type,f=d.parsedStyleKeys||d.currentStyle||{};if(l.styleHook){var g=l.styleHook(d,l.lastHover&&d.id===l.lastHover.id);if(!g)continue;f=L.extend({},f,g)}if(d.multiFilters)for(var p=0,v=d.multiFilters.length;p<v;p++){var y=d.multiFilters[p].parsedStyle;if("labelField"in y||"labelText"in y){f=y;break}}var x=l.styleManager.getObjStyle(d)||{},_=f.labelText||x.labelText,b=f.labelField||x.labelField,P=l.tileAttributeTypes[b],I=String(_||L.gmxUtil.attrToString(P,n.getPropItem(b,d.properties)));if(x.labelTemplate){var S,T=/\[([^\]]*)\]/g;for(I=x.labelTemplate;S=T.exec(x.labelTemplate);)if(2===S.length){b=S[1],P=l.tileAttributeTypes[b];var M=L.gmxUtil.attrToString(P,n.getPropItem(b,d.properties));I=I.replace(S[0],M)}}if(I||0===I){var k,C=f.labelFontSize||x.labelFontSize||12,D="_"+d.id,A=!0,O=0,w=d.options,F={font:C+'px "Arial"',labelHaloColor:"labelHaloColor"in f?f.labelHaloColor:"labelHaloColor"in x?x.labelHaloColor:16777215,labelColor:f.labelColor||x.labelColor,labelAlign:f.labelAlign||x.labelAlign,labelAnchor:f.labelAnchor||x.labelAnchor,labelFontSize:C};if(w){if(!("center"in w)){var R=i.gmxAPIutils.getItemCenter(d,l.dataManager.getItemMembers(d.id));if(!R)continue;w.center=R}if(w.label){O=w.label.width,k=w.label.arrTxtWidth;var N=w.label.style;A=w.label.txt!==I||N.labelHaloColor!==F.labelHaloColor||N.labelColor!==F.labelColor||N.labelAlign!==F.labelAlign||N.labelAnchor!==F.labelAnchor||N.labelFontSize!==F.labelFontSize}}if(A){if(O=0,k=i.gmxAPIutils.getLabelWidth(I,F),k&&k.forEach(function(e){O=Math.max(O,e[1])}),!O){delete u[D];continue}O+=4,d.options.labelStyle=null}w.label={isPoint:m,width:O,sx:x.sx||0,txt:I,arrTxtWidth:k,style:F},u[D]=d}}r._labels[s]=u}},o=function(e){var t=e._gmx,i=["styleFilter","userFilter"],o={type:"resend",bbox:r.bbox,filters:i,callback:function(t){n(t,e),r.redraw()}};return t.beginDate&&t.endDate&&(o.dateInterval=[t.beginDate,t.endDate]),t.dataManager.addObserver(o,"_Labels")};this.add=function(e){var t=e._leaflet_id,i=e._gmx;!r._observers[t]&&i&&i.labelsLayer&&t&&i.styleManager.deferred.then(function(){var n=o(e),a=r._map._zoom;e.options.isGeneralized&&(n.targetZoom=a),i.styleManager.isVisibleAtZoom(a)||n.deactivate(),r._observers[t]=n,r._styleManagers[t]=i.styleManager,r._labels["_"+t]={},r._updateBbox()})},this.remove=function(e){var t=e._leaflet_id;if(r._observers[t]){var i=e._gmx,n=i.dataManager;n.removeObserver(r._observers[t].id),delete r._observers[t],delete r._styleManagers[t],delete r._labels["_"+t],r.redraw()}},this._layeradd=function(e){r.add(e.layer)},this._layerremove=function(e){r.remove(e.layer)}},redraw:function(){return this._frame||this._map._animating||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},_addToPane:function(){var e=this._map.getPanes()[this.options.pane];e&&e.insertBefore(this._canvas,e.firstChild)},onAdd:function(e){this._map=e,this._canvas||this._initCanvas(),e.on("moveend",this._reset,this),e.on({layeradd:this._layeradd,layerremove:this._layerremove}),e.options.zoomAnimation&&L.Browser.any3d&&e.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(e){this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),e.off("moveend",this._reset,this),e.off("layeradd",this._layeradd),e.off("layerremove",this._layerremove),e.options.zoomAnimation&&e.off("zoomanim",this._animateZoom,this)},addTo:function(e){return e.addLayer(this),this},_initCanvas:function(){var e=L.DomUtil.create("canvas","leaflet-labels-layer leaflet-layer"),t=this._map.getSize();e.width=t.x,e.height=t.y,e.style.pointerEvents="none",this._canvas=e;var r=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(e,"leaflet-zoom-"+(r?"animated":"hide"))},_updateBbox:function(){var e=this._map,t=e.getBounds(),r=t.getSouthWest(),n=t.getNorthEast(),o=L.Projection.Mercator.project(r),a=L.Projection.Mercator.project(n),s=e.getZoom();this.mInPixel=i.gmxAPIutils.getPixelScale(s),this._ctxShift=[o.x*this.mInPixel,a.y*this.mInPixel];for(var l in this._observers){var u=this._observers[l];u.targetZoom&&(u.targetZoom=s),u.setBounds({min:{x:r.lng,y:r.lat},max:{x:n.lng,y:n.lat}})}},_reset:function(){this._updateBbox();for(var e in this._observers){var t=this._observers[e];!t.isActive()&&this._styleManagers[e].isVisibleAtZoom(this._map.getZoom())&&t.activate(),t.fire("update")}},_redraw:function(){var e=[],t=this._map,r=t.getSize(),n=this._canvas,o=t.latLngToContainerPoint(t.getBounds().getNorthWest()),a=t.containerPointToLayerPoint(o);n.width=r.x,n.height=r.y,L.DomUtil.setPosition(n,a);var s,l,u,h=2*this.mInPixel*i.gmxAPIutils.worldWidthMerc,c=h*Math.floor(t.getPixelBounds().min.x/h),d=n.getContext("2d");for(var m in this._labels){var f=this._labels[m];for(var g in f){u=f[g];var p=u.options,v=p.label,y=v.style,x=y.labelAlign||"center",_=v.arrTxtWidth,b=_.length||1,P=v.width,I=P/2,S=y.labelFontSize||12,T=S/2,M=p.center,k=[M[0]*this.mInPixel,M[1]*this.mInPixel],C=!1;if(v.isPoint){var D=v.sx;"left"===x?k[0]+=I+D:"right"===x&&(k[0]-=P+D)}k[0]-=I+this._ctxShift[0],k[1]=-T-k[1]+this._ctxShift[1],T*=b,y.labelAnchor&&(k[0]+=y.labelAnchor[0],k[1]+=y.labelAnchor[1]);for(var A=k[0]+c;A<r.x;A+=h){var O=[Math.floor(A),Math.floor(k[1])],w=i.gmxAPIutils.bounds([[O[0]-I,O[1]-T],[O[0]+I,O[1]+T]]);for(s=0,l=e.length;s<l;s++)if(w.intersects(e[s].bbox)){C=!0;break}C||(p.labelStyle||(p.labelStyle={font:S+'px "Arial"',fillStyle:i.gmxAPIutils.dec2color(y.labelColor||0,1),shadowBlur:4},y.labelHaloColor!==-1&&(p.labelStyle.strokeStyle=p.labelStyle.shadowColor=i.gmxAPIutils.dec2color(y.labelHaloColor,1))),e.push({arr:u.properties,bbox:w,arrTxtWidth:_,width2:"center"===x?I:0,txt:v.txt,style:p.labelStyle,size:S,coord:O}))}}}if(e.length){for(d.clearRect(0,0,n.width,n.height),s=0,l=e.length;s<l;s++)u=e[s],u.arrTxtWidth.forEach(function(e,t){var r=[u.coord[0]+u.width2-e[1]/2,u.coord[1]+t*u.size];i.gmxAPIutils.setLabel(d,e[0],r,u.style)});n.parentNode||this._addToPane()}else n.parentNode&&n.parentNode.removeChild(n);this._frame=null},_animateZoom:function(e){var t=this._map.getZoomScale(e.zoom),r=this._map.getPixelBounds().min,i=this._map._getCenterOffset(e.center)._multiplyBy(-t).subtract(this._map._getMapPanePos());r.y<0&&(i.y+=r.multiplyBy(-t).y),this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(i)+" scale("+t+")"}}),L.labelsLayer=function(e,t){return new L.LabelsLayer(e,t)},L.Map.addInitHook(function(){this._labelsLayer||(this._labelsLayer=new L.LabelsLayer(this),this._labelsLayer.addTo(this))})},function(e,t){"use strict";!function(){var e=function(e,t){for(var r in t)for(var i=t[r],n=0,o=i.length;n<o;n++)for(var a=i[n],s=a.geometry.type,l=a.boundsArr,u=0,h=l.length;u<h;u++){var c=l[u];"Polygon"===s&&(c=[c]);for(var d=0,m=c.length;d<m;d++)if(c[d].intersects(e))return!0}return!1},t=function(e,t){for(var r in t)for(var i=t[r],n=0,o=i.length;n<o;n++)for(var a=i[n],s=a.geometry.type,l=a.boundsArr,u=0,h=l.length;u<h;u++){var c=l[u];"Polygon"===s&&(c=[c]);for(var d=0,m=c.length;d<m;d++)if(e.intersects(c[d]))return!0}return!1},r=function(e,t){if(!t||0===Object.keys(t).length)return!0;for(var r in t)for(var i=t[r],n=0,o=i.length;n<o;n++)for(var a=i[n],s=a.geometry.type,l=a.boundsArr,u=0,h=l.length;u<h;u++){var c=l[u];"Polygon"===s&&(c=[c]);for(var d=0,m=c.length;d<m;d++)if(c[d].contains(e)){var f=a.geometry.coordinates,g=!1;"Polygon"===s&&(f=[f]);for(var p=0,v=f.length;p<v;p++)if(gmxAPIutils.isPointInPolygonWithHoles(e,f[p])){g=!0;break}if(g)return!0}}return!1},i=function(e){var t=gmxAPIutils.convertGeometry(e),r=gmxAPIutils.geoItemBounds(t);return r.geometry=t,r},n=function(e){var t=document.createElement("canvas");t.width=t.height=256;var r=t.getContext("2d"),i=e.clipPolygons;e.ctx=r,r.fillStyle=r.createPattern(e.tile,"no-repeat");for(var n in i)for(var o=i[n],a=0,s=o.length;a<s;a++){var l=o[a].geometry,u=l.coordinates;"Polygon"===l.type&&(u=[u]);for(var h=0,c=u.length;h<c;h++){var d=u[h];r.beginPath();for(var m=0,f=d.length;m<f;m++){e.coords=d[m];var g=gmxAPIutils.getRingPixels(e);e.coords=g.coords,gmxAPIutils.polygonToCanvasFill(e)}r.closePath(),r.fill()}}r=e.tile.getContext("2d"),r.clearRect(0,0,256,256),r.drawImage(t,0,0)};L.gmx.VectorLayer.include({isPointInClipPolygons:function(e){return r(e,this._gmx._clipPolygons)},addClipPolygon:function(o){var a,s,l=[];if("coordinates"in o&&"type"in o)l.push(i(o));else if(o instanceof L.Polygon)l.push(i(o.toGeoJSON().geometry));else if(o instanceof L.GeoJSON){var u=o.getLayers();for(a=0,s=u.length;a<s;a++){var h=u[a];h instanceof L.Polygon&&h.feature?l.push(i(h.feature.geometry)):h instanceof L.MultiPolygon&&h.feature&&l.push(i(h.feature.geometry))}}if(l.length){var c=this._gmx,d=c.dataManager,m=this,f=L.stamp(o);this._gmx._clipPolygons||(this._gmx._clipPolygons={}),this._gmx._clipPolygons[f]=l,d.setTileFilteringHook(function(t){return e(t.bounds,m._gmx._clipPolygons)}),d.addFilter("clipFilter",function(e,r,i){return t(i,m._gmx._clipPolygons)}),d.addFilter("clipPointsFilter",function(e){if("POINT"===e.type){var t=e.properties,i=t[t.length-1];return r(i.coordinates,m._gmx._clipPolygons)}return!0}),1===Object.keys(this._gmx._clipPolygons).length&&c.renderHooks.unshift(function(e,t){e&&Object.keys(m._gmx._clipPolygons).length>0&&n({tile:e,tpx:t.tpx,tpy:t.tpy,gmx:{mInPixel:c.mInPixel},clipPolygons:m._gmx._clipPolygons})})}return this},removeClipPolygon:function(e){var t=L.stamp(e);return this._gmx._clipPolygons&&(delete this._gmx._clipPolygons[t],0===Object.keys(this._gmx._clipPolygons).length&&(this._gmx.dataManager.removeTileFilteringHook(),this._gmx.dataManager.removeFilter("clipFilter"))),this}})}()},function(e,t){"use strict";L.gmx.gmxImageTransform=function(e,t){var r=t.gmx,i=t.gmxTilePoint,n=r.mInPixel,o=t.geoItem,a=o.properties,s=o.dataOption||{},l=r.tileAttributeIndexes,u=a[l[r.quicklookPlatform]]||r.quicklookPlatform||"",h={};"LANDSAT8"===u?(h.x1=s.bounds.min.x,h.y1=s.bounds.max.y,h.x2=s.bounds.max.x,h.y2=s.bounds.max.y,h.x3=s.bounds.max.x,h.y3=s.bounds.min.y,h.x4=s.bounds.min.x,h.y4=s.bounds.min.y):h=gmxAPIutils.getQuicklookPointsFromProperties(a,r);var c=n*h.x1,d=n*h.y1,m=n*h.x2,f=n*h.y2,g=n*h.x3,p=n*h.y3,v=n*h.x4,y=n*h.y4,x=gmxAPIutils.bounds([[c,d],[m,f],[g,p],[v,y]]),_=Math.round(x.max.x-x.min.x),b=Math.round(x.max.y-x.min.y),P=256-x.max.y+256*i.y,I=o.item.bounds,S=gmxAPIutils.worldWidthMerc,T=i.x;T<0&&I.max.x>S&&I.min.x<-S&&(T+=Math.round(S*n/128));var M=x.min.x-256*T;c-=x.min.x,d=x.max.y-d,m-=x.min.x,f=x.max.y-f,g-=x.min.x,p=x.max.y-p,v-=x.min.x,y=x.max.y-y;var k=[[c,d],[m,f],[g,p],[v,y]];r.ProjectiveImage||(r.ProjectiveImage=(r.useWebGL?L.gmx.projectiveImageWebGL():null)||L.gmx.projectiveImage());var C=r.ProjectiveImage.getCanvas({imageObj:e,points:k,wView:_,hView:b,deltaX:M,deltaY:P});return C.canvas}},function(e,t){"use strict";!function(){function e(e){return[e[4]*e[8]-e[5]*e[7],e[2]*e[7]-e[1]*e[8],e[1]*e[5]-e[2]*e[4],e[5]*e[6]-e[3]*e[8],e[0]*e[8]-e[2]*e[6],e[2]*e[3]-e[0]*e[5],e[3]*e[7]-e[4]*e[6],e[1]*e[6]-e[0]*e[7],e[0]*e[4]-e[1]*e[3]]}function t(e,t){for(var r=Array(9),i=0;3!==i;++i)for(var n=0;3!==n;++n){for(var o=0,a=0;3!==a;++a)o+=e[3*i+a]*t[3*a+n];r[3*i+n]=o}return r}function r(e,t){return[e[0]*t[0]+e[1]*t[1]+e[2]*t[2],e[3]*t[0]+e[4]*t[1]+e[5]*t[2],e[6]*t[0]+e[7]*t[1]+e[8]*t[2]]}function i(i){var n=[i[0],i[2],i[4],i[1],i[3],i[5],1,1,1],o=r(e(n),[i[6],i[7],1]);return t(n,[o[0],0,0,0,o[1],0,0,0,o[2]])}var n=L.Class.extend({options:{antialias:!0,depth:!1,preserveDrawingBuffer:!0,shaderVS:"attribute vec2 aVertCoord;\t            uniform mat4 uTransformMatrix;\t            varying vec2 vTextureCoord;\t            void main(void) {\t                vTextureCoord = aVertCoord;\t                gl_Position = uTransformMatrix * vec4(aVertCoord, 0.0, 1.0);\t            }\t        ",shaderFS:"precision mediump float;\t            varying vec2 vTextureCoord;\t            uniform sampler2D uSampler;\t            void main(void) {\t                gl_FragColor = texture2D(uSampler, vTextureCoord);\t            }\t        "},setOptions:function(e){L.setOptions(this,e)},initialize:function(e){this.setOptions(e);var t=document.createElement("canvas"),r={antialias:this.options.antialias,depth:this.options.depth,preserveDrawingBuffer:this.options.preserveDrawingBuffer},i=t.getContext("webgl",r)||t.getContext("experimental-webgl",r);if(i){var n=this._setupGlContext(i);n&&(t.width=t.height=256,n.canvas=t,this.glResources=n,this.canvas=t,this.gl=i)}},_getShader:function(e,t,r){var i=r.createShader(e);return r.shaderSource(i,t),r.compileShader(i),r.getShaderParameter(i,r.COMPILE_STATUS)?i:(r.deleteShader(i),null)},_setupGlContext:function(e){var t=this._getShader(e.VERTEX_SHADER,this.options.shaderVS,e),r=this._getShader(e.FRAGMENT_SHADER,this.options.shaderFS,e);if(t&&r){var i=e.createProgram();if(e.attachShader(i,t),e.attachShader(i,r),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)){e.useProgram(i),this.vertices=new Float32Array([0,0,1,0,0,1,1,1]);var n=e.createBuffer(),o=e.getAttribLocation(i,"aVertCoord");return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),{transMatUniform:e.getUniformLocation(i,"uTransformMatrix"),samplerUniform:e.getUniformLocation(i,"uSampler"),screenTexture:e.createTexture()}}}return null},_bindTexture:function(e,t,r){e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null)},getCanvas:function(e){var t=e.points,r=e.deltaX,i=e.deltaY,o=new Float32Array([(t[0][0]+r)/128-1,1-(t[0][1]+i)/128,(t[1][0]+r)/128-1,1-(t[1][1]+i)/128,(t[3][0]+r)/128-1,1-(t[3][1]+i)/128,(t[2][0]+r)/128-1,1-(t[2][1]+i)/128]),a=n.Utils.general2DProjection(this.vertices,o),s=this.gl,l=this.glResources;return this._bindTexture(s,e.imageObj,l.screenTexture),s.viewport(0,0,256,256),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.uniformMatrix4fv(l.transMatUniform,!1,[a[0],a[3],0,a[6],a[1],a[4],0,a[7],0,0,1,0,a[2],a[5],0,1]),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,l.screenTexture),s.uniform1i(l.samplerUniform,0),s.drawArrays(s.TRIANGLE_STRIP,0,4),this}});n.Utils={general2DProjection:function(r,n){var o=t(i(n),e(i(r)));if(o[8])for(var a=0;9!==a;++a)o[a]=o[a]/o[8];return o},getWebGlResources:function(e){var t=new n(e);return t.gl?t:null}},L.gmx.projectiveImageWebGL=function(e){var t=new n(e);return t.gl?t:null}}()},function(e,t){"use strict";!function(){var e=function(){var e=0,t=4,r=64,i=null,n=function(e,t){for(var r=[],i=0;i<t;++i){r[i]=[];for(var n=0;n<e;++n)r[i][n]=0}return r},o=function(e,t,r){this.w=e,this.h=t,this.values=r||n(t)},a=function(e){for(var t=[],r=0;r<e.length;++r)t[r]=[].concat(e[r]);return t};o.prototype={add:function(e){if(e.w!==this.w||e.h!==this.h)throw new Error("Matrix add size mismatch");for(var t=n(this.w,this.h),r=0;r<this.h;++r)for(var i=0;i<this.w;++i)t[r][i]=this.values[r][i]+e.values[r][i];return new o(this.w,this.h,t)},transformProjectiveVector:function(e){var t,r,i=[];for(r=0;r<this.h;++r)for(i[r]=0,t=0;t<this.w;++t)i[r]+=this.values[r][t]*e[t];var n=i[i.length-1];if(n){var o=1/i[i.length-1];for(r=0;r<this.h;++r)i[r]*=o}return i},multiply:function(e){var t,r,i;if(+e!==e){if(e.h!==this.w)throw new Error("Matrix mult size mismatch");for(t=n(this.w,this.h),i=0;i<this.h;++i)for(r=0;r<e.w;++r){for(var a=0,s=0;s<this.w;s++)a+=this.values[i][s]*e.values[s][r];t[i][r]=a}return new o(e.w,this.h,t)}for(t=n(this.w,this.h),i=0;i<this.h;++i)for(r=0;r<this.w;++r)t[i][r]=this.values[i][r]*e;return new o(this.w,this.h,t)},rowEchelon:function(){if(this.w<=this.h)throw new Error("Matrix rowEchelon size mismatch");for(var e=a(this.values),t=0;t<this.h;++t){for(var r=e[t][t];0===r;){for(var i=t+1;i<this.h;++i)if(0!==e[i][t]){var n=e[i];e[i]=e[t],e[t]=n;break}if(i===this.h)return new o(this.w,this.h,e);r=e[t][t]}for(var s=1/r,l=t;l<this.w;++l)e[t][l]*=s;for(var u=0;u<this.h;++u)if(u!==t){var h=e[u][t];for(e[u][t]=0,l=t+1;l<this.w;++l)e[u][l]-=h*e[t][l]}}return new o(this.w,this.h,e)},invert:function(){var e,t;if(this.w!==this.h)throw new Error("Matrix invert size mismatch");var r=n(2*this.w,this.h);for(t=0;t<this.h;++t)for(e=0;e<this.w;++e)r[t][e]=this.values[t][e],r[t][e+this.w]=e===t?1:0;r=new o(2*this.w,this.h,r),r=r.rowEchelon();var i=n(this.w,this.h);for(t=0;t<this.w;++t)for(e=0;e<this.w;++e)i[t][e]=r.values[t][e+this.w];return new o(this.w,this.h,i)}};var s=function(e){var t=new o(9,8,[[1,1,1,0,0,0,-e[2][0],-e[2][0],-e[2][0]],[0,1,1,0,0,0,0,-e[3][0],-e[3][0]],[1,0,1,0,0,0,-e[1][0],0,-e[1][0]],[0,0,1,0,0,0,0,0,-e[0][0]],[0,0,0,-1,-1,-1,e[2][1],e[2][1],e[2][1]],[0,0,0,0,-1,-1,0,e[3][1],e[3][1]],[0,0,0,-1,0,-1,e[1][1],0,e[1][1]],[0,0,0,0,0,-1,0,0,e[0][1]]]),r=t.rowEchelon().values,i=new o(3,3,[[-r[0][8],-r[1][8],-r[2][8]],[-r[3][8],-r[4][8],-r[5][8]],[-r[6][8],-r[7][8],1]]);return i},l=function t(n,o,a,s,l,u,h,c,d,m){if(d){var f=[u[0]+h[0]-2*l[0],u[1]+h[1]-2*l[1]],g=[u[0]+h[0]-2*c[0],u[1]+h[1]-2*c[1]],p=[f[0]+g[0],f[1]+g[1]],v=Math.abs((p[0]*p[0]+p[1]*p[1])/(f[0]*g[0]+f[1]*g[1]));f=[u[0]-l[0]+c[0]-h[0],u[1]-l[1]+c[1]-h[1]],g=[h[0]-l[0]+c[0]-u[0],h[1]-l[1]+c[1]-u[1]];var y=Math.abs(f[0]*g[1]-f[1]*g[0]);if(0===n&&1===a||(.25+5*v)*y>r*r){var x=(n+a)/2,_=(o+s)/2,L=i.transformProjectiveVector([x,_,1]),b=i.transformProjectiveVector([x,o,1]),P=i.transformProjectiveVector([x,s,1]),I=i.transformProjectiveVector([n,_,1]),S=i.transformProjectiveVector([a,_,1]);return d--,t.call(this,n,o,x,_,l,b,I,L,d,m),t.call(this,x,o,a,_,b,u,L,S,d,m),t.call(this,n,_,x,s,I,L,h,P,d,m),void t.call(this,x,_,a,s,L,S,P,c,d,m)}}var T=m.ctx,M=[u[0]-l[0],u[1]-l[1]],k=[c[0]-u[0],c[1]-u[1]],C=[h[0]-c[0],h[1]-c[1]],D=[l[0]-h[0],l[1]-h[1]],A=Math.abs(M[0]*D[1]-M[1]*D[0]),O=Math.abs(k[0]*M[1]-k[1]*M[0]),w=Math.abs(C[0]*k[1]-C[1]*k[0]),F=Math.abs(D[0]*C[1]-D[1]*C[0]),R=Math.max(Math.max(A,O),Math.max(F,w)),N=0,E=0,G=0,z=0;R===A?(T.setTransform(M[0],M[1],-D[0],-D[1],l[0]+m.deltaX,l[1]+m.deltaY),1!==a&&(G=1.05/Math.sqrt(M[0]*M[0]+M[1]*M[1])),1!==s&&(z=1.05/Math.sqrt(D[0]*D[0]+D[1]*D[1]))):R===O?(T.setTransform(M[0],M[1],k[0],k[1],u[0]+m.deltaX,u[1]+m.deltaY),1!==a&&(G=1.05/Math.sqrt(M[0]*M[0]+M[1]*M[1])),1!==s&&(z=1.05/Math.sqrt(k[0]*k[0]+k[1]*k[1])),N=-1):R===w?(T.setTransform(-C[0],-C[1],k[0],k[1],c[0]+m.deltaX,c[1]+m.deltaY),1!==a&&(G=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==s&&(z=1.05/Math.sqrt(k[0]*k[0]+k[1]*k[1])),N=-1,E=-1):R===F&&(T.setTransform(-C[0],-C[1],-D[0],-D[1],h[0]+m.deltaX,h[1]+m.deltaY),1!==a&&(G=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==s&&(z=1.05/Math.sqrt(D[0]*D[0]+D[1]*D[1])),E=-1);var B=a-n,U=s-o;G++,z++;var j=m.imageObj.width,H=m.imageObj.height,V=Math.floor(n*j),q=Math.floor(o*H),Z=Math.floor(Math.min(G*B,1)*j),K=Math.floor(Math.min(z*U,1)*H);e++,T.drawImage(m.imageObj,V,q,Z,K,N,E,G,z)};this.getCanvas=function(n){e=0,i=s(n.points);var o=i.transformProjectiveVector([0,0,1]),a=i.transformProjectiveVector([1,0,1]),u=i.transformProjectiveVector([0,1,1]),h=i.transformProjectiveVector([1,1,1]),c=document.createElement("canvas");c.width=c.height=256,n.canvas=c,n.ctx=c.getContext("2d");var d=gmxAPIutils.bounds([o,a,h,u]),m=Math.max(d.max.x-d.min.x,d.max.y-d.min.y);t="limit"in n?n.limit:m<200?1:4,r="patchSize"in n?n.patchSize:m/8;try{l(0,0,1,1,o,a,u,h,t,n)}catch(e){console.log("Error: ProjectiveImage event:",e),c=null}return{canvas:c,ptl:o,ptr:a,pbl:u,pbr:h,cnt:e}}};L.gmx.projectiveImage=function(){return new e}}()},function(e,t){"use strict";L.RotatedMarker=L.Marker.extend({options:{angle:0},statics:{TRANSFORM_ORIGIN:L.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"])},_initIcon:function(){L.Marker.prototype._initIcon.call(this),this._icon.style[L.RotatedMarker.TRANSFORM_ORIGIN]=this._getTransformOrigin()},_getTransformOrigin:function(){var e=this.options.icon.options.iconAnchor;return e?e[0]+"px "+e[1]+"px":"50% 50%"},_setPos:function(e){if(L.Marker.prototype._setPos.call(this,e),L.DomUtil.TRANSFORM)this._icon.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(L.Browser.ie){var t=this.options.angle*(Math.PI/180),r=Math.cos(t),i=Math.sin(t);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+r+", M12="+-i+", M21="+i+", M22="+r+")"}},setAngle:function(e){this.options.angle=e}}),L.rotatedMarker=function(e,t){return new L.RotatedMarker(e,t)}},function(e,t){"use strict";L.gmx.ExternalLayer=L.Class.extend({createExternalLayer:function(){return null},isExternalVisible:function(){return!0},updateData:function(){},setDateInterval:function(){if(this._observer){var e=this.parentLayer._gmx;this._observer.setDateInterval(e.beginDate,e.endDate)}},options:{useDataManager:!0,observerOptions:{filters:["clipFilter","userFilter","clipPointsFilter"]}},initialize:function(e,t){L.setOptions(this,e),this.parentLayer=t,t.on("add",this._addEvent,this).on("dateIntervalChanged",this.setDateInterval,this),this.options.useDataManager&&this._addObserver(this.options.observerOptions),this.externalLayer=this.createExternalLayer(),t._map&&(this._addEvent({target:{_map:t._map}}),this._updateBbox())},_addObserver:function(e){this._items={},this._observer=this.parentLayer.addObserver(L.extend({bbox:gmxAPIutils.bounds([[Number.MAX_VALUE,Number.MAX_VALUE]]),callback:L.bind(this.updateData,this)},e)).deactivate()},unbindLayer:function(){this.parentLayer.off("add",this._addEvent,this).off("dateIntervalChanged",this.setDateInterval,this),this._observer&&delete this.parentLayer.repaintObservers[this._observer.id];var e=this._map||this.parentLayer._map;this._onRemove(!e),this._removeMapHandlers()},_addMapHandlers:function(e){this._map=e,this._map.on({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this)},_removeMapHandlers:function(){this._map&&this._map.off({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this),this._map=null},_addEvent:function(e){this._addMapHandlers(e.target._map),this._updateBbox(),this._chkZoom()},_isParentLayer:function(e){var t=e.layer;return t._gmx&&t._gmx.layerID===this.parentLayer.options.layerID},_layeradd:function(e){this._isParentLayer(e)&&this._chkZoom()},_layerremove:function(e){this._isParentLayer(e)&&(this._onRemove(!0),this._removeMapHandlers())},_onRemove:function(e){this._observer&&this._observer.deactivate();var t=this._map;t&&(t.hasLayer(this.externalLayer)&&(this._chkZoom(),t.removeLayer(this.externalLayer)),e||this.parentLayer.onAdd(t))},_chkZoom:function(){if(this._map){var e=this.parentLayer,t=this._observer,r=this._map,i=r.hasLayer(this.externalLayer);e.setCurrentZoom(r),this.isExternalVisible(r.getZoom())?e._map&&(e.onRemove(r),i||r.addLayer(this.externalLayer),this.setDateInterval(),t&&e.getIcons(function(){t.activate()}.bind(this)),e.disablePopup()):(t&&t.deactivate(),e._map||(i&&r.removeLayer(this.externalLayer),e.onAdd(r)),e.enablePopup())}},_updateBbox:function(){if(this._map&&this._observer){var e=this._map.getBounds(),t=e.getNorthWest(),r=e.getSouthEast(),i=L.gmxUtil.bounds([[t.lng,t.lat],[r.lng,r.lat]]);this._observer.setBounds(i)}}})},function(e,t){"use strict";!function(){var e=L.gmx.ExternalLayer.extend({options:{minZoom:1,maxZoom:6,useDataManager:!1,format:"png",transparent:!0},createExternalLayer:function(){var e=this.parentLayer.options,t={map:e.mapID,layers:e.layerID,format:this.options.format,transparent:this.options.transparent},r=this.parentLayer.getGmxProperties();return r&&r.Temporal&&this._extendOptionsByDateInterval(t),this.options.apikey&&(t.apikey=this.options.apikey),L.tileLayer.wms("http://"+e.hostName+"/TileService.ashx",t)},_extendOptionsByDateInterval:function(e){var t=this.parentLayer.getDateInterval(),r=t.beginDate,i=t.endDate;L.extend(e,{StartDate:r&&r.toLocaleDateString(),EndDate:i&&i.toLocaleDateString()})},setDateInterval:function(){this._extendOptionsByDateInterval(this.externalLayer.wmsParams),this.externalLayer.redraw()},isExternalVisible:function(e){return!(e<this.options.minZoom||e>this.options.maxZoom)}});L.gmx.VectorLayer.include({bindWMS:function(t){return this._layerWMS&&this._layerWMS.unbindLayer(),this._layerWMS=new e(t,this),this.isExternalVisible=this._layerWMS.isExternalVisible,this},unbindWMS:function(){return this._layerWMS&&(this._layerWMS.unbindLayer(),this._layerWMS=null,this.isExternalVisible=null,this.enablePopup()),this}})}()},function(e,t){"use strict";!function(){var e=L.gmx.ExternalLayer.extend({options:{minHeatMapZoom:1,maxHeatMapZoom:6,intensityField:"",intensityScale:1,observerOptions:{type:"resend"}},createExternalLayer:function(){return L.heatLayer([],L.extend({},this.options))},isExternalVisible:function(e){return!(e<this.options.minHeatMapZoom||e>this.options.maxHeatMapZoom)},updateData:function(e){if(e.added){var t=[],r=this.parentLayer.getTileAttributeIndexes(),i=null,n=this.options.intensityField||"",o=this.options.intensityScale||1;n&&n in r&&(i=r[n]);for(var a=0,s=e.added.length;a<s;a++){var l=e.added[a].properties,u=null!==i?l[i]:1,h=l[l.length-1],c=h.coordinates,d=L.Projection.Mercator.unproject({x:c[0],y:c[1]});t.push([d.lat,d.lng,"function"==typeof o?o(u):o*u])}this.externalLayer.setLatLngs(t)}}});L.gmx.VectorLayer.include({bindHeatMap:function(t){return L.heatLayer&&(this._heatmap&&this._heatmap.unbindLayer(),this._heatmap=new e(t,this)),this},unbindHeatMap:function(){return L.heatLayer&&this._heatmap&&(this._heatmap.unbindLayer(),this._heatmap=null,this.enablePopup()),this}})}()},function(e,t){"use strict";!function(){var e={radiusFunc:function(e){var t=Math.floor(e/15);return t>40?t=40:t<20&&(t=20),t},text:{stroke:"black","stroke-width":1,"text-anchor":"middle",fill:"white"}},t=L.gmx.ExternalLayer.extend({options:{observerOptions:{filters:["clipFilter","styleFilter","userFilter","clipPointsFilter"]},spiderfyOnMaxZoom:!0,minZoom:1,maxZoom:6},createExternalLayer:function(){var t=L.extend({showCoverageOnHover:!1,disableClusteringAtZoom:1+Number(this.options.maxZoom)},this.options);if("clusterIconOptions"in this.options){var r=this.options.clusterIconOptions;if("radialGradient"in r){var i=r.radialGradient,n=r.text||e.text;t.iconCreateFunction=function(t){var r=t.getChildCount();return n.count=r,L.gmxUtil.getSVGIcon({type:"circle",iconSize:2*(i.radiusFunc||e.radiusFunc)(r),text:n,fillRadialGradient:i})}}}this.options.clusterclick&&(t.clusterclick=this.options.clusterclick,t.clusterclick===!0&&(t.zoomToBoundsOnClick=!1)),this._popup=new L.Popup({maxWidth:1e4,className:"gmxPopup"});var o=new L.MarkerClusterGroup(t),a=null;return o.on("click",function(e){var t=e.layer.options.properties,r=this.parentLayer.getItemProperties(t),i=[t[t.length-1]],n=t[0];!a||a.getAllChildMarkers().indexOf(e.layer)+1?this._openPopup(t,e.latlng):(a.unspiderfy(),o.once("unspiderfied",function(){this._openPopup(t,e.latlng)},this)),this.parentLayer.fire("click",L.extend(e,{eventFrom:"markerClusters",originalEventType:"click",gmx:{id:n,layer:this.parentLayer,properties:r,target:{id:n,properties:t,geometry:i}}}))},this).on("animationend",function(){this._popup&&this._popup._map&&this._popup._map.removeLayer(this._popup)},this).on("clusterclick",function(e){this.parentLayer.fire("clusterclick",L.extend(e,{eventFrom:"markerClusters",originalEventType:"clusterclick"}))},this).on("spiderfied",function(e){a=e.cluster},this).on("unspiderfied",function(){a=null},this),t.clusterclick&&o.on("clusterclick",t.clusterclick instanceof Function?t.clusterclick:function(e){e.layer.spiderfy()}),o},isExternalVisible:function(e){return!(e<this.options.minZoom||e>this.options.maxZoom)},updateData:function(e){var t,r,i,n,o,a=[];if(e.removed){for(t=0,r=e.removed.length;t<r;t++)i=e.removed[t],n=i.id,o=this._items[n],o&&a.push(o),delete this._items[n];this.externalLayer.removeLayers(a),a=[]}if(e.added){for(t=0,r=e.added.length;t<r;t++){i=e.added[t],n=i.id,o=this._items[n];var s=i.properties;if(o&&s.processing&&(this.externalLayer.removeLayer(o),o=null),!o){i.item.parsedStyleKeys||(i.item.parsedStyleKeys=this.parentLayer.getItemStyle(n));var l=s[s.length-1],u=i.item.parsedStyleKeys,h=l.coordinates,c=L.Projection.Mercator.unproject({x:h[0],y:h[1]}),d={properties:i.properties,mPoint:h};if(this.options.notClusteredIcon){var m=this.options.notClusteredIcon;m instanceof L.Icon?d.icon=m:d.icon=L.icon(m)}else if(u)if(u.iconUrl){var f=u.iconAnchor;if(!f){var g=this.parentLayer.getItemStyle(n);f=g.image?[g.sx/2,g.sy/2]:[8,10]}d.icon=L.icon({iconAnchor:f,iconUrl:u.iconUrl})}else d.icon=L.gmxUtil.getSVGIcon(u);o=u.rotate?L.rotatedMarker(c,L.extend(d,{angle:u.rotate})):L.marker(c,L.extend(d,{angle:u.rotate})),this._items[n]=o}a.push(o)}this.externalLayer.addLayers(a)}},_openPopup:function(e,t){var r=this.parentLayer._gmx,i=e[0],n=r.styleManager.getItemBalloon(i),o=this.parentLayer.getItemProperties(e),a=[e[e.length-1]];if(n&&!n.DisableBalloonOnClick){var s=this.parentLayer.getItemStyle(i);if(s&&s.iconAnchor){var l=L.Popup.prototype.options.offset;this._popup.options.offset=[-l[0]-s.iconAnchor[0]+s.sx/2,l[1]-s.iconAnchor[1]+s.sy/2]}this._popup.setLatLng(t).setContent(L.gmxUtil.parseBalloonTemplate(n.templateBalloon,{properties:o,tileAttributeTypes:r.tileAttributeTypes,unitOptions:this._map.options||{},geometries:a})).openOn(this._map)}}});L.gmx.VectorLayer.include({bindClusters:function(e){return L.MarkerClusterGroup&&(this._clusters&&this._clusters.unbindLayer(),this._clusters=new t(e,this)),this},unbindClusters:function(){return L.MarkerClusterGroup&&this._clusters&&(this._clusters.unbindLayer(),this._clusters=null,this.enablePopup()),this}})}()},function(e,t,r){"use strict";var i=r(4);L.gmx=L.gmx||{};var n="maps.kosmosnimki.ru",o=2e6;L.gmx._layerClasses={Raster:L.gmx.RasterLayer,Vector:L.gmx.VectorLayer,VectorView:L.gmx.DummyLayer},L.gmx._loadingLayerClasses={},L.gmx.addLayerClass=function(e,t){L.gmx._layerClasses[e]=t},L.gmx._layerClassLoaders=[],L.gmx.addLayerClassLoader=function(e){L.gmx._layerClassLoaders.push(e),L.gmx._loadingLayerClasses={}},L.gmx._loadLayerClass=function(e){if(!L.gmx._loadingLayerClasses[e]){var t=new L.gmx.Deferred;t.resolve(),L.gmx._layerClassLoaders.forEach(function(r){t=t.then(function(t){return t?(L.gmx._layerClasses[e]=t,t):r(e)},function(){})}),t=t.then(function(t){if(t)return L.gmx._layerClasses[e]=t,t},function(){}),L.gmx._loadingLayerClasses[e]=t}return L.gmx._loadingLayerClasses[e]},L.gmx.loadLayer=function(e,t,r){var o=new L.gmx.Deferred,a={mapID:e,layerID:t};r=r||{};for(var s in r)a[s]=r[s];var l=i.gmxAPIutils.normalizeHostname(r.hostName||n);return a.hostName=l,L.gmx.gmxMapManager.getMap(l,r.apiKey,e,r.skipTiles).then(function(){var r=L.gmx.gmxMapManager.findLayerInfo(l,e,t);if(!r)return void o.reject("There is no layer "+t+" in map "+e);r.properties.hostName=l;var i=r.properties.ContentID||r.properties.type,n=function(){var e=L.gmx.createLayer(r,a);e?o.resolve(e):o.reject("Unknown type of layer "+t)};i in L.gmx._layerClasses?n():L.gmx._loadLayerClass(i).then(n)},function(r){o.reject("Can't load layer "+t+" from map "+e+": "+r.error)}),o},L.gmx.loadLayers=function(e,t){var r=e.map(function(e){var r=L.extend({},t,e.options);return L.gmx.loadLayer(e.mapID,e.layerID,r)});return L.gmx.Deferred.all.apply(null,r)},L.gmx.loadMap=function(e,t){t=L.extend({},t),t.hostName=i.gmxAPIutils.normalizeHostname(t.hostName||n);var r=new L.gmx.Deferred;return L.gmx.gmxMapManager.getMap(t.hostName,t.apiKey,e,t.skipTiles,t.isGeneralized).then(function(e){var i=new L.gmx.gmxMap(e,t);i.layersCreated.then(function(){if(t.leafletMap||t.setZIndex)for(var n,a,s=0,l=i.layers.length-1;l>=0;l--)n=i.layers[l],
a=n.getGmxProperties(),"VectorOnTop"===e.properties.LayerOrder&&n.setZIndexOffset&&"Raster"!==a.type&&n.setZIndexOffset(o),t.setZIndex&&n.setZIndex&&n.setZIndex(++s),t.leafletMap&&a.visible&&n.addTo(t.leafletMap);r.resolve(i)})},function(i){var n=i&&i.ErrorInfo&&i.ErrorInfo.ErrorMessage||"Server error";r.reject("Can't load map "+e+" from "+t.hostName+": "+n)}),r},L.gmx.DummyLayer=function(e){this.onAdd=this.onRemove=function(){},this.getGmxProperties=function(){return e}},L.gmx.createLayer=function(e,t){e||(e={}),e.properties||(e.properties={type:"Vector"});var r,i=e.properties.ContentID||e.properties.type||"Vector";if(i in L.gmx._layerClasses)try{r=new L.gmx._layerClasses[i](t),r=r.initFromDescription(e)}catch(t){r=new L.gmx.DummyLayer(e.properties)}else r=new L.gmx.DummyLayer(e.properties);return r}},function(e,t){"use strict";!function(){var e=function(e,t){return e.replace(/\{ *([\w_]+) *\}/g,function(e,r){var i=t[r];return void 0===i?i="":"function"==typeof i&&(i=i(t)),i})},t=function(){};t.prototype.initFromDescription=function(e){var t=e.properties,r=t.MetaProperties,i=r["url-template"]&&r["url-template"].Value,n=!!r["merc-projection"],o={};if(!i)return new L.gmx.DummyLayer(t);t.Copyright&&(o.attribution=t.Copyright),r.minZoom&&(o.minZoom=r.minZoom.Value),r.maxZoom&&(o.maxZoom=r.maxZoom.Value);var a=(n?L.tileLayer.Mercator:L.tileLayer)(i,o);return a.getGmxProperties=function(){return t},a},L.gmx.addLayerClass("TMS",t),L.gmx.addLayerClass("TiledRaster",t);var r=function(){};r.prototype.initFromDescription=function(t){var r=["layers","styles","format","transparent","version","minZoom","maxZoom","tileSize","f","bboxSR","imageSR","size"],i={tileSize:parseInt},n=t.properties,o=n.MetaProperties,a=o["base-url"]&&o["base-url"].Value,s={};if(!a)return new L.gmx.DummyLayer(n);n.Copyright&&(s.attribution=n.Copyright);for(var l in o)r.indexOf(l)!==-1&&(s[l]=i[l]?i[l](o[l].Value):o[l].Value);var u=L.tileLayer.wms(a,s);u.getGmxProperties=function(){return n};var h=o.balloonTemplate&&o.balloonTemplate.Value;if(o.clickable&&h){u.options.clickable=!0,u.onRemove=function(e){c&&e.removeLayer(c),L.TileLayer.WMS.prototype.onRemove.apply(this,arguments)};var c;u.gmxEventCheck=function(t){if("click"===t.type){var r=this._map.project(t.latlng),i=u.options.tileSize,n=r.x%i,o=r.y%i,a=r.divideBy(i).floor(),l=this.getTileUrl(a);l=l.replace("=GetMap","=GetFeatureInfo"),l+="&X="+n+"&Y="+o+"&INFO_FORMAT=application/geojson&QUERY_LAYERS="+s.layers,fetch(l).then(function(r){if(r.features[0]){var i=e(h,r.features[0].properties);c=L.popup().setLatLng(t.latlng).setContent(i).openOn(this._map)}}.bind(this))}return 1}}return u},L.gmx.addLayerClass("WMS",r)}()}]);
//# sourceMappingURL=geomixer.js.map